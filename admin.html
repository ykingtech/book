<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Auto Automation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&family=Merriweather:wght@300;700&family=Cinzel:wght@400;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .editor-font { font-family: 'Merriweather', serif; }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 3px; }
        
        #editor-canvas {
            width: 360px; height: 540px; 
            background-color: #f4e4bc;
            position: relative; overflow: hidden;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin: 0 auto; border: 1px solid #ccc;
        }
        .draggable-item { position: absolute; cursor: move; border: 1px dashed transparent; padding: 2px; }
        .draggable-item:hover { border: 1px dashed #64748b; }
        .draggable-item.selected { border: 2px solid #4f46e5; z-index: 50; }
        .editable-text { outline: none; }
    </style>
</head>
<body class="flex h-screen overflow-hidden text-slate-800">

    <aside class="w-64 bg-slate-900 text-white flex flex-col shadow-xl z-20">
        <div class="p-6 border-b border-slate-700">
            <h1 class="text-xl font-bold tracking-wider text-yellow-500 font-[Cinzel]">MYSTERIUM</h1>
            <p class="text-xs text-slate-400 mt-1">Admin Panel</p>
        </div>
        <nav class="flex-grow p-4 space-y-2">
            <button onclick="switchTab('editor')" id="tab-editor" class="w-full flex items-center p-3 rounded-lg bg-indigo-600 text-white shadow-md text-left">
                <i class="fas fa-pen-nib w-6 w-6 mr-2"></i> Book Editor
            </button>
            <button onclick="switchTab('pdf')" id="tab-pdf" class="w-full flex items-center p-3 rounded-lg hover:bg-slate-800 transition text-left text-slate-300">
                <i class="fas fa-file-pdf w-6 mr-2"></i> PDF Import
            </button>
            <button onclick="switchTab('requests')" id="tab-requests" class="w-full flex items-center p-3 rounded-lg hover:bg-slate-800 transition text-left text-slate-300">
                <i class="fas fa-robot w-6 mr-2"></i> Auto Requests <span id="req-badge" class="ml-auto bg-red-500 text-[10px] px-2 rounded-full hidden">0</span>
            </button>
        </nav>
    </aside>

    <main class="flex-grow flex flex-col overflow-hidden relative">
        <header class="bg-white h-16 border-b border-slate-200 flex items-center justify-between px-8 shadow-sm z-10">
            <h2 id="page-title" class="text-lg font-bold text-slate-700">Book Editor</h2>
            <div class="h-8 w-8 bg-indigo-100 rounded-full flex items-center justify-center text-indigo-600 font-bold">A</div>
        </header>

        <div id="view-editor" class="flex-grow flex overflow-hidden">
            <div class="w-80 bg-white border-r border-slate-200 p-6 overflow-y-auto z-10">
                <div class="mb-6 p-4 bg-slate-50 rounded-lg border">
                    <label class="block text-xs font-bold text-slate-500 uppercase mb-2">Page Nav</label>
                    <div class="flex gap-2 mb-2">
                        <button onclick="setPage(0)" class="flex-1 py-1 text-xs font-bold bg-amber-100 text-amber-800 rounded">Cover</button>
                        <button onclick="setPage(1000)" class="flex-1 py-1 text-xs font-bold bg-slate-200 text-slate-700 rounded">Back</button>
                    </div>
                    <div class="flex gap-2">
                        <input type="number" id="page-num-input" value="1" class="w-16 border rounded text-center text-sm font-bold">
                        <button id="load-page-btn" class="flex-grow bg-indigo-600 hover:bg-indigo-700 text-white text-xs font-bold rounded">LOAD</button>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-3 mb-6">
                    <button id="add-text-btn" class="p-4 border rounded-lg hover:bg-slate-50 flex flex-col items-center gap-2">
                        <i class="fas fa-font text-xl text-slate-400"></i><span class="text-xs font-bold text-slate-600">Text</span>
                    </button>
                    <label class="p-4 border rounded-lg hover:bg-slate-50 flex flex-col items-center gap-2 cursor-pointer">
                        <i class="fas fa-image text-xl text-slate-400"></i><span class="text-xs font-bold text-slate-600">Image</span>
                        <input type="file" id="image-uploader" class="hidden" accept="image/*">
                    </label>
                </div>

                <div id="style-panel" class="mb-6 opacity-50 pointer-events-none transition-all duration-300">
                    <div class="flex justify-between items-center mb-2"><label class="text-xs font-bold text-slate-500 uppercase">Properties</label><button id="delete-el-btn" class="text-xs text-red-500 font-bold">DEL</button></div>
                    <div class="p-4 bg-slate-50 rounded-lg border space-y-3">
                        <div id="text-tools" class="hidden space-y-3">
                            <select id="font-family-select" class="w-full text-xs border rounded p-1"><option value="'Merriweather', serif">Merriweather</option><option value="'Inter', sans-serif">Inter</option><option value="'Cinzel', serif">Cinzel</option></select>
                            <div class="flex gap-2">
                                <input type="color" id="text-color-input" class="h-8 w-8 rounded border">
                                <input type="number" id="font-size-input" class="w-full text-xs border rounded p-1" placeholder="Size">
                                <button id="bold-btn" class="w-8 bg-white border rounded font-bold text-xs">B</button>
                            </div>
                        </div>
                        <div id="image-tools" class="hidden"><label class="text-[10px]">Scale</label><input type="range" id="img-width-slider" min="10" max="100" class="w-full h-1 bg-slate-300 rounded-lg"></div>
                    </div>
                </div>
                
                <div class="mb-4"><label class="text-xs font-bold text-slate-500 uppercase block mb-1">Background</label><input type="color" id="bg-color-picker" value="#f4e4bc" class="w-full h-8 rounded border"></div>
                <button id="publish-btn" class="w-full py-3 bg-green-600 hover:bg-green-700 text-white font-bold rounded-lg shadow-sm">PUBLISH PAGE</button>
            </div>

            <div class="flex-grow bg-slate-100 flex items-center justify-center relative overflow-hidden">
                <div id="editor-canvas" class="editor-font"></div>
            </div>
        </div>

        <div id="view-pdf" class="hidden flex-grow p-10 flex flex-col items-center justify-center bg-slate-50">
            <div class="bg-white p-10 rounded-2xl shadow-xl max-w-2xl w-full text-center border border-slate-200">
                <i class="fas fa-file-pdf text-6xl text-red-500 mb-6"></i>
                <h2 class="text-2xl font-bold text-slate-800 mb-2">Import Book from PDF</h2>
                <p class="text-slate-500 mb-8 text-sm">Upload a PDF to automatically generate the book.</p>
                <label class="block w-full border-2 border-dashed border-slate-300 rounded-xl p-8 cursor-pointer hover:border-indigo-500 hover:bg-indigo-50 transition mb-6">
                    <span class="text-slate-600 font-medium">Click to Select PDF File</span>
                    <input type="file" id="pdf-upload-input" class="hidden" accept="application/pdf">
                </label>
                <div id="pdf-progress-container" class="hidden w-full bg-slate-200 rounded-full h-4 mb-4 overflow-hidden"><div id="pdf-progress-bar" class="bg-green-500 h-4 rounded-full transition-all duration-300" style="width: 0%"></div></div>
                <p id="pdf-status" class="text-xs text-slate-500 font-mono"></p>
            </div>
        </div>

        <div id="view-requests" class="hidden flex-grow flex flex-col p-6 overflow-hidden">
            <div class="flex space-x-4 mb-4 border-b pb-2">
                <button onclick="filterRequests('pending')" id="filter-pending" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded-lg font-bold text-sm">Pending / Processing</button>
                <button onclick="filterRequests('approved')" id="filter-approved" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold text-sm">Approved History</button>
                <button onclick="filterRequests('rejected')" id="filter-rejected" class="px-4 py-2 text-slate-500 hover:bg-slate-100 rounded-lg font-bold text-sm">Rejected History</button>
            </div>

            <div class="bg-white rounded-xl shadow-sm border border-slate-200 flex-grow overflow-y-auto">
                <table class="w-full text-left text-sm">
                    <thead class="bg-slate-50 text-slate-500 uppercase font-bold text-xs border-b sticky top-0">
                        <tr>
                            <th class="px-6 py-4">Email</th>
                            <th class="px-6 py-4">Receipt Info</th>
                            <th class="px-6 py-4">Auto Status</th>
                            <th class="px-6 py-4 text-right">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="requests-table-body" class="divide-y divide-slate-100"></tbody>
                </table>
                <div id="no-reqs-msg" class="p-8 text-center text-slate-400 hidden">No requests in this category.</div>
            </div>
            
            <div id="auto-log" class="mt-4 p-2 bg-black text-green-400 font-mono text-xs h-32 overflow-y-auto rounded shadow-inner">
                > System Ready. Waiting for requests...
            </div>
        </div>
    </main>

    <div id="processing-overlay" class="hidden fixed inset-0 bg-black/80 z-[100] flex flex-col items-center justify-center text-white">
        <i class="fas fa-circle-notch fa-spin text-4xl mb-4"></i>
        <p class="text-lg font-bold" id="processing-text">Processing...</p>
    </div>

    <div id="receipt-modal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-lg max-w-2xl w-full flex flex-col overflow-hidden shadow-2xl h-[80vh]">
            <div class="p-4 bg-slate-50 flex justify-between"><h3 class="font-bold">Receipt Review</h3><button onclick="closeModal()">&times;</button></div>
            <div class="p-4 bg-slate-200 flex-grow flex items-center justify-center overflow-auto relative">
                <img id="modal-img" src="" class="max-h-full object-contain">
            </div>
            <div class="p-4 bg-white flex justify-end gap-3">
                <button id="modal-reject-btn" class="px-4 py-2 bg-red-100 text-red-700 rounded font-bold">Reject</button>
                <button id="modal-approve-btn" class="px-4 py-2 bg-green-600 text-white rounded font-bold">Approve</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getFirestore, collection, doc, setDoc, getDocs, query, where, onSnapshot, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyByyYMFzn1nHOuzxEsX44sQrIIT5AdB3Pc",
            authDomain: "book-8cd24.firebaseapp.com",
            projectId: "book-8cd24",
            storageBucket: "book-8cd24.firebasestorage.app",
            messagingSenderId: "747560284834",
            appId: "1:747560284834:web:30f6080e8d4fbf9025ddfb",
            measurementId: "G-FFFS1HS4GY"
        };
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);

        // PDF JS
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // --- NAVIGATION ---
        window.switchTab = (tab) => {
            ['editor', 'requests', 'pdf'].forEach(t => {
                document.getElementById('view-' + t).classList.add('hidden');
                document.getElementById('tab-' + t).className = "w-full flex items-center p-3 rounded-lg hover:bg-slate-800 transition text-left text-slate-300";
            });
            document.getElementById('view-' + tab).classList.remove('hidden');
            if(tab === 'editor') document.getElementById('view-' + tab).classList.add('flex');
            else if(tab === 'requests') document.getElementById('view-' + tab).classList.add('flex');
            
            document.getElementById('tab-' + tab).className = "w-full flex items-center p-3 rounded-lg bg-indigo-600 text-white shadow-md text-left";
            document.getElementById('page-title').innerText = tab === 'pdf' ? 'PDF Import' : (tab === 'requests' ? 'Auto Requests' : 'Book Editor');
        };

        // --- AUTOMATION LOGIC ---
        let allRequests = [];
        let currentFilter = 'pending';

        // 1. CLEANUP FUNCTION (Delete rejected > 2 days)
        // පිටුව ලෝඩ් වන විට දවස් 2කට වඩා පැරණි rejected රිසිට් මැකී යයි
        async function cleanUpOldRejections() {
            logSystem("Checking for old rejected receipts...");
            const cutoffDate = new Date();
            cutoffDate.setDate(cutoffDate.getDate() - 2); // දවස් 2කට කලින්

            try {
                const q = query(collection(db, "requests"), where("status", "==", "rejected"));
                const snapshot = await getDocs(q);
                let deletedCount = 0;

                snapshot.forEach(async (d) => {
                    const data = d.data();
                    if (data.processedAt) {
                        const processedDate = new Date(data.processedAt);
                        if (processedDate < cutoffDate) {
                            await deleteDoc(doc(db, "requests", d.id));
                            deletedCount++;
                        }
                    }
                });
                
                if(deletedCount > 0) logSystem(`Cleaned up ${deletedCount} old rejected receipts.`);
            } catch (error) {
                console.error("Cleanup Error:", error);
            }
        }

        // Run cleanup on load
        cleanUpOldRejections();

        // Listen for requests real-time
        onSnapshot(collection(db, "requests"), async (snap) => {
            allRequests = [];
            snap.forEach(d => allRequests.push({id: d.id, ...d.data()}));
            
            // Check for new pending requests to auto-process
            const pending = allRequests.filter(r => r.status === 'pending' && !r.autoProcessed);
            if(pending.length > 0) {
                logSystem(`Found ${pending.length} new receipts. Starting analysis...`);
                for(const req of pending) {
                    await processReceipt(req);
                }
            }
            renderRequests();
            updateBadge();
        });

        function logSystem(msg) {
            const log = document.getElementById('auto-log');
            log.innerHTML += `<br>> ${msg}`;
            log.scrollTop = log.scrollHeight;
        }

        async function processReceipt(req) {
            logSystem(`Analyzing ID: ${req.email}...`);
            
            try {
                // 1. OCR Scanning
                const result = await Tesseract.recognize(req.receiptImage, 'eng');
                const text = result.data.text.toLowerCase().replace(/\s+/g, ' ').trim();
                logSystem(`Read Text: "${text.substring(0, 20)}..."`);

                let autoStatus = 'rejected';
                let reason = '';

                // --- CHECK 1: AMOUNT (200) ---
                const hasAmount = text.includes('200');
                if(!hasAmount) reason += 'Amount 200 not found. ';

                // --- CHECK 2: DATE (Advanced: Dots & Slashes) ---
                const today = new Date();
                const yesterday = new Date(today); yesterday.setDate(yesterday.getDate() - 1);
                
                const d1 = String(today.getDate()).padStart(2,'0');
                const m1 = String(today.getMonth()+1).padStart(2,'0');
                const y1 = today.getFullYear();
                
                const d2 = String(yesterday.getDate()).padStart(2,'0');
                const m2 = String(yesterday.getMonth()+1).padStart(2,'0');
                const y2 = yesterday.getFullYear();

                // 2025.12.24 හෝ 24.12.2025 වැනි ආකෘති ද භාරගනී
                const datePatterns = [
                    `${y1}.${m1}.${d1}`, `${d1}.${m1}.${y1}`, // Today dot
                    `${y1}-${m1}-${d1}`, `${d1}/${m1}/${y1}`, // Today other
                    `${y2}.${m2}.${d2}`, `${d2}.${m2}.${y2}`, // Yesterday dot
                    `${y2}-${m2}-${d2}`, `${d2}/${m2}/${y2}`, // Yesterday other
                    `${d1}/${m1}`, `${d1}.${m1}` // Simple Day/Month
                ];

                const dateFound = datePatterns.some(pattern => text.includes(pattern));
                
                if(!dateFound) reason += 'Date mismatch (Checked Today/Yesterday). ';

                // --- CHECK 3: DUPLICATE RECEIPT CHECK ---
                // දැනට approved වී ඇති රිසිට්පත් වල text සමග සසඳයි
                // This checks "allRequests" which we have from the onSnapshot listener
                // Only checks against requests that are APPROVED
                const cleanCurrentText = text.replace(/[^a-z0-9]/g, ""); 
                const isDuplicate = allRequests.some(r => 
                    r.status === 'approved' && 
                    r.ocrTextClean === cleanCurrentText
                );

                if(isDuplicate) reason += 'Duplicate Receipt (Already used). ';

                // --- CHECK 4: USER STATUS ---
                const userSnap = await getDoc(doc(db, 'users', req.userId));
                const alreadyActive = userSnap.exists() && userSnap.data().status === 'approved';
                if(alreadyActive) reason += 'User already approved. ';

                // --- FINAL DECISION ---
                if (hasAmount && dateFound && !alreadyActive && !isDuplicate) {
                    autoStatus = 'approved';
                    reason = 'Auto-Verified: 200LKR + Date OK';
                } else {
                    if(!reason) reason = "Auto-rejected: Validation failed.";
                }

                logSystem(`Result: ${autoStatus.toUpperCase()} (${reason})`);

                // UPDATE DB
                await updateDoc(doc(db, "requests", req.id), {
                    status: autoStatus,
                    autoProcessed: true,
                    autoReason: reason,
                    ocrTextClean: cleanCurrentText, // Save clean text to prevent future duplicates
                    processedAt: new Date().toISOString()
                });
                
                // If Approved, update User status too
                if(autoStatus === 'approved') {
                    await updateDoc(doc(db, "users", req.userId), { status: "approved" });
                }

            } catch (err) {
                logSystem(`Error OCR: ${err.message}`);
            }
        }

        window.filterRequests = (type) => {
            currentFilter = type;
            document.querySelectorAll('[id^="filter-"]').forEach(b => b.classList.replace('bg-indigo-100','text-slate-500'));
            document.querySelectorAll('[id^="filter-"]').forEach(b => b.classList.replace('text-indigo-700','hover:bg-slate-100'));
            
            const active = document.getElementById('filter-'+type);
            active.classList.remove('text-slate-500','hover:bg-slate-100');
            active.classList.add('bg-indigo-100','text-indigo-700');
            renderRequests();
        };

        function renderRequests() {
            const tbody = document.getElementById('requests-table-body');
            tbody.innerHTML = '';
            
            const filtered = allRequests.filter(r => {
                if(currentFilter === 'pending') return r.status === 'pending';
                if(currentFilter === 'approved') return r.status === 'approved';
                if(currentFilter === 'rejected') return r.status === 'rejected';
            });

            if(filtered.length === 0) {
                document.getElementById('no-reqs-msg').classList.remove('hidden');
                return;
            }
            document.getElementById('no-reqs-msg').classList.add('hidden');

            filtered.forEach(req => {
                const reason = req.autoReason || "Pending Manual Review";
                const isAuto = req.autoProcessed ? '<span class="text-xs bg-purple-100 text-purple-700 px-1 rounded">BOT</span>' : '';
                
                let btns = '';
                if(currentFilter === 'approved') {
                    btns = `<button onclick="manualAction('${req.userId}', 'reject')" class="bg-red-100 text-red-600 px-3 py-1 rounded text-xs font-bold">Revoke (Reject)</button>`;
                } else if (currentFilter === 'rejected') {
                    btns = `<button onclick="manualAction('${req.userId}', 'approve')" class="bg-green-100 text-green-600 px-3 py-1 rounded text-xs font-bold">Force Approve</button>`;
                } else {
                    // Pending
                    btns = `<button onclick="manualAction('${req.userId}', 'approve')" class="text-green-500 mr-2"><i class="fas fa-check"></i></button>
                            <button onclick="manualAction('${req.userId}', 'reject')" class="text-red-500"><i class="fas fa-times"></i></button>`;
                }

                tbody.innerHTML += `
                    <tr class="border-b hover:bg-slate-50 transition">
                        <td class="px-6 py-4">
                            <div class="font-bold text-slate-700">${req.email}</div>
                            <div class="text-[10px] text-slate-400">UID: ${req.userId.substring(0,6)}...</div>
                        </td>
                        <td class="px-6 py-4">
                            <button onclick="viewReceipt('${req.receiptImage}', '${req.userId}')" class="text-indigo-500 text-xs font-bold border border-indigo-200 px-2 py-1 rounded hover:bg-indigo-50">View Image</button>
                        </td>
                        <td class="px-6 py-4">
                            <div class="text-xs text-slate-500">${isAuto} ${reason}</div>
                        </td>
                        <td class="px-6 py-4 text-right">
                            ${btns}
                        </td>
                    </tr>`;
            });
        }

        function updateBadge() {
            const count = allRequests.filter(r => r.status === 'pending').length;
            const b = document.getElementById('req-badge');
            b.innerText = count;
            b.classList.toggle('hidden', count === 0);
        }

        // --- MANUAL ACTIONS (Override) ---
        window.manualAction = async (uid, action) => {
            const req = allRequests.find(r => r.userId === uid);
            if(!req) return;

            if(!confirm(`Are you sure you want to manually ${action} this user?`)) return;

            document.getElementById('processing-overlay').classList.remove('hidden');
            try {
                // Update User Status
                if(action === 'approve') {
                    await updateDoc(doc(db, "users", uid), { status: "approved" });
                } else {
                    await updateDoc(doc(db, "users", uid), { status: "rejected" }); 
                }

                // Update Request Status
                await updateDoc(doc(db, "requests", req.id), {
                    status: action === 'approve' ? 'approved' : 'rejected',
                    autoReason: 'Manually Updated by Admin',
                    autoProcessed: true,
                    processedAt: new Date().toISOString()
                });

                alert("Updated Successfully!");
            } catch (e) {
                alert("Error: " + e.message);
            } finally {
                document.getElementById('processing-overlay').classList.add('hidden');
                closeModal();
            }
        };

        // Modal Helpers
        window.viewReceipt = (img, uid) => { 
            document.getElementById('receipt-modal').classList.remove('hidden'); 
            document.getElementById('modal-img').src = img; 
            document.getElementById('modal-approve-btn').onclick = () => manualAction(uid, 'approve'); 
            document.getElementById('modal-reject-btn').onclick = () => manualAction(uid, 'reject'); 
        };
        window.closeModal = () => document.getElementById('receipt-modal').classList.add('hidden');

        // --- OLD PDF & EDITOR CODE (Keep Intact) ---
        document.getElementById('pdf-upload-input').addEventListener('change', async (e) => {
            const file = e.target.files[0]; if (!file) return;
            const statusText = document.getElementById('pdf-status');
            document.getElementById('pdf-progress-container').classList.remove('hidden');
            statusText.innerText = "Processing...";
            try {
                const ab = await file.arrayBuffer(); const pdf = await pdfjsLib.getDocument(ab).promise;
                for (let i = 1; i <= pdf.numPages; i++) {
                    const page = await pdf.getPage(i); const vp = page.getViewport({ scale: 1.5 });
                    const c = document.createElement('canvas'); c.width=vp.width; c.height=vp.height;
                    await page.render({ canvasContext: c.getContext('2d'), viewport: vp }).promise;
                    const dbPageNum = (i===1)?0:(i===pdf.numPages?1000:i-1);
                    await setDoc(doc(db,'pages','page_'+dbPageNum), {pageNumber:dbPageNum, backgroundColor:'#fff', elements:[{type:'image',content:c.toDataURL('image/jpeg',0.8),style:{width:'100%',height:'100%'},left:'0',top:'0'}]});
                }
                alert("PDF Imported!"); window.switchTab('editor');
            } catch(er){ console.error(er); alert("Error"); }
        });
        
        // Editor logic initialization
        let selectedEl=null; const canvas=document.getElementById('editor-canvas'); const stylePanel=document.getElementById('style-panel');
        window.setPage=(n)=>{ document.getElementById('page-num-input').value=n; document.getElementById('load-page-btn').click(); };
        document.getElementById('load-page-btn').addEventListener('click', async () => {
            const pg=parseInt(document.getElementById('page-num-input').value);
            const snap=await getDocs(query(collection(db,'pages'),where('pageNumber','==',pg)));
            canvas.innerHTML='';
            if(!snap.empty){
                const d=snap.docs[0].data(); canvas.style.backgroundColor=d.backgroundColor||'#f4e4bc';
                d.elements.forEach(el=>addItem(el.type,el.content,el.style,el.left,el.top));
            } else canvas.style.backgroundColor='#f4e4bc';
        });
        const addItem = (type, content, style={}, left='50px', top='50px') => {
            const div=document.createElement('div'); div.className='draggable-item'; div.dataset.type=type; div.style.left=left; div.style.top=top;
            if(type==='text') div.innerHTML=`<div contenteditable="true" class="editable-text" style="color:${style.color||'#000'}; font-size:${style.fontSize||'24px'}; font-family:${style.fontFamily||'Merriweather'}; font-weight:${style.fontWeight||'normal'}">${content}</div>`;
            else div.innerHTML=`<img src="${content}" style="width:${style.width||'100%'}; pointer-events:none;">`;
            canvas.appendChild(div); selectItem(div);
        };
        document.getElementById('add-text-btn').addEventListener('click', ()=>addItem('text','Text'));
        document.getElementById('publish-btn').addEventListener('click', async () => {
             const pg=parseInt(document.getElementById('page-num-input').value); const els=[];
             canvas.querySelectorAll('.draggable-item').forEach(el=>{
                 const obj={left:el.style.left,top:el.style.top,type:el.dataset.type};
                 if(el.dataset.type==='text'){ const t=el.querySelector('.editable-text'); obj.content=t.innerText; obj.style={color:t.style.color,fontSize:t.style.fontSize,fontFamily:t.style.fontFamily}; }
                 else { obj.content=el.querySelector('img').src; obj.style={width:el.querySelector('img').style.width}; }
                 els.push(obj);
             });
             await setDoc(doc(db,'pages','page_'+pg),{pageNumber:pg,backgroundColor:canvas.style.backgroundColor,elements:els}); alert("Published!");
        });
        
        let activeDrag=null, offX, offY;
        canvas.addEventListener('mousedown', e => { if(!e.target.isContentEditable && e.target.closest('.draggable-item')){ e.preventDefault(); activeDrag=e.target.closest('.draggable-item'); selectItem(activeDrag); const r=activeDrag.getBoundingClientRect(); offX=e.clientX-r.left; offY=e.clientY-r.top; document.addEventListener('mousemove', drag); document.addEventListener('mouseup', stopDrag); } else if(e.target===canvas) selectItem(null); });
        function drag(e) { if(activeDrag){ const cr=canvas.getBoundingClientRect(); activeDrag.style.left=(e.clientX-cr.left-offX)+'px'; activeDrag.style.top=(e.clientY-cr.top-offY)+'px'; } }
        function stopDrag() { activeDrag=null; document.removeEventListener('mousemove', drag); document.removeEventListener('mouseup', stopDrag); }
        function selectItem(el){ selectedEl=el; if(el){ el.classList.add('selected'); stylePanel.classList.remove('opacity-50','pointer-events-none'); } else { stylePanel.classList.add('opacity-50','pointer-events-none'); Array.from(canvas.children).forEach(c=>c.classList.remove('selected')); } }

    </script>
</body>
</html>
