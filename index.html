<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Archive - Reader</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Inter:wght@300;400;600&family=Merriweather:wght@300;400;700&display=swap" rel="stylesheet">
    
    <style>
        /* --- VARIABLES & BASE --- */
        :root { --bg-body: #0b0c10; --gold: #d4af37; }
        body {
            background-color: var(--bg-body); color: #e0e0e0;
            font-family: 'Inter', sans-serif; height: 100vh; overflow: hidden;
            transition: background 0.5s ease-in-out; touch-action: none;
            background-size: cover; background-position: center;
        }

        /* --- THEMES (MOODS) --- */
        body.bg-rain { background-image: url('https://images.unsplash.com/photo-1515694346937-94d85e41e6f0?q=80&w=1000&auto=format&fit=crop'); }
        body.bg-library { background-image: url('https://images.unsplash.com/photo-1507842217343-583bb7270b66?q=80&w=1000&auto=format&fit=crop'); }
        body.bg-forest { background-image: url('https://images.unsplash.com/photo-1448375240586-dfd8f3793300?q=80&w=1000&auto=format&fit=crop'); }
        body.bg-mystic { background-image: radial-gradient(circle at 50% 50%, #1f2833 0%, #0b0c10 100%); }
        body.bg-midnight { background-image: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }
        
        /* Overlay to darken images for readability */
        body::before { content: ''; position: absolute; inset: 0; background: rgba(0,0,0,0.6); pointer-events: none; z-index: -1; }

        /* --- BOOK STYLES --- */
        .book-scene { perspective: 1500px; width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; padding-bottom: 60px; }
        .book { transform-style: preserve-3d; position: relative; transition: transform 0.5s; aspect-ratio: 2 / 3; width: auto; height: 75vh; max-width: 95vw; }
        .page { position: absolute; top:0; left:0; width: 100%; height: 100%; transform-origin: left; transition: transform 1.2s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; border-radius: 2px 8px 8px 2px; cursor: pointer; background-color: white; box-shadow: inset 5px 0 10px rgba(0,0,0,0.1); }
        .front, .back { position: absolute; width: 100%; height: 100%; backface-visibility: hidden; overflow: hidden; background-color: white; }
        .back { transform: rotateY(180deg); background-color: #f0f0f0; }
        .flipped { transform: rotateY(-180deg); }
        
        /* Dark Mode Pages */
        body.dark-mode .front, body.dark-mode .back { background-color: #1a1a1a !important; color: #ccc; }
        
        .content-layer { position: absolute; top: 50%; left: 50%; width: 360px; height: 540px; transform: translate(-50%, -50%); pointer-events: none; background: white; }
        body.dark-mode .content-layer { background: #1a1a1a; }
        .content-layer * { pointer-events: auto; }

        /* --- WIZARD CHARACTER (IMPROVED) --- */
        #wizard-container {
            position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) scale(0);
            z-index: 200; pointer-events: none; display: flex; flex-col; align-items: center;
            transition: all 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55); opacity: 0;
        }
        #wizard-container.active { transform: translate(-50%, -50%) scale(1); opacity: 1; }
        
        .wizard-avatar-box {
            width: 80px; height: 80px; background: #1a1a1a; border: 3px solid #d4af37;
            border-radius: 50%; display: flex; align-items: center; justify-content: center;
            box-shadow: 0 0 25px rgba(212, 175, 55, 0.6); overflow: hidden; position: relative;
        }
        .wizard-face { font-size: 45px; color: #d4af37; }
        
        .wizard-bubble {
            background: rgba(255, 255, 255, 0.95); color: #000; padding: 12px 20px; 
            border-radius: 20px; font-family: 'Inter', sans-serif; font-weight: 700; font-size: 0.9rem;
            box-shadow: 0 10px 20px rgba(0,0,0,0.4); margin-top: 15px; text-align: center; min-width: 200px;
            border: 2px solid #d4af37; transform: translateY(10px);
        }

        /* --- MENUS --- */
        .glass-panel { background: rgba(0, 0, 0, 0.8); backdrop-filter: blur(8px); border-top: 1px solid #333; }
        .theme-menu { 
            position: absolute; top: 60px; right: 10px; background: #111; border: 1px solid #444; 
            padding: 10px; border-radius: 12px; display: none; grid-template-columns: repeat(3, 1fr); gap: 8px; 
        }
        .theme-menu.show { display: grid; }
        .theme-btn { width: 40px; height: 40px; border-radius: 8px; border: 2px solid #555; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }
        .theme-btn:hover { border-color: #d4af37; }

        /* LOADING */
        #loading-screen { position: fixed; inset: 0; z-index: 9999; background: #000; color: #d4af37; display: flex; flex-col; align-items: center; justify-content: center; transition: opacity 0.5s; }
        .progress-bar { width: 200px; height: 3px; background: #333; margin-top: 20px; }
        .progress-fill { height: 100%; background: #d4af37; width: 0%; transition: width 0.3s; }
    </style>
</head>
<body class="bg-mystic">

    <audio id="sfx-flip" preload="auto" src="https://assets.mixkit.co/active_storage/sfx/2578/2578-preview.mp3"></audio>
    <audio id="ambience-rain" loop preload="auto" src="https://assets.mixkit.co/active_storage/sfx/1253/1253-preview.mp3"></audio> <audio id="ambience-forest" loop preload="auto" src="https://assets.mixkit.co/active_storage/sfx/177/177-preview.mp3"></audio> <audio id="ambience-library" loop preload="auto" src="https://assets.mixkit.co/active_storage/sfx/876/876-preview.mp3"></audio> <div id="loading-screen">
        <i class="fas fa-book-open fa-2x mb-4 animate-bounce"></i>
        <h2 class="font-[Cinzel] text-xl tracking-widest">ARCHIVE</h2>
        <div class="progress-bar"><div id="loading-bar" class="progress-fill"></div></div>
        <p class="text-xs text-gray-500 mt-2 font-mono">Tap anywhere to start</p>
    </div>

    <div id="auth-section" class="hidden fixed inset-0 z-[900] flex items-center justify-center bg-black/95 p-6">
        <div class="w-full max-w-sm text-center">
            <i class="fas fa-dragon text-5xl text-[#d4af37] mb-4"></i>
            <h1 class="text-3xl font-[Cinzel] text-white mb-8">MYSTERIUM</h1>
            <button id="google-login" class="w-full bg-white text-black font-bold py-4 rounded-xl flex items-center justify-center gap-2 hover:bg-gray-200"><i class="fab fa-google"></i> Login</button>
        </div>
    </div>

    <div id="wizard-container">
        <div class="wizard-avatar-box">
            <i class="fas fa-user-astronaut wizard-face"></i> </div>
        <div id="wizard-text" class="wizard-bubble">Welcome, Seeker!</div>
    </div>

    <div id="book-container" class="hidden w-full h-full relative flex-col">
        <div class="absolute top-0 w-full p-4 flex justify-between items-center z-50">
            <div id="logo-btn" class="bg-black/40 px-3 py-1 rounded-full border border-white/10 cursor-pointer">
                <span class="text-[#d4af37] font-[Cinzel] text-xs">MYSTERIUM</span>
            </div>
            <div class="flex gap-2 relative">
                <button onclick="toggleWizardMode()" id="wiz-btn" class="w-9 h-9 rounded-full bg-purple-900/50 border border-purple-500 text-purple-300 flex items-center justify-center"><i class="fas fa-hat-wizard"></i></button>
                
                <button onclick="toggleGlobalSound()" id="sound-btn" class="w-9 h-9 rounded-full bg-green-900/50 border border-green-500 text-green-300 flex items-center justify-center"><i class="fas fa-volume-up"></i></button>
                
                <button onclick="document.getElementById('bg-menu').classList.toggle('show')" class="w-9 h-9 rounded-full bg-gray-800 border border-gray-600 text-white flex items-center justify-center"><i class="fas fa-palette"></i></button>
                
                <button id="logout-btn" class="w-9 h-9 rounded-full bg-red-900/50 border border-red-500 text-red-300 flex items-center justify-center"><i class="fas fa-sign-out-alt"></i></button>

                <div id="bg-menu" class="theme-menu">
                    <button onclick="setTheme('rain')" class="theme-btn bg-blue-900 text-blue-200" title="Rainy Mood"><i class="fas fa-cloud-rain"></i></button>
                    <button onclick="setTheme('library')" class="theme-btn bg-yellow-900 text-yellow-200" title="Library"><i class="fas fa-landmark"></i></button>
                    <button onclick="setTheme('forest')" class="theme-btn bg-green-900 text-green-200" title="Forest"><i class="fas fa-tree"></i></button>
                    <button onclick="setTheme('mystic')" class="theme-btn bg-indigo-900 text-indigo-200" title="Mystic"><i class="fas fa-moon"></i></button>
                    <button onclick="setTheme('midnight')" class="theme-btn bg-slate-900 text-slate-200" title="Dark"><i class="fas fa-ghost"></i></button>
                    <button onclick="toggleDarkMode()" class="theme-btn bg-black text-white" title="Page Dark Mode"><i class="fas fa-adjust"></i></button>
                </div>
            </div>
        </div>

        <div class="book-scene" onclick="toggleControls()">
            <div id="the-book" class="book"><div id="pages-wrapper"></div></div>
        </div>

        <div id="controls-bar" class="absolute bottom-0 w-full glass-panel p-4 z-50 transition-transform duration-300">
            <div class="flex gap-4">
                <button onclick="prevPage()" class="flex-1 h-12 bg-white/10 rounded-lg text-white font-bold">PREV</button>
                <button onclick="nextPage()" class="flex-1 h-12 bg-white/10 rounded-lg text-white font-bold">NEXT</button>
            </div>
        </div>
    </div>

    <div id="policy-view" class="hidden fixed inset-0 z-[950] bg-black/95 p-6 text-white overflow-y-auto">
        <h1 class="text-gold font-[Cinzel] text-2xl mb-4">Policies</h1>
        <p class="text-sm text-gray-400">Standard Refund & Privacy Policies Apply.</p>
        <button onclick="document.getElementById('policy-view').classList.add('hidden')" class="mt-4 px-4 py-2 bg-gray-700 rounded">Close</button>
    </div>
    
    <div id="pay-modal" class="hidden fixed inset-0 z-[999] bg-black/90 flex items-center justify-center p-4">
        <div class="bg-gray-900 border border-gold p-6 rounded-xl text-center">
            <i class="fas fa-lock text-3xl text-gold mb-4"></i>
            <h3 class="text-white mb-2">LOCKED</h3>
            <p class="text-gray-400 text-xs mb-4">Upload Rs.100 Receipt</p>
            <input type="file" id="receipt-file" class="text-white text-xs mb-4">
            <button id="send-receipt" class="w-full bg-gold text-black font-bold py-2 rounded">Submit</button>
            <button onclick="document.getElementById('pay-modal').classList.add('hidden')" class="text-xs text-gray-500 mt-2 block w-full">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, limit, startAfter, onSnapshot, updateDoc } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyByyYMFzn1nHOuzxEsX44sQrIIT5AdB3Pc",
            authDomain: "book-8cd24.firebaseapp.com",
            projectId: "book-8cd24",
            storageBucket: "book-8cd24.firebasestorage.app",
            messagingSenderId: "747560284834",
            appId: "1:747560284834:web:30f6080e8d4fbf9025ddfb",
            measurementId: "G-FFFS1HS4GY"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        let user = null;
        let isUnlocked = false;
        let lastLoadedPageDoc = null;
        let isLoadingMore = false;
        const BATCH_SIZE = 5;

        // --- FEATURES STATE ---
        let soundOn = true;
        let wizardOn = true;
        let currentTheme = 'mystic';
        let currentAmbience = null; // Stores the current Audio object

        // --- AUDIO MANAGER ---
        const audioTracks = {
            'rain': document.getElementById('ambience-rain'),
            'forest': document.getElementById('ambience-forest'),
            'library': document.getElementById('ambience-library')
        };
        const flipSfx = document.getElementById('sfx-flip');

        window.setTheme = (themeName) => {
            // Stop previous ambience
            if(currentAmbience) {
                currentAmbience.pause();
                currentAmbience.currentTime = 0;
            }

            // Change Visuals
            document.body.className = `bg-${themeName}`;
            currentTheme = themeName;
            
            // Play New Ambience (if sound is on)
            if(soundOn && audioTracks[themeName]) {
                currentAmbience = audioTracks[themeName];
                currentAmbience.volume = 0.5;
                currentAmbience.play().catch(e => console.log("Audio waiting interaction"));
            } else {
                currentAmbience = null;
            }
            
            document.getElementById('bg-menu').classList.remove('show');
        };

        window.toggleGlobalSound = () => {
            soundOn = !soundOn;
            const btn = document.getElementById('sound-btn');
            
            if(soundOn) {
                btn.innerHTML = '<i class="fas fa-volume-up"></i>';
                btn.classList.replace('bg-red-900/50', 'bg-green-900/50');
                btn.classList.replace('text-red-300', 'text-green-300');
                // Resume ambience if current theme has one
                if(audioTracks[currentTheme]) {
                    currentAmbience = audioTracks[currentTheme];
                    currentAmbience.play().catch(()=>{});
                }
            } else {
                btn.innerHTML = '<i class="fas fa-volume-mute"></i>';
                btn.classList.replace('bg-green-900/50', 'bg-red-900/50');
                btn.classList.replace('text-green-300', 'text-red-300');
                // Stop ambience
                if(currentAmbience) currentAmbience.pause();
            }
        };

        function playPageFlip() {
            if(soundOn) {
                flipSfx.currentTime = 0;
                flipSfx.volume = 1.0;
                flipSfx.play().catch(()=>{});
            }
        }

        // --- WIZARD MANAGER ---
        const wizardQuotes = [
            "Excellent pace!", "A secret lies ahead...", "Read deeper.", 
            "The story breathes.", "You are the chosen one.", "One more page?"
        ];

        window.toggleWizardMode = () => {
            wizardOn = !wizardOn;
            const btn = document.getElementById('wiz-btn');
            if(wizardOn) {
                btn.classList.replace('bg-gray-800', 'bg-purple-900/50');
                showWizard("I am returned!");
            } else {
                btn.classList.replace('bg-purple-900/50', 'bg-gray-800');
                document.getElementById('wizard-container').classList.remove('active');
            }
        };

        function showWizard(text) {
            if(!wizardOn) return;
            const wiz = document.getElementById('wizard-container');
            document.getElementById('wizard-text').innerText = text;
            wiz.classList.add('active');
            setTimeout(() => wiz.classList.remove('active'), 3500);
        }

        // --- AUTH & LOAD ---
        onAuthStateChanged(auth, async (u) => {
            if(u){
                user = u;
                document.getElementById('auth-section').classList.add('hidden');
                setupUserListener(u.uid);
            } else {
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('auth-section').classList.remove('hidden');
            }
        });

        function setupUserListener(uid) {
            onSnapshot(doc(db, "users", uid), (docSnap) => {
                if (docSnap.exists() && docSnap.data().status === 'approved') {
                    isUnlocked = true;
                } else isUnlocked = false;
                initBookLoad();
            });
        }

        async function initBookLoad() {
            document.getElementById('loading-bar').style.width = '50%';
            await loadInitialPages();
            document.getElementById('loading-bar').style.width = '100%';
            setTimeout(() => {
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
                document.getElementById('book-container').classList.remove('hidden');
                document.getElementById('book-container').style.display='flex';
                resizeContent();
                // Try playing ambience on start (might get blocked until click)
                setTheme('mystic'); 
            }, 800);
        }

        // --- BOOK LOGIC ---
        async function loadInitialPages() {
            const wrap = document.getElementById('pages-wrapper');
            wrap.innerHTML = '';
            // Load dummy or real pages based on logic (Using simplified logic for brevity)
            if(isUnlocked) {
                 const q = query(collection(db, "pages"), orderBy("pageNumber", "asc"), limit(BATCH_SIZE));
                 const snap = await getDocs(q);
                 if(!snap.empty) {
                     lastLoadedPageDoc = snap.docs[snap.docs.length-1];
                     renderBatch(snap.docs.map(d=>d.data()));
                 }
            } else {
                // Show Cover + Dummies
                const snap = await getDocs(query(collection(db, "pages"), where("pageNumber", "==", 0)));
                if(!snap.empty) renderBatch([snap.docs[0].data()]);
                renderBatch([{pageNumber:1, isDummy:true}, {pageNumber:2, isDummy:true}]);
            }
        }
        
        async function loadMorePages() {
            if (!isUnlocked || isLoadingMore || !lastLoadedPageDoc) return;
            isLoadingMore = true;
            const q = query(collection(db, "pages"), orderBy("pageNumber", "asc"), startAfter(lastLoadedPageDoc), limit(1));
            const snap = await getDocs(q);
            if (!snap.empty) {
                lastLoadedPageDoc = snap.docs[snap.docs.length - 1];
                renderBatch(snap.docs.map(d => d.data()));
            } else { lastLoadedPageDoc = null; }
            isLoadingMore = false;
        }

        function renderBatch(dataList) {
            const wrap = document.getElementById('pages-wrapper');
            dataList.forEach(data => {
                let zIndex = 1000 - data.pageNumber;
                if (data.pageNumber === 1000) zIndex = 0;
                
                const page = document.createElement('div');
                page.className = `page shadow-2xl ${data.pageNumber===0?'hard-cover':''}`;
                page.dataset.pn = data.pageNumber; page.style.zIndex = zIndex;
                
                const front = document.createElement('div'); front.className = 'front';
                front.style.backgroundColor = data.backgroundColor || '#ffffff';
                const content = document.createElement('div'); content.className = 'content-layer';
                front.appendChild(content);

                if(data.elements && !data.isDummy) {
                    data.elements.forEach(el => {
                        const div = document.createElement('div');
                        div.style.position='absolute'; div.style.left=el.left; div.style.top=el.top;
                        if(el.type==='text'){
                            div.innerText=el.content; Object.assign(div.style, el.style);
                            div.style.width='max-content'; div.style.whiteSpace='pre';
                        } else {
                            div.innerHTML=`<img src="${el.content}" style="width:100%; height:100%; object-fit:cover;">`;
                            div.style.width='100%'; div.style.height='100%';
                        }
                        content.appendChild(div);
                    });
                }
                
                if(data.pageNumber===0 && !isUnlocked) front.innerHTML += `<div class="absolute inset-0 flex items-end justify-center pb-20 pointer-events-none"><div class="px-4 py-2 bg-black/80 text-gold rounded-full border border-gold animate-bounce">LOCKED</div></div>`;
                if(data.isDummy) front.innerHTML = `<div class="flex items-center justify-center h-full text-gray-300 font-[Cinzel] text-2xl border-4 border-gray-100 m-8">LOCKED</div>`;

                const back = document.createElement('div'); back.className = 'back';
                page.appendChild(front); page.appendChild(back);
                
                page.onclick = (e) => {
                    e.stopPropagation();
                    if(!isUnlocked && data.pageNumber!==0) { document.getElementById('pay-modal').classList.remove('hidden'); return; }
                    
                    if(page.classList.contains('flipped')) {
                        page.classList.remove('flipped');
                        page.style.zIndex = zIndex + 50; 
                        setTimeout(()=>page.style.zIndex = zIndex, 1000);
                        playPageFlip();
                    } else {
                        page.classList.add('flipped');
                        page.style.zIndex = 100; // temporarily high
                        setTimeout(()=>page.style.zIndex = 1, 600);
                        playPageFlip();
                        // Trigger Wizard Randomly
                        if(Math.random() > 0.6) showWizard(wizardQuotes[Math.floor(Math.random()*wizardQuotes.length)]);
                        loadMorePages();
                    }
                };
                wrap.appendChild(page);
            });
            resizeContent();
        }

        // --- HELPERS ---
        function resizeContent() {
            const bookEl = document.getElementById('the-book'); if(!bookEl) return;
            const layers = document.querySelectorAll('.content-layer');
            const scale = bookEl.offsetHeight / 540;
            layers.forEach(l => l.style.transform = `translate(-50%, -50%) scale(${scale})`);
        }
        window.addEventListener('resize', resizeContent);
        
        window.nextPage = () => { const u = document.querySelectorAll('.page:not(.flipped):not([data-pn="undefined"])'); if(u.length) u[0].click(); };
        window.prevPage = () => { const f = document.querySelectorAll('.page.flipped'); if(f.length) f[f.length-1].click(); };
        window.toggleControls = () => { document.getElementById('controls-bar').classList.toggle('translate-y-full'); };
        window.toggleDarkMode = () => document.body.classList.toggle('dark-mode');

        // Auth
        document.getElementById('google-login').onclick = async () => {
            try { await signInWithPopup(auth, new GoogleAuthProvider()); } catch(e){ alert(e.message); }
        };
        document.getElementById('logout-btn').onclick = () => signOut(auth);

        // Upload
        const processImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader(); reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image(); img.src = e.target.result;
                    img.onload = () => {
                        const c = document.createElement('canvas');
                        let w=img.width, h=img.height, m=800;
                        if(w>h){if(w>m){h*=m/w;w=m}}else{if(h>m){w*=m/h;h=m}}
                        c.width=w;c.height=h;c.getContext('2d').drawImage(img,0,0,w,h);
                        resolve(c.toDataURL('image/jpeg',0.6));
                    }
                }
            });
        };
        document.getElementById('send-receipt').onclick = async () => {
            const f = document.getElementById('receipt-file').files[0];
            if(user && f) {
                const b64 = await processImage(f);
                await setDoc(doc(db,'requests',user.uid), {userId:user.uid, email:user.email, receiptImage:b64, status:'pending'});
                await setDoc(doc(db,'users',user.uid), {status:'pending'}, {merge:true});
                alert("Sent!"); document.getElementById('pay-modal').classList.add('hidden');
            }
        };
    </script>
</body>
</html>
