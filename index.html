<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sithuliya Admin Pro - Ultimate Suite (V5 Allowances)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        body { font-family: 'Poppins', sans-serif; }
        .luxury-font { font-family: 'Playfair Display', serif; }
        .glass-dark { background: rgba(0, 0, 0, 0.75); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px); }
        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        #pdfPreviewOverlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: #525659; z-index: 10000; overflow-y: auto; display: none;
        }
        .pdf-container-flex { display: flex; justify-content: center; padding: 40px 0; background: #525659; min-height: 100%; }
        
        .print-paper { 
            width: 210mm; min-height: 297mm; background: white; padding: 15mm; 
            color: black; font-family: 'Times New Roman', serif; 
            box-shadow: 0 0 15px rgba(0,0,0,0.5); box-sizing: border-box; margin: 0 auto; 
        }
        @media (max-width: 768px) { .print-paper { width: 95%; padding: 10mm; zoom: 0.6; } }
        
        .receipt-box { border: 2px solid #333; padding: 20px; position: relative; }
        .receipt-header { border-bottom: 2px solid #333; padding-bottom: 15px; margin-bottom: 20px; text-align: center; }
        .receipt-title { font-size: 24px; font-weight: bold; text-transform: uppercase; letter-spacing: 2px; }
        .receipt-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 14px; }
        .receipt-label { font-weight: bold; color: #555; }
        .receipt-value { font-weight: bold; color: #000; }
        .receipt-footer { margin-top: 40px; display: flex; justify-content: space-between; text-align: center; font-size: 12px; }
        .sign-line { border-top: 1px dotted #000; width: 150px; margin-top: 40px; padding-top: 5px; }

        .report-table { width: 100%; border-collapse: collapse; margin-top: 5px; font-size: 12px; margin-bottom: 15px; }
        .report-table th, .report-table td { border: 1px solid #000; padding: 4px 8px; vertical-align: middle; }
        .report-table th { background-color: #f0f0f0; text-align: left; font-weight: bold; }
        .report-header-bg { background-color: #e0e0e0; font-weight: bold; text-transform: uppercase; padding: 5px; border: 1px solid #000; font-size: 13px; margin-top: 15px; }
        
        .modal-content-scroll { max-height: 85vh; overflow-y: auto; }
        /* Dropdown Styling */
        .dropdown { position: relative; display: inline-block; width: 100%; }
        .dropdown-content { display: none; position: absolute; background-color: #fff; min-width: 100%; overflow: auto; border: 1px solid #ddd; z-index: 50; max-height: 150px; border-radius: 0.5rem; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .dropdown-content div { color: black; padding: 12px 16px; text-decoration: none; display: block; cursor: pointer; }
        .dropdown-content div:hover {background-color: #f3f4f6;}
        .show {display: block;}
        
        .prose h3 { font-weight: bold; margin-top: 1em; }
        .prose ul { list-style-type: disc; margin-left: 1.5em; }

        .input-number-clear {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #1e3a8a;
        }
        
        .dyn-row { display: flex; gap: 5px; margin-bottom: 5px; align-items: center; }
        .dyn-del-btn { color: #ef4444; cursor: pointer; padding: 2px 5px; }
        .section-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e5e7eb; padding-bottom: 5px; margin-bottom: 10px; }

        .report-form-section { margin-bottom: 2rem; border: 1px solid #e2e8f0; padding: 1.5rem; border-radius: 0.75rem; background: white; }
    </style>
</head>
<body class="bg-gray-100 h-screen overflow-hidden text-gray-800">

    <div id="pdfPreviewOverlay">
        <div class="sticky top-0 w-full bg-slate-800 p-4 flex justify-between items-center z-50 shadow-md">
            <h2 class="text-white font-bold">Document Preview</h2>
            <div class="flex gap-4">
                <button onclick="document.getElementById('pdfPreviewOverlay').style.display='none'" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded shadow font-bold text-sm">Close</button>
                <button onclick="downloadPDFActual()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded shadow font-bold text-sm"><i class="fas fa-download mr-2"></i> Download PDF</button>
            </div>
        </div>
        <div class="pdf-container-flex">
            <div id="printContainer" class="print-paper"></div>
        </div>
    </div>
    
    <div id="aiAnalysisModal" class="hidden fixed inset-0 z-[80] bg-black/80 flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative modal-content-scroll max-h-[85vh]">
            <button onclick="document.getElementById('aiAnalysisModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-2xl font-bold text-blue-900 mb-4 flex items-center"><i class="fas fa-robot mr-2 text-purple-600"></i> AI Project Analyst</h2>
            <div id="aiLoading" class="text-center py-10">
                <i class="fas fa-spinner fa-spin text-4xl text-blue-500 mb-4"></i>
                <p class="text-gray-500 animate-pulse">Analyzing financial data...</p>
            </div>
            <div id="aiContent" class="hidden prose text-sm text-slate-700"></div>
        </div>
    </div>

    <div id="imgModal" class="hidden fixed inset-0 z-[100] bg-black/95 flex items-center justify-center p-4 cursor-pointer backdrop-blur-sm" onclick="closeImgModal()">
        <img id="imgModalSrc" class="max-h-[90vh] max-w-full rounded-lg shadow-2xl border border-gray-600">
    </div>

    <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center bg-cover bg-center" style="background-image: url('https://images.unsplash.com/photo-1600596542815-2a429b08e695?q=80&w=2070&auto=format&fit=crop');">
        <div class="absolute inset-0 bg-blue-900/60"></div>
        <div class="relative z-10 glass-dark p-10 rounded-3xl shadow-2xl w-11/12 max-w-md text-center border border-blue-400/30">
            <div class="mb-8">
                <div class="flex justify-center mb-4">
                    <img src="ico.jpeg" onerror="this.src='https://placehold.co/150x150/1e3a8a/ffffff?text=Sithuliya'" class="w-32 h-32 rounded-full border-4 border-blue-500 shadow-xl object-cover">
                </div>
                <h1 class="text-4xl text-white luxury-font tracking-wide">Sithuliya</h1>
                <p class="text-blue-300 text-xs uppercase tracking-[0.4em] mt-2">Exclusive Real Estate</p>
            </div>
            <div class="space-y-4">
                <input type="password" id="loginPass" class="w-full bg-white/10 border border-white/20 rounded-lg p-3 text-white placeholder-gray-300 focus:outline-none focus:border-blue-500 text-center tracking-widest transition" placeholder="Password">
                <button onclick="attemptLogin()" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 rounded-lg shadow-lg transition transform hover:scale-105">LOGIN</button>
            </div>
        </div>
    </div>

    <div id="mainApp" class="hidden flex h-full">
        <div id="sidebar" class="w-64 bg-slate-900 text-white shadow-2xl flex flex-col z-40 fixed md:relative h-full transition-transform transform -translate-x-full md:translate-x-0">
            <div class="p-6 border-b border-slate-800 flex flex-col items-center relative">
                <button onclick="toggleSidebar()" class="absolute top-4 right-4 md:hidden text-gray-400 hover:text-white"><i class="fas fa-times"></i></button>
                <img src="ico.jpeg" onerror="this.src='https://placehold.co/150x150/1e3a8a/ffffff?text=Sithuliya'" class="w-16 h-16 rounded-full border-2 border-blue-500 mb-3 object-cover shadow-lg">
                <h2 class="text-2xl luxury-font text-blue-400">Sithuliya <span class="text-[10px] font-sans text-slate-500 block tracking-widest mt-1 text-center">ADMIN CONSOLE</span></h2>
            </div>
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto">
                <button onclick="nav('attendance')" id="nav-attendance" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-user-clock mr-3"></i> Attendance</button>
                <button onclick="nav('projects')" id="nav-projects" class="nav-btn w-full text-left p-3 rounded-xl bg-blue-900/50 text-blue-400 font-bold border border-blue-800"><i class="fas fa-map-marked-alt mr-3"></i> Projects</button>
                <button onclick="nav('lands')" id="nav-lands" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tree mr-3"></i> Lands</button>
                <button onclick="openStaffAccess()" id="nav-staff" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-users mr-3"></i> Staff</button>
                <button onclick="nav('readings')" id="nav-readings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-tachometer-alt mr-3"></i> Meter Approvals</button>
                <button onclick="openFinanceAccess()"id="nav-reports" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-file-invoice-dollar mr-3"></i> Financial Center</button>
                <div class="pt-8 border-t border-slate-800 mt-8">
                    <button onclick="nav('settings')" id="nav-settings" class="nav-btn w-full text-left p-3 rounded-xl hover:bg-slate-800 text-gray-400 font-medium transition"><i class="fas fa-cog mr-3"></i> Settings</button>
                </div>
            </nav>
        </div>

        <div id="sidebarOverlay" onclick="toggleSidebar()" class="fixed inset-0 bg-black/50 z-30 hidden md:hidden"></div>

        <div class="flex-1 flex flex-col overflow-hidden bg-gray-50 relative">
            <header class="bg-white shadow-sm p-4 flex justify-between items-center z-10 px-4 md:px-8 border-b border-blue-100">
                <button onclick="toggleSidebar()" class="md:hidden text-slate-800 text-xl mr-4"><i class="fas fa-bars"></i></button>
                
                <div class="relative w-full max-w-sm group">
                    <input type="text" id="projSearch" placeholder="Search Projects / Customers..." class="w-full pl-10 pr-4 py-2 border-none bg-blue-50 rounded-full focus:ring-2 focus:ring-blue-500 transition text-sm group-hover:bg-blue-100 text-blue-900" onkeyup="handleGlobalSearch()" onfocus="handleGlobalSearch()">
                    <i class="fas fa-search absolute left-4 top-2.5 text-blue-400"></i>
                    <div id="searchResults" class="hidden absolute top-12 left-0 w-full bg-white shadow-2xl rounded-xl border border-blue-100 max-h-96 overflow-y-auto z-50"></div>
                </div>
                
                <div class="flex items-center gap-4 md:gap-6 ml-4">
                    <div class="relative cursor-pointer" onclick="toggleNotifPanel()">
                        <div class="relative">
                            <i id="bellIcon" class="fas fa-bell text-gray-400 text-xl hover:text-blue-800 transition"></i>
                            <span id="notifBadge" class="hidden absolute -top-2 -right-2 bg-red-600 text-white text-[10px] font-bold w-4 h-4 flex items-center justify-center rounded-full">0</span>
                        </div>
                    </div>
                    <button onclick="openNewProjectModal()" class="bg-blue-900 text-white px-3 md:px-5 py-2 rounded-full hover:bg-blue-800 shadow-lg shadow-blue-900/20 text-xs md:text-sm font-bold transition transform hover:scale-105 whitespace-nowrap"><i class="fas fa-plus mr-1 md:mr-2"></i> <span class="hidden md:inline">New Project</span><span class="md:hidden">New</span></button>
                </div>
            </header>

            <div id="notifPanel" class="hidden absolute top-20 right-4 md:right-8 w-80 md:w-96 bg-white shadow-2xl rounded-xl border border-gray-100 z-50 overflow-hidden animate-fade-in-down">
                <div class="bg-slate-900 p-3 text-white text-sm font-bold flex justify-between items-center">
                    <span><i class="fas fa-exclamation-circle mr-2"></i>Notifications</span>
                    <button onclick="toggleNotifPanel()"><i class="fas fa-times"></i></button>
                </div>
                <div id="notifList" class="max-h-80 overflow-y-auto bg-gray-50"></div>
            </div>

            <main class="flex-1 overflow-auto p-4 md:p-8" id="mainScrollContainer">
                <div id="page-attendance" class="hidden pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Global Attendance Log</h2>
                        <div class="flex gap-2 items-center w-full md:w-auto">
                            <input type="date" id="attendanceDateFilter" class="p-2 border rounded-lg bg-white text-sm w-full md:w-auto shadow-sm" onchange="loadGlobalAttendance()">
                            <button onclick="loadGlobalAttendance()" class="bg-blue-900 text-white px-4 py-2 rounded-lg font-bold text-sm shadow hover:bg-blue-800"><i class="fas fa-sync-alt"></i></button>
                        </div>
                    </div>
                    <div id="globalAttendanceGrid" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6">
                        </div>
                </div>

                <div id="page-projects">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Active Developments</h2>
                        <div class="flex bg-gray-200 rounded-lg p-1">
                             <button onclick="toggleProjectView('active')" id="btn-view-active" class="px-4 py-1 rounded-md text-sm font-bold bg-white shadow text-slate-800">Active</button>
                             <button onclick="toggleProjectView('closed')" id="btn-view-closed" class="px-4 py-1 rounded-md text-sm font-bold text-gray-500 hover:text-slate-800">Closed</button>
                        </div>
                    </div>
                    <div id="projectGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6"></div>
                    <div id="closedProjectList" class="hidden space-y-4"></div>
                </div>

                <div id="page-lands" class="hidden">
                    <div class="flex justify-between items-center mb-6">
                        <h2 class="text-2xl font-bold text-slate-800">Land Acquisition</h2>
                        <button onclick="document.getElementById('newLandModal').classList.remove('hidden')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-700 text-sm md:text-base"><i class="fas fa-plus mr-2"></i> Add New Land</button>
                    </div>
                    <div id="landsGrid" class="grid grid-cols-1 lg:grid-cols-2 gap-6"></div>
                </div>

                <div id="page-staff" class="hidden">
                    <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
                        <h2 class="text-2xl font-bold text-slate-800">Staff Management</h2>
                        <div class="flex flex-col md:flex-row gap-4 items-center w-full md:w-auto">
                            <div class="relative w-full md:w-auto">
                                <input type="text" id="staffSearchInput" onkeyup="filterStaffGrid()" placeholder="Search Staff..." class="w-full pl-8 pr-4 py-2 border rounded-full text-sm focus:ring-blue-500 bg-white">
                                <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                            </div>
                            <div class="flex gap-2 w-full md:w-auto">
                                <button onclick="document.getElementById('staffPassChangeModal').classList.remove('hidden')" class="flex-1 md:flex-none bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-yellow-600 text-xs">Password</button>
                                <button onclick="document.getElementById('newStaffModal').classList.remove('hidden'); document.getElementById('staffMode').value='new'; document.getElementById('newStaffBtnText').innerText='Save Member';" class="flex-1 md:flex-none bg-blue-600 text-white px-4 py-2 rounded-lg font-bold hover:bg-blue-700 text-xs"><i class="fas fa-user-plus mr-2"></i> Add Staff</button>
                            </div>
                        </div>
                    </div>
                    <div class="flex flex-col xl:flex-row gap-6">
                        <div id="staffGrid" class="grid grid-cols-1 md:grid-cols-2 gap-6 flex-1"></div>
                        <div class="w-full xl:w-80 bg-white border border-blue-100 rounded-xl shadow-sm p-4 h-fit">
                            <h3 class="font-bold text-blue-900 mb-3 border-b pb-2 flex justify-between items-center">
                                <span><i class="fas fa-piggy-bank mr-2"></i>Staff Welfare (0.25%)</span>
                            </h3>
                            <div id="staffPoolList" class="max-h-[500px] overflow-y-auto space-y-2 text-xs"></div>
                            <div class="border-t mt-3 pt-2 flex justify-between font-bold text-sm">
                                <span>Total Pool:</span>
                                <span class="text-green-600" id="staffPoolTotal">Rs. 0.00</span>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="page-detail" class="hidden pb-20">
                    <div class="flex flex-col md:flex-row justify-between items-start mb-6 gap-4">
                        <div>
                            <button onclick="nav('projects')" class="text-gray-400 hover:text-blue-800 mb-2 font-bold text-xs uppercase tracking-wide"><i class="fas fa-arrow-left mr-2"></i> Back to Dashboard</button>
                            <h1 id="detailName" class="text-3xl md:text-4xl font-bold text-blue-900 luxury-font">Project Name</h1>
                            <p class="text-gray-500 flex items-center mt-1 text-sm"><i class="fas fa-map-marker-alt mr-2 text-blue-500"></i> <span id="detailArea">Area</span> | <span id="detailLandName" class="ml-2 font-bold text-slate-800"></span></p>
                        </div>
                        <div class="flex flex-col items-end gap-2 w-full md:w-auto">
                            <span id="detailStatus" class="px-4 py-1 rounded-full text-xs font-bold uppercase bg-blue-100 text-blue-800 border border-blue-200">Development</span>
                            <div class="flex gap-2 flex-wrap justify-end">
                                <button onclick="openReportDataModal()" class="text-xs bg-slate-100 text-slate-700 px-3 py-1 rounded font-bold border hover:bg-slate-200"><i class="fas fa-edit mr-1"></i> Data</button>
                                <button onclick="generateProjectMasterReport()" class="text-xs bg-slate-800 text-white px-3 py-1 rounded font-bold hover:bg-slate-900"><i class="fas fa-print mr-1"></i> Report</button>
                                <button id="endDevBtn" onclick="endDevelopmentPhase()" class="text-xs text-red-500 hover:bg-red-50 px-3 py-1 rounded border border-red-200 font-bold">End Dev</button>
                                <button id="closeProjBtn" onclick="closeProject()" class="hidden text-xs bg-red-600 text-white px-3 py-1 rounded shadow hover:bg-red-700 font-bold"><i class="fas fa-lock mr-1"></i> Close</button>
                                <button id="deleteProjBtn" onclick="deleteProject()" class="text-xs bg-red-800 text-white px-3 py-1 rounded shadow hover:bg-red-900 font-bold"><i class="fas fa-trash mr-1"></i> Delete</button>
                            </div>
                        </div>
                    </div>

                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto hide-scrollbar">
                        <button onclick="subTab('overview')" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 sub-tab whitespace-nowrap" id="st-overview">Overview</button>
                        <button onclick="subTab('tasks')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-tasks">Tasks</button>
                        <button onclick="subTab('finance')" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 sub-tab whitespace-nowrap" id="st-finance">Finance</button>
                    </div>

                    <div id="view-overview">
                        <div id="devPhaseUI" class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Add Land Blocks</h3>
                                <div class="flex flex-wrap gap-2 mb-2">
                                    <input type="text" id="blockName" placeholder="No (e.g. A1)" class="p-2 border rounded w-20 text-sm focus:ring-blue-500">
                                    <input type="number" id="blockSize" placeholder="Perches" class="p-2 border rounded w-24 text-sm focus:ring-blue-500" oninput="calcBlockPrice()" onkeyup="calcBlockPrice()" step="any">
                                    <input type="number" id="blockPerchPrice" placeholder="Price/Perch" class="p-2 border rounded w-32 text-sm focus:ring-blue-500" oninput="calcBlockPrice()" onkeyup="calcBlockPrice()" step="0.01">
                                    <input type="number" id="blockPrice" placeholder="Total Price" class="p-2 border rounded flex-1 bg-gray-50 font-bold text-slate-700 text-sm" readonly>
                                    <button id="addBlockBtn" class="bg-blue-600 text-white px-4 rounded hover:bg-blue-700 shadow"><i class="fas fa-plus"></i></button>
                                </div>
                            </div>
                            <div class="bg-white p-6 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-sm uppercase text-gray-400 mb-4 flex items-center tracking-wider">Assigned Vehicles</h3>
                                <div class="flex gap-2 mb-2">
                                    <input type="text" id="regVehicleNo" placeholder="Vehicle Number (e.g. WP-1234)" class="p-2 border rounded w-full uppercase text-sm focus:ring-blue-500">
                                    <button id="regVehicleBtn" onclick="assignVehicle()" class="bg-slate-800 text-white px-4 py-2 rounded text-sm hover:bg-slate-900 shadow">Assign</button>
                                </div>
                                <div id="vehicleList" class="flex flex-wrap gap-2 mt-2"></div>
                            </div>
                        </div>
                        <h3 class="text-xl font-bold mb-4 text-slate-700">Land Blocks Map</h3>
                        <div id="blocksContainer" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4"></div>
                    </div>
                    
                    <div id="view-tasks" class="hidden">
                        <div class="flex justify-between items-center mb-6">
                            <h3 class="text-xl font-bold text-slate-700">Site Operations</h3>
                            <button onclick="document.getElementById('newTaskModal').classList.remove('hidden')" class="bg-slate-800 text-white px-4 py-2 rounded-lg text-sm font-bold shadow hover:bg-slate-900"><i class="fas fa-plus mr-2"></i> Assign Task</button>
                        </div>
                        <div id="adminTaskList" class="space-y-4"></div>
                    </div>

                    <div id="view-finance" class="hidden">
                        <div class="bg-white p-8 rounded-2xl shadow-lg border border-blue-100 mb-8">
                            <div class="flex flex-col md:flex-row justify-between items-center mb-6 gap-4">
                                <h3 class="font-bold text-2xl text-slate-800 luxury-font">Profit Analysis</h3>
                                <div class="flex gap-2">
                                    <button onclick="downloadFinancialReport()" class="bg-blue-900 text-white px-4 py-2 rounded-lg text-sm font-bold border hover:bg-blue-800 transition"><i class="fas fa-file-download mr-2"></i> Report</button>
                                    <button onclick="openExpenseModal()" class="bg-red-50 text-red-600 hover:bg-red-100 px-4 py-2 rounded-lg text-sm font-bold border border-red-200 transition"><i class="fas fa-receipt mr-2"></i> Add Misc Expense</button>
                                </div>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-8 text-center">
                                <div class="p-6 rounded-xl bg-green-50 border border-green-100">
                                    <p class="text-xs text-green-600 uppercase font-bold tracking-widest mb-2">Revenue (Sold)</p>
                                    <h4 id="finIncome" class="text-3xl font-bold text-green-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-red-50 border border-red-100">
                                    <p class="text-xs text-red-600 uppercase font-bold tracking-widest mb-2">Cost (Exp + Tasks)</p>
                                    <h4 id="finExpense" class="text-3xl font-bold text-red-700">Rs. 0.00</h4>
                                </div>
                                <div class="p-6 rounded-xl bg-slate-50 border border-slate-200 relative overflow-hidden">
                                    <div class="absolute inset-0 bg-gradient-to-br from-white/50 to-transparent"></div>
                                    <p class="text-xs text-slate-600 uppercase font-bold tracking-widest mb-2 relative z-10">Net Profit</p>
                                    <h4 id="finProfit" class="text-3xl font-bold text-slate-800 relative z-10">Rs. 0.00</h4>
                                </div>
                            </div>
                        </div>
                        <h3 class="font-bold text-lg mb-4 text-slate-700">Expense Ledger</h3>
                        <div class="overflow-x-auto">
                            <table class="w-full text-sm text-left bg-white rounded-lg overflow-hidden shadow-sm"><tbody id="expenseList"></tbody></table>
                        </div>
                    </div>
                </div>

                <div id="page-readings" class="hidden">
                    <h2 class="text-2xl font-bold mb-6 text-slate-800">Meter Approvals</h2>
                    <div id="readingsList" class="space-y-4"></div>
                </div>
                
                 <div id="page-reports" class="hidden">
                   <div class="flex flex-col md:flex-row justify-between items-start md:items-center mb-6 gap-4">
    <h2 class="text-2xl font-bold text-slate-800">Financial Center</h2>
    <button onclick="document.getElementById('financePassChangeModal').classList.remove('hidden')" class="bg-yellow-500 text-white px-3 py-2 rounded-lg font-bold hover:bg-yellow-600 text-xs">
        <i class="fas fa-key mr-1"></i> Change Finance Password
    </button>
</div>
                    <div class="flex border-b border-gray-200 mb-6 overflow-x-auto">
                        <button onclick="switchFinTab('entry')" id="ft-entry" class="px-6 py-3 font-bold text-slate-800 border-b-2 border-blue-800 transition whitespace-nowrap">Data Entry</button>
                        <button onclick="switchFinTab('reports')" id="ft-reports" class="px-6 py-3 font-bold text-gray-400 hover:text-blue-600 transition whitespace-nowrap">View Reports</button>
                    </div>

                    <div id="fin-view-entry">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-coins text-blue-500 mr-2"></i> Transaction Entry</h3>
                                <div class="space-y-4">
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="txDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Voucher No</label><input type="text" id="txVno" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Description</label><input type="text" id="txDesc" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div class="flex gap-4"><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="txType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Expense">Expense</option><option value="Income">Income</option></select></div><div class="flex-1"><label class="block text-xs font-bold text-gray-500 mb-1">Amount</label><input type="number" id="txAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500" step="0.01"></div></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Category</label><select id="txCategory" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><optgroup label="Income"><option value="Sales">Revenue</option><option value="Other Income">Other</option></optgroup><optgroup label="Expenses"><option value="Admin Expense">Admin</option><option value="Petty Cash">Petty Cash</option></optgroup></select></div>
                                    <div class="flex items-center gap-2 pt-2"><input type="checkbox" id="txIsPetty" class="w-4 h-4 text-blue-500 rounded"><label for="txIsPetty" class="text-sm font-bold text-slate-700">Petty Cash Record</label></div>
                                    <button onclick="saveTransaction()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-xl hover:bg-slate-800 mt-4 shadow-lg">SAVE TRANSACTION</button>
                                </div>
                            </div>
                            <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 h-fit">
                                <h3 class="font-bold text-lg text-slate-800 mb-4 flex items-center"><i class="fas fa-balance-scale text-blue-500 mr-2"></i> Balance Sheet Entry</h3>
                                <div class="space-y-4">
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Date</label><input type="date" id="bsDate" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Account</label><input type="text" id="bsName" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Type</label><select id="bsType" class="w-full p-2 border rounded bg-gray-50 focus:ring-blue-500"><option value="Non-Current Asset">Asset (Fixed)</option><option value="Current Asset">Asset (Current)</option><option value="Equity">Equity</option><option value="Current Liability">Liability</option></select></div>
                                    <div><label class="block text-xs font-bold text-gray-500 mb-1">Value</label><input type="number" id="bsAmount" class="w-full p-2 border rounded bg-gray-50 font-bold focus:ring-blue-500" step="0.01"></div>
                                    <button onclick="saveBSItem()" class="w-full bg-blue-600 text-white font-bold py-3 rounded-xl hover:bg-blue-700 mt-4 shadow-lg">SAVE ITEM</button>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="fin-view-reports" class="hidden">
                        <div class="bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex flex-wrap gap-4 items-center mb-6">
                            <input type="date" id="repFrom" class="p-2 border rounded bg-gray-50 text-sm"> <input type="date" id="repTo" class="p-2 border rounded bg-gray-50 text-sm">
                            <button onclick="genReport('daybook')" class="px-4 py-2 bg-slate-100 text-slate-800 rounded text-sm font-bold">Day Book</button>
                            <button onclick="genReport('petty')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Petty Cash</button>
                            <button onclick="genReport('pnl')" class="px-4 py-2 bg-green-50 text-green-700 rounded text-sm font-bold">P & L</button>
                            <button onclick="genReport('bs')" class="px-4 py-2 bg-blue-50 text-blue-700 rounded text-sm font-bold">Balance Sheet</button>
                        </div>
                        <div id="reportOutputArea" class="bg-white p-8 rounded-2xl shadow border border-blue-100 min-h-[400px]">
                            <div class="flex justify-between items-center mb-4"><h3 class="font-bold text-gray-400 uppercase tracking-widest text-sm">Report Preview</h3><button onclick="triggerPDFDownload()" class="bg-slate-900 text-white px-4 py-2 rounded-lg text-sm font-bold">Download PDF</button></div>
                            <div id="reportContent" class="overflow-x-auto border rounded-lg p-4 bg-gray-50 text-sm"><p class="text-center text-gray-400 py-10">Select date range & type.</p></div>
                        </div>
                    </div>
                </div>

                <div id="page-settings" class="hidden">
                    <h2 class="text-2xl font-bold text-slate-800 mb-6">System Settings</h2>
                    <div class="bg-white p-8 rounded-2xl shadow-sm border border-blue-100 max-w-md">
                        <h3 class="font-bold text-lg mb-4 text-blue-600">Change Admin Password</h3>
                        <input type="password" id="newAdminPass" placeholder="New Password" class="w-full p-3 border rounded-lg mb-4 focus:ring-blue-500">
                        <button onclick="updatePassword()" class="w-full bg-slate-900 text-white font-bold py-3 rounded-lg hover:bg-slate-800">Update Password</button>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <div id="newProjectModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-6 text-slate-800">Create New Project</h2>
            <input type="text" id="newProjName" placeholder="Project Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="text" id="newProjArea" placeholder="Area / Location" class="w-full p-3 border rounded-lg mb-3">
            <label class="block text-xs font-bold text-gray-500 mb-1">Link Parent Land (Asset)</label>
            <select id="landLinkSelect" class="w-full p-3 border rounded-lg mb-6 text-sm"></select>
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newProjectModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold">Cancel</button>
                <button onclick="createProject()" class="px-6 py-2 bg-blue-900 text-white rounded-lg font-bold shadow hover:bg-blue-800">Create</button>
            </div>
        </div>
    </div>

    <div id="newLandModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h2 class="text-xl font-bold mb-6 text-slate-800">Acquire Land</h2>
            <input type="text" id="landName" placeholder="Land Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="text" id="landSeller" placeholder="Seller Name" class="w-full p-3 border rounded-lg mb-3">
            <input type="number" id="landCost" placeholder="Total Cost" class="w-full p-3 border rounded-lg mb-3" oninput="calcLandAdvance()">
            <label class="block text-xs font-bold text-gray-500 mb-1">Initial Advance Payment (10%)</label>
            <input type="number" id="landAdvance" class="w-full p-3 border rounded-lg mb-6 font-bold text-slate-800">
            <div class="flex justify-end gap-3">
                <button onclick="document.getElementById('newLandModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold">Cancel</button>
                <button onclick="saveLand()" class="px-6 py-2 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700">Acquire</button>
            </div>
        </div>
    </div>

    <div id="newStaffModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-md mx-4 relative">
            <button onclick="document.getElementById('newStaffModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h2 class="text-xl font-bold mb-6 text-slate-800">Staff Member Details</h2>
            <input type="hidden" id="staffMode" value="new">
            <input type="hidden" id="editStaffId" value="">
            <div class="space-y-3">
                <input type="text" id="staffName" placeholder="Full Name" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffNIC" placeholder="NIC Number" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffPhone" placeholder="Phone Number" class="w-full p-3 border rounded-lg">
                <input type="text" id="staffPosition" placeholder="Position (e.g. Sales Agent)" class="w-full p-3 border rounded-lg">
                <input type="number" id="staffSalary" placeholder="Basic Salary" class="w-full p-3 border rounded-lg">
                <input type="number" id="staffFuel" placeholder="Fuel Allowance" class="w-full p-3 border rounded-lg">
                <input type="number" id="staffVehicle" placeholder="Vehicle Allowance" class="w-full p-3 border rounded-lg">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Profile Photo</label>
                    <input type="file" id="staffPhoto" class="w-full text-sm">
                </div>
            </div>
            <button onclick="saveStaff()" id="newStaffBtnText" class="w-full bg-blue-600 text-white font-bold py-3 rounded-lg shadow mt-6 hover:bg-blue-700">Save Member</button>
        </div>
    </div>

    <div id="staffPassChangeModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative">
            <button onclick="document.getElementById('staffPassChangeModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-slate-800">Change Staff Access PIN</h3>
            <div class="space-y-4">
                <input type="password" id="adminAuthPass" placeholder="Admin Password (To Verify)" class="w-full p-3 border rounded-lg text-center">
                <input type="text" id="newStaffPin" placeholder="New Access PIN" class="w-full p-3 border rounded-lg text-center font-bold text-blue-600">
                <button onclick="updateStaffAccessPass()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg shadow hover:bg-yellow-600">Update PIN</button>
            </div>
        </div>
    </div>

    <div id="staffDetailModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm p-4 overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-3xl mx-4 relative shadow-2xl my-8">
            <button onclick="document.getElementById('staffDetailModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <div class="flex flex-col md:flex-row gap-6">
                <div class="w-full md:w-1/3 text-center">
                    <img id="sdPhoto" src="" class="w-24 h-24 rounded-full object-cover mx-auto border-4 border-white shadow-lg bg-gray-200">
                    <h2 id="sdName" class="text-xl font-bold text-slate-800 mt-3"></h2>
                    <p id="sdPosition" class="text-sm font-bold text-blue-500 uppercase tracking-wide"></p>
                    <div class="mt-4 flex flex-col gap-2" id="sdActionBtns"></div>
                </div>
                <div class="w-full md:w-2/3">
                    <div class="bg-gray-50 p-4 rounded-xl space-y-2 text-sm border border-gray-100 mb-4">
                        <div class="flex justify-between"><span class="text-gray-500">NIC</span><span id="sdNIC" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Phone</span><span id="sdPhone" class="font-bold"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Salary</span><span id="sdSalary" class="font-bold text-green-600"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Fuel Allow.</span><span id="sdFuel" class="font-bold text-slate-800"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Vehicle Allow.</span><span id="sdVehicle" class="font-bold text-slate-800"></span></div>
                        <div class="flex justify-between"><span class="text-gray-500">Joined</span><span id="sdJoined" class="font-bold"></span></div>
                    </div>

                    <div id="sdLocationSection" class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-4 !hidden" style="display: none;">
                         <h4 class="font-bold text-sm text-blue-900 mb-2 flex justify-between">
                            <span>Pending Work Location</span>
                            <button onclick="approveStaffLocation()" class="bg-green-600 text-white px-2 py-1 rounded text-xs">Approve</button>
                         </h4>
                         <p class="text-xs text-gray-600 mb-2">Staff has requested a new work location.</p>
                         <a id="sdMapLink" href="#" target="_blank" class="text-blue-600 underline text-xs font-bold">View on Google Maps</a>
                    </div>
                    
                    <div id="sdLeaveSection" class="bg-yellow-50 p-4 rounded-xl border border-yellow-200 mb-4 hidden">
                        <h4 class="font-bold text-sm text-yellow-900 mb-2">Pending Leave Requests</h4>
                        <div id="sdLeaveList" class="space-y-2"></div>
                    </div>
                    
                    <h4 class="font-bold text-sm text-slate-700 mb-2 mt-4 !hidden" style="display: none;">Attendance History</h4>
                    <div class="h-40 overflow-y-auto border rounded-lg p-2 bg-slate-50 text-xs mb-4 !hidden" style="display: none;">
                         <table class="w-full text-left">
                             <thead class="bg-gray-200"><tr class="font-bold"><th>Time</th><th>Type</th><th>Photo</th><th>Action</th></tr></thead>
                             <tbody id="sdAttendanceList"></tbody>
                         </table>
                    </div>

                    <h4 class="font-bold text-sm text-slate-700 mb-2">Earnings History</h4>
                    <div class="h-48 overflow-y-auto border rounded-lg p-2 bg-slate-50 text-xs">
                        <table class="w-full text-left">
                            <tbody id="sdEarningsList"></tbody>
                        </table>
                    </div>
                    <div class="mt-2 text-right text-sm font-bold">Total Earnings: <span id="sdTotalEarnings" class="text-green-600">Rs. 0.00</span></div>
                </div>
            </div>
        </div>
    </div>
    
    <div id="taskApproveModal" class="hidden fixed inset-0 bg-black/80 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl w-full max-w-4xl overflow-hidden shadow-2xl flex flex-col max-h-[90vh]">
            <div class="p-6 border-b flex justify-between items-center bg-gray-50">
                <h2 class="text-xl font-bold text-slate-800" id="taskModalHeader">Review</h2>
                <button onclick="document.getElementById('taskApproveModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <h3 id="approveTaskTitle" class="text-2xl font-bold text-slate-800 mb-2"></h3>
                <p class="text-lg mb-4">Cost: <span id="approveTaskCost" class="font-bold text-green-600 text-2xl"></span></p>
                <p class="text-sm mb-4 bg-yellow-50 p-2 rounded border border-yellow-200" id="approveTaskTimeInfo"></p>
                <div id="approveTaskPhotos" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
            </div>
            <div class="p-6 border-t bg-gray-50 flex justify-end gap-3">
                <button id="managerApproveTaskBtn" class="px-8 py-3 bg-yellow-500 text-white rounded-lg font-bold shadow hover:bg-yellow-600 hidden">MANAGER APPROVE</button>
                <button id="confirmApproveTaskBtn" class="px-8 py-3 bg-green-600 text-white rounded-lg font-bold shadow hover:bg-green-700 hidden">ADMIN APPROVE</button>
            </div>
        </div>
    </div>

    <div id="newTaskModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-md mx-4">
            <h3 class="font-bold text-lg mb-4">Assign Site Task</h3>
            <input type="text" id="newTaskTitle" placeholder="Task Title" class="w-full p-2 border rounded mb-2">
            <textarea id="newTaskDesc" placeholder="Description" class="w-full p-2 border rounded mb-2"></textarea>
            <input type="file" id="taskPhoto" class="w-full text-xs mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('newTaskModal').classList.add('hidden')" class="px-3 py-1 text-gray-500">Cancel</button>
                <button id="saveTaskBtn" class="px-4 py-1 bg-slate-800 text-white rounded font-bold">Assign</button>
            </div>
        </div>
    </div>

    <div id="expenseModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="font-bold text-lg mb-4 text-red-600">Add Miscellaneous Expense</h3>
            <input type="text" id="expDesc" placeholder="Description" class="w-full p-2 border rounded mb-2">
            <input type="number" id="expAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4">
            <div class="flex justify-end gap-2">
                <button onclick="document.getElementById('expenseModal').classList.add('hidden')" class="px-3 py-1 text-gray-500">Cancel</button>
                <button id="saveExpenseBtn" class="px-4 py-1 bg-red-600 text-white rounded font-bold">Save</button>
            </div>
        </div>
    </div>

    <div id="landPaymentModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl shadow-2xl w-full max-w-sm mx-4">
            <h3 class="font-bold text-lg mb-2">Land Payment</h3>
            <p id="landPayInfo" class="text-xs text-gray-500 mb-4"></p>
            <input type="date" id="landPayDate" class="w-full p-2 border rounded mb-2">
            <input type="number" id="landPayAmount" placeholder="Amount" class="w-full p-2 border rounded mb-4">
            <button onclick="submitLandPayment()" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Submit Payment</button>
            <button onclick="document.getElementById('landPaymentModal').classList.add('hidden')" class="w-full mt-2 text-gray-500 text-xs">Cancel</button>
        </div>
    </div>
    
    <div id="paymentModal" class="hidden fixed inset-0 bg-black/60 z-50 flex items-center justify-center overflow-y-auto">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl mx-4 my-10 shadow-2xl relative modal-content-scroll">
            <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <div class="flex justify-between items-start mb-4 border-b pb-4">
                <div>
                    <h2 class="text-2xl font-bold text-slate-800">Payment Record</h2>
                    <p class="text-blue-700 font-bold text-sm flex items-center">
                        <span id="payBlockInfo"></span>
                        <button onclick="openEditBlockModal()" class="ml-2 text-gray-400 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button>
                    </p>
                </div>
                <div class="flex flex-col items-end gap-1"><button id="editPlanBtn" class="text-xs text-blue-600 underline font-bold" onclick="toggleEditPlan()">Edit Interest/Plan</button><button id="resellBtn" class="hidden text-xs bg-red-100 text-red-600 px-3 py-1 rounded font-bold hover:bg-red-200" onclick="processResell()">CANCEL & RESELL</button></div>
            </div>
            
            <div id="editPlanSection" class="hidden bg-gray-100 p-4 rounded-xl mb-4 border border-gray-200">
                <h4 class="font-bold text-xs text-gray-500 uppercase mb-2">Edit Payment Plan</h4>
                <div class="flex gap-2 mb-2">
                    <input type="number" id="editNewRate" placeholder="New Rate %" class="w-1/2 p-2 border rounded text-sm">
                    <input type="number" id="editNewMonths" placeholder="New Months" class="w-1/2 p-2 border rounded text-sm">
                </div>
                <button id="savePlanChangesBtn" class="w-full bg-blue-600 text-white font-bold py-2 rounded text-sm hover:bg-blue-700">Save Changes</button>
            </div>
            
            <div id="epCycleSection" class="hidden mb-6">
                <div class="flex justify-between items-end mb-1">
                    <span id="cycleStatusLabel" class="text-[10px] font-bold uppercase tracking-wider text-blue-600">Cycle Progress</span>
                    <span id="cycleDaysLeft" class="text-[10px] font-bold text-gray-500"></span>
                </div>
                <div class="w-full bg-gray-200 h-3 rounded-full overflow-hidden relative">
                    <div id="cycleProgressBar" class="h-full progress-bar-fill bg-blue-500" style="width: 0%"></div>
                </div>
                
                 <div id="epPreStageInfo" class="mt-4 grid grid-cols-2 gap-4 text-xs bg-yellow-50 p-3 rounded border border-yellow-200">
                     <div>
                         <span class="block font-bold text-gray-500">DOWN PAYMENT (40%)</span>
                         <span id="epDpTarget" class="font-bold text-slate-800"></span>
                     </div>
                     <div class="text-right">
                         <span class="block font-bold text-gray-500">PAID SO FAR</span>
                         <span id="epDpPaid" class="font-bold text-green-600"></span>
                     </div>
                     <div class="col-span-2 border-t border-yellow-200 pt-1 text-center font-bold text-red-600" id="epDpDueMsg"></div>
                 </div>

                <div id="epInstallmentInfo" class="hidden mt-4">
                     <div class="flex gap-2">
                         <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase">Current Rate</span><span id="dispRate" class="text-xs font-bold text-blue-700 ml-1"></span></div>
                         <div class="bg-blue-50 px-2 py-1 rounded border border-blue-100"><span class="text-[9px] font-bold text-blue-400 uppercase">Plan Period</span><span id="dispMonths" class="text-xs font-bold text-blue-700 ml-1"></span></div>
                    </div>
                    <div class="mt-3 grid grid-cols-2 gap-4">
                        <div class="bg-indigo-50 p-2 rounded-lg border border-indigo-100">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase">This Month Payable</p>
                            <p class="text-xl font-bold text-indigo-700" id="epNextDueAmt">Rs. 0.00</p>
                        </div>
                        <div class="bg-indigo-50 p-2 rounded-lg border border-indigo-100">
                            <p class="text-[10px] font-bold text-indigo-400 uppercase">Next Month Payable</p>
                            <p class="text-xl font-bold text-indigo-700" id="epFutureDueAmt">Rs. 0.00</p>
                        </div>
                    </div>
                    <div class="flex justify-between items-center mt-2 text-xs text-gray-500 border-t pt-2">
                        <span class="font-bold text-red-500 uppercase">Settlement Balance (Today):</span>
                        <span id="epRealtimeFuture" class="font-bold text-red-600 text-sm"></span>
                    </div>
                </div>
            </div>

            <div id="cusDetailsSection" class="bg-gray-50 p-3 rounded-lg border border-gray-200 mb-4 text-sm">
                <h4 class="font-bold text-gray-400 text-xs uppercase mb-2">Customer Details</h4>
                <div class="grid grid-cols-2 gap-2">
                    <p><i class="fas fa-id-badge mr-2 text-blue-500"></i> <span id="viewCusId" class="font-bold text-slate-800"></span></p>
                    <p><i class="fas fa-id-card mr-2 text-gray-400"></i> <span id="viewCusNIC" class="font-medium"></span></p>
                    <p><i class="fas fa-phone mr-2 text-gray-400"></i> <span id="viewCusPhone" class="font-medium"></span></p>
                    <p class="col-span-2"><i class="fas fa-map-marker-alt mr-2 text-gray-400"></i> <span id="viewCusAddr" class="font-medium text-gray-600"></span></p>
                </div>
            </div>
            
             <div class="grid grid-cols-3 gap-4 mb-6 text-center">
                <div class="p-3 bg-slate-100 rounded-lg"><p class="text-[10px] uppercase font-bold text-gray-500">Payable</p><p id="pmTotal" class="font-bold text-slate-800 text-lg">0.00</p></div>
                <div class="p-3 bg-green-50 rounded-lg border border-green-100"><p class="text-[10px] uppercase font-bold text-green-600">Paid</p><p id="pmPaid" class="font-bold text-green-700 text-lg">0.00</p></div>
                <div class="p-3 bg-red-50 rounded-lg border border-red-100"><p class="text-[10px] uppercase font-bold text-red-600">Balance</p><p id="pmBalance" class="font-bold text-red-700 text-lg">0.00</p></div>
            </div>

            <div id="addPaymentSection" class="bg-slate-50 p-4 rounded-xl mb-6 border border-gray-200">
                <div class="flex gap-3 mb-2"><input type="date" id="newPayDate" class="w-1/3 p-2 border rounded text-sm"><input type="number" id="newPayAmount" placeholder="Amount" class="w-1/3 p-2 border rounded text-sm font-bold text-slate-800"><button id="submitPayBtn" class="w-1/3 bg-green-600 text-white rounded font-bold text-sm shadow hover:bg-green-700">ADD PAYMENT</button></div>
                <div class="flex justify-end gap-2 mt-2">
                    <button onclick="downloadPaymentReceipt()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-receipt mr-1"></i> Receipt</button>
                    <button onclick="downloadPaymentHistory()" class="text-xs bg-slate-200 px-3 py-1 rounded hover:bg-slate-300 font-bold"><i class="fas fa-history mr-1"></i> Report</button>
                </div>
            </div>
            <div id="paymentCompleteMsg" class="hidden bg-green-100 text-green-800 p-4 rounded-xl text-center font-bold mb-6 border border-green-200"><i class="fas fa-check-circle mr-2"></i> FULLY PAID & CLOSED</div>
            <h3 class="font-bold text-xs text-gray-400 uppercase mb-2">History</h3>
            <div class="overflow-y-auto max-h-40 border rounded-lg"><table class="w-full text-xs text-left"><tbody id="paymentHistoryList" class="divide-y"></tbody></table></div>
        </div>
    </div>

    <div id="newProjectReportDataModal" class="hidden fixed inset-0 bg-black/90 z-[70] flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white rounded-2xl w-full max-w-4xl h-[90vh] flex flex-col shadow-2xl overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-slate-50">
                <h2 class="text-xl font-bold text-slate-800"><i class="fas fa-file-contract mr-2 text-blue-600"></i>Project Report Data Configuration</h2>
                <button onclick="document.getElementById('newProjectReportDataModal').classList.add('hidden')" class="text-gray-400 hover:text-red-500 transition"><i class="fas fa-times text-2xl"></i></button>
            </div>
            
            <div class="flex-1 overflow-y-auto p-8 bg-gray-50/50">
                <div class="flex flex-col gap-6">
                    
                    <div class="report-form-section">
                        <div class="section-header">
                            <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">1. Basic Information</h3>
                            <button onclick="addCustomField('basic')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                            <div><label class="block text-xs font-bold text-gray-500">Project Name</label><input id="rpt_name" class="w-full p-2 border rounded bg-gray-100 font-bold" readonly></div>
                            <div><label class="block text-xs font-bold text-gray-500">Location</label><input id="rpt_location" class="w-full p-2 border rounded bg-gray-100" readonly></div>
                        </div>
                        <div class="mb-4"><label class="block text-xs font-bold text-gray-500">Land Owner</label><input id="rpt_owner" class="w-full p-2 border rounded focus:ring-blue-500"></div>
                        <div class="mb-4"><label class="block text-xs font-bold text-gray-500">Introducer</label><input id="rpt_introducer" class="w-full p-2 border rounded focus:ring-blue-500"></div>
                        <h4 class="font-bold text-xs text-slate-700 mt-4 mb-2">Land Extent</h4>
                        <div class="flex gap-2">
                            <input type="number" id="rpt_acres" placeholder="A" class="w-full p-2 border rounded text-center" oninput="calcReportTotals()">
                            <input type="number" id="rpt_roods" placeholder="R" class="w-full p-2 border rounded text-center" oninput="calcReportTotals()">
                            <input type="number" id="rpt_perches" placeholder="P" class="w-full p-2 border rounded text-center" oninput="calcReportTotals()">
                        </div>
                        <div class="mt-2 text-right text-xs font-bold text-blue-600">Total: <input id="rpt_tot_perches" class="w-20 text-right bg-transparent border-none font-bold" readonly> P</div>
                        <div id="custom_basic_container" class="mt-4 space-y-2"></div>
                    </div>

                    <div class="report-form-section">
                        <div class="section-header">
                            <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">2. Purchase Cost</h3>
                            <button onclick="addCustomField('purchase')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-plus"></i></button>
                        </div>
                        <div class="mb-2"><label class="block text-xs font-bold text-gray-500">Purchase Price</label><input type="number" id="rpt_purchase_price" class="w-full p-2 border rounded font-bold text-slate-800" oninput="calcReportTotals()"></div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                            <div><label class="block text-xs font-bold text-gray-500">Agreed Value</label><input id="rpt_agreed_val" class="w-full p-2 border rounded bg-gray-100" readonly></div>
                            <div><label class="block text-xs font-bold text-gray-500">Price/Perch</label><input id="rpt_agreed_pp" class="w-full p-2 border rounded bg-gray-100" readonly></div>
                        </div>
                        <div class="space-y-2 mt-4">
                            <div class="flex items-center gap-2"><span class="text-xs w-24">Title Ins %</span><input type="number" id="rpt_title_ins_pct" class="w-16 p-1 border rounded text-center" oninput="calcReportTotals()"><input id="rpt_title_ins" class="flex-1 p-1 border rounded bg-gray-100 text-right" readonly></div>
                            <div class="flex items-center gap-2"><span class="text-xs w-24">Stamp Duty %</span><input type="number" id="rpt_stamp_pct" class="w-16 p-1 border rounded text-center" oninput="calcReportTotals()"><input id="rpt_stamp" class="flex-1 p-1 border rounded bg-gray-100 text-right" readonly></div>
                            <div class="flex items-center gap-2"><span class="text-xs w-24">Legal Fees %</span><input type="number" id="rpt_legal_pct" class="w-16 p-1 border rounded text-center" oninput="calcReportTotals()"><input id="rpt_legal" class="flex-1 p-1 border rounded bg-gray-100 text-right" readonly></div>
                            <div class="flex items-center gap-2"><span class="text-xs w-24">Valuation %</span><input type="number" id="rpt_val_pct" class="w-16 p-1 border rounded text-center" oninput="calcReportTotals()"><input id="rpt_valuation" class="flex-1 p-1 border rounded bg-gray-100 text-right" readonly></div>
                            <div class="flex items-center gap-2"><span class="text-xs w-24 font-bold">Title Reports</span><input type="number" id="rpt_title_rep" class="flex-1 p-1 border rounded text-right"></div>
                            <div class="flex items-center gap-2"><span class="text-xs w-24 font-bold">Intro Comm.</span><input type="number" id="rpt_intro_comm" class="flex-1 p-1 border rounded text-right"></div>
                        </div>
                        <div id="custom_purchase_container" class="mt-4 space-y-2"></div>
                    </div>

                    <div class="report-form-section">
                        <h3 class="font-bold text-blue-900 border-b pb-2 mb-4 text-sm uppercase tracking-wide">3. Land Allocation</h3>
                        <div class="flex gap-4">
                            <div><label class="block text-xs font-bold text-gray-500">Roads %</label><input type="number" id="rpt_road_pct" class="w-full p-2 border rounded" oninput="calcReportTotals()"></div>
                            <div><label class="block text-xs font-bold text-gray-500">Reservation %</label><input type="number" id="rpt_res_pct" class="w-full p-2 border rounded" oninput="calcReportTotals()"></div>
                            <div><label class="block text-xs font-bold text-blue-600">Sellable %</label><input id="rpt_sell_pct" class="w-full p-2 border rounded bg-blue-50 font-bold" readonly></div>
                        </div>
                        <div class="mt-2"><label class="block text-xs font-bold text-gray-500">Project Period (Months)</label><input type="number" id="rpt_period" class="w-full p-2 border rounded"></div>
                    </div>

                    <div class="report-form-section">
                        <div class="flex justify-between items-center border-b pb-2 mb-4">
                            <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">4. Survey Costs</h3>
                            <span class="text-xs font-bold text-slate-500">Total: <span id="rpt_survey_total_disp">0</span></span>
                        </div>
                        <div id="surveyRows" class="space-y-3 text-xs"></div>
                    </div>

                    <div class="report-form-section">
                        <div class="section-header">
                            <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">5. Development</h3>
                            <div class="flex gap-2 items-center">
                                <button onclick="addDevCategory()" class="text-xs bg-slate-100 px-2 py-1 rounded hover:bg-slate-200">+ Cat</button>
                                <span class="text-xs font-bold text-slate-500">Total: <span id="rpt_dev_total_disp">0</span></span>
                            </div>
                        </div>
                        <div id="devCostContainer" class="space-y-2"></div>
                    </div>

                    <div class="report-form-section">
                         <div class="section-header">
                             <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">6-7. Cost of Sales & Ads</h3>
                             <button onclick="addCustomField('ads')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-plus"></i></button>
                         </div>
                         <div class="mb-2 text-right text-xs font-bold">Total: <span id="rpt_ads_total_disp">0</span></div>
                         <div id="custom_ads_container" class="space-y-2"></div>
                    </div>

                    <div class="report-form-section">
                         <div class="section-header">
                             <h3 class="font-bold text-blue-900 text-sm uppercase tracking-wide">Taxes & Approvals</h3>
                             <button onclick="addCustomField('taxes')" class="text-xs bg-blue-100 text-blue-600 px-2 py-1 rounded hover:bg-blue-200"><i class="fas fa-plus"></i></button>
                         </div>
                         <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-xs mb-4">
                             <div class="col-span-1 md:col-span-2 text-right font-bold">Total: <span id="rpt_taxes_total_disp">0</span></div>
                             <div class="col-span-1 md:col-span-2" id="custom_taxes_container"></div>
                             <div><label>PS Tax</label><input type="number" id="rpt_tax_ps" class="w-full p-1 border rounded" oninput="calcReportTotals()"></div>
                             <div><label>Plan Tax</label><input type="number" id="rpt_tax_plan" class="w-full p-1 border rounded" oninput="calcReportTotals()"></div>
                             <div><label>Ad Cost</label><input type="number" id="rpt_ad_cost" class="w-full p-1 border rounded" oninput="calcReportTotals()"></div>
                             <div><label>Fin. Capital</label><input type="number" id="rpt_fin_cap" class="w-full p-1 border rounded" oninput="calcReportTotals()"></div>
                             <div><label>Fin. VAT</label><input type="number" id="rpt_fin_vat" class="w-full p-1 border rounded" oninput="calcReportTotals()"></div>
                         </div>
                         <div class="border-t pt-2">
                             <label class="block text-[10px] font-bold text-gray-400 mb-1">Signatories</label>
                             <div class="flex gap-2">
                                 <input type="text" id="rpt_sig_mgr" placeholder="Manager" class="w-1/3 p-1 border rounded text-xs">
                                 <input type="text" id="rpt_sig_dir" placeholder="Director" class="w-1/3 p-1 border rounded text-xs">
                                 <input type="text" id="rpt_sig_chm" placeholder="Chairman" class="w-1/3 p-1 border rounded text-xs">
                             </div>
                         </div>
                    </div>
                </div>
            </div>

            <div class="p-4 border-t bg-slate-50 flex justify-end gap-3 z-10">
                <button onclick="document.getElementById('newProjectReportDataModal').classList.add('hidden')" class="px-6 py-2 rounded-lg text-slate-600 font-bold hover:bg-slate-200">Close</button>
                <button onclick="saveReportData()" class="px-8 py-2 rounded-lg bg-blue-600 text-white font-bold shadow hover:bg-blue-700">Save Report Data</button>
            </div>
        </div>
    </div>

    <div id="sellModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4 backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-2xl shadow-2xl relative my-8 max-h-[90vh] overflow-y-auto">
            <button onclick="closeSellModal()" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times text-xl"></i></button>
            <h2 class="text-xl font-bold mb-4 text-slate-800">
                New Sale: <span id="sellBlockName" class="text-blue-600"></span>
                <button onclick="openEditBlockModal()" class="ml-2 text-gray-400 hover:text-blue-600"><i class="fas fa-pencil-alt"></i></button>
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Customer Name</label>
                    <input type="text" id="cusName" class="w-full p-2 border rounded" placeholder="Full Name">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">NIC Number</label>
                    <input type="text" id="cusNIC" class="w-full p-2 border rounded" placeholder="National ID">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Phone Number</label>
                    <input type="text" id="cusPhone" class="w-full p-2 border rounded" placeholder="Contact">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 mb-1">Address</label>
                    <input type="text" id="cusAddress" class="w-full p-2 border rounded" placeholder="Current Address">
                </div>
            </div>

            <div class="bg-blue-50 p-4 rounded-xl border border-blue-100 mb-4">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-blue-900">Final Selling Price</label>
                    <input type="number" id="finalPrice" class="p-2 border rounded font-bold text-right text-blue-700 w-40" oninput="calculateEP()" step="0.01">
                </div>
                
                <div class="flex justify-between items-center mb-2">
                     <label class="text-xs font-bold text-gray-500">Sales Person</label>
                     <div class="dropdown w-48 relative">
                         <input type="text" id="salesPersonInput" class="w-full p-2 border rounded text-xs" placeholder="Search..." onkeyup="filterSalesFunction()" onclick="toggleSalesDropdown()">
                         <div id="salesDropdown" class="dropdown-content"></div>
                     </div>
                </div>

                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-500">Payment Plan</label>
                    <select id="payPlanType" class="p-2 border rounded text-sm w-40" onchange="toggleEPFields()">
                        <option value="Cash">Cash Sale</option>
                        <option value="EP">Easy Payment (EP)</option>
                    </select>
                </div>
                
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-500">Plan Fee (Doc/Legal)</label>
                    <input type="number" id="planFee" class="p-2 border rounded text-sm text-right w-40" value="0" step="0.01">
                </div>
                 <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-gray-500">Deed/Transfer Fee</label>
                    <input type="number" id="deedFee" class="p-2 border rounded text-sm text-right w-40" value="0" step="0.01">
                </div>
            </div>

            <div id="cashFields">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-sm font-bold text-gray-700">Initial Payment</label>
                    <input type="number" id="cashAdvancePay" class="p-2 border rounded font-bold text-right w-40" placeholder="Amount" step="0.01">
                </div>
            </div>

            <div id="epFields" class="hidden space-y-3 bg-yellow-50 p-3 rounded-lg border border-yellow-200">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Agreement Fee</label>
                    <input type="number" id="agreementFee" class="p-1 border rounded text-right w-32 text-sm" value="15000" step="0.01">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Booking Fee</label>
                    <input type="number" id="bookingFee" class="p-1 border rounded text-right w-32 text-sm" oninput="calculateEP()" step="0.01">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Down Payment %</label>
                    <input type="number" id="downPayPct" class="p-1 border rounded text-right w-32 text-sm" value="40" oninput="calculateEP()">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Down Payment Amount</label>
                    <input type="number" id="downPayAmount" class="p-1 border rounded text-right w-32 text-sm bg-gray-100" readonly>
                </div>
                <div class="flex justify-between items-center">
                     <label class="text-xs font-bold text-red-500">Balance for Down Payment</label>
                     <span id="downPayBalanceDisp" class="font-bold text-red-600">0.00</span>
                </div>
                <hr class="border-yellow-200">
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Loan Amount</label>
                    <input type="text" id="loanAmount" class="p-1 border rounded text-right w-32 text-sm bg-gray-100" readonly>
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Interest Rate (%)</label>
                    <input type="number" id="epRate" class="p-1 border rounded text-right w-32 text-sm" value="18" oninput="calculateEP()">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Period (Months)</label>
                    <input type="number" id="epMonths" class="p-1 border rounded text-right w-32 text-sm" value="24" oninput="calculateEP()">
                </div>
                <div class="flex justify-between items-center">
                    <label class="text-xs font-bold text-gray-500">Payment Cycle (Days)</label>
                    <input type="number" id="epCycle" class="p-1 border rounded text-right w-32 text-sm" value="30">
                </div>
                <div class="bg-white p-2 rounded border mt-2 text-center">
                    <p class="text-xs font-bold text-gray-500">Monthly Installment</p>
                    <p id="epMonthlyInst" class="text-lg font-bold text-blue-600">0.00</p>
                    <p class="text-[10px] text-gray-400">Total Payable: <span id="epTotalPayable">0.00</span></p>
                </div>
            </div>

            <div class="flex gap-2 mt-6">
                <button onclick="processSale(false, this)" class="flex-1 bg-slate-800 text-white font-bold py-3 rounded-lg hover:bg-slate-900">CONFIRM SALE</button>
                <button onclick="processSale(true, this)" class="flex-1 bg-green-600 text-white font-bold py-3 rounded-lg hover:bg-green-700"><i class="fas fa-print mr-2"></i> SALE & RECEIPT</button>
            </div>
        </div>
    </div>

    <div id="staffAccessModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center shadow-2xl">
             <h3 class="text-xl font-bold mb-4 text-slate-800">Staff Area Access</h3>
             <p class="text-sm text-gray-500 mb-4">Enter Access PIN to continue</p>
             <input type="password" id="staffAccessInput" class="w-full text-center text-2xl tracking-widest p-2 border rounded-lg mb-4 font-bold">
             <div class="flex gap-2">
                 <button onclick="document.getElementById('staffAccessModal').classList.add('hidden')" class="flex-1 py-2 text-gray-500 font-bold border rounded">Cancel</button>
                 <button onclick="verifyStaffAccess()" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded shadow">Verify</button>
             </div>
        </div>
    </div>
    
    <div id="financeAccessModal" class="hidden fixed inset-0 bg-black/80 z-[100] flex items-center justify-center p-4">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm text-center shadow-2xl">
             <h3 class="text-xl font-bold mb-4 text-slate-800">Finance Area Access</h3>
             <p class="text-sm text-gray-500 mb-4">Enter Access Password to continue</p>
             <input type="password" id="financeAccessInput" class="w-full text-center text-2xl tracking-widest p-2 border rounded-lg mb-4 font-bold">
             <div class="flex gap-2">
                 <button onclick="document.getElementById('financeAccessModal').classList.add('hidden')" class="flex-1 py-2 text-gray-500 font-bold border rounded">Cancel</button>
                 <button onclick="verifyFinanceAccess()" class="flex-1 py-2 bg-blue-600 text-white font-bold rounded shadow">Verify</button>
             </div>
        </div>
    </div>

    <div id="editBlockModal" class="hidden fixed inset-0 bg-black/50 z-[80] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-6 rounded-2xl w-full max-w-sm mx-4 shadow-2xl">
            <h3 class="font-bold text-lg mb-4 text-slate-800">Edit Block Details</h3>
            <input type="hidden" id="editBlockId">
            <div class="space-y-3">
                <div><label class="text-xs font-bold text-gray-500">Block Name</label><input type="text" id="editBName" class="w-full p-2 border rounded"></div>
                <div><label class="text-xs font-bold text-gray-500">Size (Perches)</label><input type="number" id="editBSize" class="w-full p-2 border rounded" step="0.01"></div>
                <div><label class="text-xs font-bold text-gray-500">Base Price</label><input type="number" id="editBPrice" class="w-full p-2 border rounded" step="0.01"></div>
            </div>
            <div class="flex justify-end gap-2 mt-6">
                <button onclick="document.getElementById('editBlockModal').classList.add('hidden')" class="px-4 py-2 text-gray-500 font-bold">Cancel</button>
                <button onclick="saveBlockChanges()" class="px-6 py-2 bg-blue-600 text-white rounded font-bold shadow hover:bg-blue-700">Save Changes</button>
            </div>
        </div>
    </div>

    <div id="financePassChangeModal" class="hidden fixed inset-0 bg-black/50 z-[60] flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white p-8 rounded-2xl shadow-2xl w-full max-w-sm mx-4 relative">
            <button onclick="document.getElementById('financePassChangeModal').classList.add('hidden')" class="absolute top-4 right-4 text-gray-400 hover:text-red-500"><i class="fas fa-times"></i></button>
            <h3 class="text-lg font-bold mb-4 text-slate-800">Change Finance Access Password</h3>
            <div class="space-y-4">
                <input type="password" id="finAdminAuthPass" placeholder="Admin Password (To Verify)" class="w-full p-3 border rounded-lg text-center">
                <input type="text" id="newFinancePass" placeholder="New Finance Password" class="w-full p-3 border rounded-lg text-center font-bold text-blue-600">
                <button onclick="updateFinanceAccessPass()" class="w-full bg-yellow-500 text-white font-bold py-3 rounded-lg shadow hover:bg-yellow-600">Update Password</button>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getFirestore, collection, collectionGroup, addDoc, deleteDoc, onSnapshot, query, where, orderBy, doc, updateDoc, arrayUnion, getDoc, getDocs, serverTimestamp, setDoc, deleteField } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

        // Constants and Globals
        let cInc = 0, cExp = 0;
        let currentProjId = null; 
        let currentProjName = ""; 
        let selectedBlockId = null; 
        let selectedBlockData = null;
        let currentProjUnsub = null;
        let projectTasksData = {};
        let staffListCache = [];
        let selectedLandId = null; 
        let selectedLandBal = 0;   
        let customerCache = []; 
        let currentStaffDetailId = null; 
        let notifState = { overdue: [], tasks: [], meter: [], leaves: [] };
        const apiKey = ""; 

        const firebaseConfig = {
            apiKey: "AIzaSyAlhMTQ-_sorFg_0ULpjf9kvjuIAWQkDVY",
            authDomain: "land-4d291.firebaseapp.com",
            projectId: "land-4d291",
            storageBucket: "land-4d291.firebasestorage.app",
            messagingSenderId: "1002505362762",
            appId: "1:1002505362762:web:f30e7ba82d8a344670f5b3",
            measurementId: "G-2EEQPP29VR"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let globalReportConfig = {
            customFields: { basic: [], purchase: [], taxes: [], ads: [] },
            devCategories: ["Fencing", "Site Office", "Clearing", "Road Construction", "Boundaries/Boards", "Drainage", "Culverts", "Site Development", "Water Supply", "Electricity Supply", "Staff Expenses"],
            surveyRows: [
                {desc: "Perimeter survey (per acher)", unit: 0, price: 20000},
                {desc: "Blocking out of plan (per block)", unit: 0, price: 3500},
                {desc: "Demarcation of boundaries (per block)", unit: 0, price: 5000},
                {desc: "Roads and Drains demarcation", unit: 0, price: 7500},
                {desc: "Re demarcation of boundaries (Days)", unit: 0, price: 7500}
            ]
        };

        window.toggleSidebar = () => {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            if (sidebar.classList.contains('-translate-x-full')) {
                sidebar.classList.remove('-translate-x-full');
                overlay.classList.remove('hidden');
            } else {
                sidebar.classList.add('-translate-x-full');
                overlay.classList.add('hidden');
            }
        };

        window.nav = (pageId) => {
            const pages = ['attendance', 'projects', 'lands', 'staff', 'readings', 'reports', 'settings', 'detail'];
            pages.forEach(p => {
                const el = document.getElementById('page-' + p);
                if(el) el.classList.add('hidden');
            });
            const target = document.getElementById('page-' + pageId);
            if(target) target.classList.remove('hidden');

            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('bg-blue-900/50', 'text-blue-400', 'border-blue-800'));
            const navBtn = document.getElementById('nav-' + pageId);
            if(navBtn) navBtn.classList.add('bg-blue-900/50', 'text-blue-400', 'border-blue-800');

            if(window.innerWidth < 768) {
                const sb = document.getElementById('sidebar');
                if(sb && !sb.classList.contains('-translate-x-full')) window.toggleSidebar();
            }

            if(pageId === 'attendance') {
                window.loadGlobalAttendance();
            }
        };

        window.openFinanceAccess = () => { 
            document.getElementById('financeAccessModal').classList.remove('hidden'); 
            document.getElementById('financeAccessInput').focus(); 
        };

        window.verifyFinanceAccess = async () => { 
            const input = document.getElementById('financeAccessInput').value; 
            const btn = document.querySelector('#financeAccessModal button.bg-blue-600');
            const originalText = btn.innerText;
            
            btn.innerText = "Verifying...";
            btn.disabled = true;

            let pass = "sandeep"; 
            
            try { 
                const s = await getDoc(doc(db, "settings", "finance_config")); 
                if(s.exists() && s.data().accessPassword) {
                    pass = s.data().accessPassword; 
                }
            } catch(e) {
                console.error("Auth Check Failed:", e);
            } 
            
            btn.innerText = originalText;
            btn.disabled = false;
            
            if (input === pass) {
                document.getElementById('financeAccessModal').classList.add('hidden');
                document.getElementById('financeAccessInput').value = "";
                nav('reports'); 
            } else {
                alert("Invalid Access Password");
            }
        };

        window.updateFinanceAccessPass = async () => { 
            const adminPass = document.getElementById('finAdminAuthPass').value; 
            const newPass = document.getElementById('newFinancePass').value; 
            let correct = "Sandeep@1116"; 
            
            try { 
                const snap = await getDoc(doc(db, "settings", "config")); 
                if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword; 
            } catch(e) {} 
            
            if(adminPass !== correct) return alert("Admin Password Incorrect"); 
            
            await setDoc(doc(db, "settings", "finance_config"), { accessPassword: newPass }, { merge: true }); 
            document.getElementById('financePassChangeModal').classList.add('hidden'); 
            
            document.getElementById('finAdminAuthPass').value = '';
            document.getElementById('newFinancePass').value = '';
            alert("Finance Password Updated!"); 
        };

        window.subTab = (tabId) => {
            const views = ['overview', 'tasks', 'finance'];
            views.forEach(v => document.getElementById('view-' + v).classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.sub-tab').forEach(b => b.classList.remove('text-slate-800', 'border-b-2', 'border-blue-800'));
            document.getElementById('st-' + tabId).classList.add('text-slate-800', 'border-b-2', 'border-blue-800');
        };

        window.toggleNotifPanel = () => { 
            const p = document.getElementById('notifPanel');
            if (p) p.classList.toggle('hidden'); 
        };
        window.closeImgModal = () => document.getElementById('imgModal').classList.add('hidden');
        
        window.openExpenseModal = () => {
            const modal = document.getElementById('expenseModal');
            if (modal) modal.classList.remove('hidden');
        };

        window.closeSellModal = () => document.getElementById('sellModal').classList.add('hidden');
        
        window.openNewProjectModal = async () => {
             const modal = document.getElementById('newProjectModal');
             if(modal) modal.classList.remove('hidden');
             const landSelect = document.getElementById('landLinkSelect');
             if(landSelect) {
                 landSelect.innerHTML = '<option value="">Select Land...</option>';
                 const snap = await getDocs(collection(db, "company_lands"));
                 snap.forEach(d => {
                     const l = d.data();
                     if (!l.linkedProjectId) {
                         landSelect.innerHTML += `<option value="${d.id}">${l.name}</option>`;
                     }
                 });
             }
        };

        window.switchFinTab = (tab) => {
            document.getElementById('fin-view-entry').classList.add('hidden');
            document.getElementById('fin-view-reports').classList.add('hidden');
            document.getElementById('ft-entry').classList.remove('border-blue-800', 'text-slate-800');
            document.getElementById('ft-reports').classList.remove('border-blue-800', 'text-slate-800');
            document.getElementById('ft-entry').classList.add('text-gray-400');
            document.getElementById('ft-reports').classList.add('text-gray-400');
            document.getElementById('fin-view-' + tab).classList.remove('hidden');
            const btn = document.getElementById('ft-' + tab);
            btn.classList.add('border-blue-800', 'text-slate-800');
            btn.classList.remove('text-gray-400');
        };

        window.updatePassword = async () => {
            const newPass = document.getElementById('newAdminPass').value;
            if (!newPass) return alert("Please enter a new password.");
            try {
                await setDoc(doc(db, "settings", "config"), { adminPassword: newPass }, { merge: true });
                alert("Admin Password Updated Successfully!");
                document.getElementById('newAdminPass').value = "";
            } catch (error) {
                console.error("Error updating password:", error);
                alert("Failed to update password.");
            }
        };

        window.loadStaff = async () => { 
            const grid = document.getElementById('staffGrid'); 
            const dropdown = document.getElementById('salesDropdown'); 
            if(!grid) return; 
            
            onSnapshot(collection(db, "staff"), (snap) => { 
                grid.innerHTML = ""; 
                if(dropdown) dropdown.innerHTML = ""; 
                staffListCache = []; 
                const today = new Date(); 
                const curMonthKey = `${today.getFullYear()}_${today.getMonth() + 1}`; 
                
                if(snap.empty) { 
                    grid.innerHTML = "<p class='text-gray-500 p-4'>No staff members found.</p>"; 
                    return; 
                } 
                
                snap.forEach(d => { 
                    const s = d.data(); 
                    s.id = d.id; 
                    staffListCache.push(s); 
                    const photo = s.photo || `https://ui-avatars.com/api/?name=${s.name}&background=eff6ff&color=1e3a8a&rounded=true&bold=true`;
                    const isPaid = s.lastPaidMonth === curMonthKey; 
                    const el = document.createElement('div'); 
                    el.className = "bg-white p-4 rounded-xl border border-slate-200 shadow-sm flex items-center gap-4 cursor-pointer hover:shadow-md transition relative overflow-hidden"; 
                    el.onclick = () => window.openStaffDetail(d.id); 
                    el.innerHTML = ` <img src="${photo}" class="w-12 h-12 rounded-full object-cover border-2 border-blue-100 bg-gray-200"> <div> <h4 class="font-bold text-slate-800">${s.name}</h4> <p class="text-[10px] font-bold text-blue-500 uppercase">${s.position || 'Staff'}</p> <p class="text-xs text-gray-500">${s.nic}</p> <p class="text-xs font-bold mt-1 text-blue-600">Salary: ${s.salary.toLocaleString()}</p> </div> ${isPaid ? '<span class="absolute top-2 right-2 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded border border-green-200">PAID: '+ new Date().toLocaleString('default', { month: 'short' }) +'</span>' : ''} `; 
                    grid.appendChild(el); 
                    
                    if(dropdown) {
                        const div = document.createElement('div'); 
                        div.innerHTML = `<span class="font-bold">${s.name}</span> <span class="text-xs text-gray-500">(${s.position || 'Staff'})</span>`; 
                        div.onclick = () => { 
                            document.getElementById("salesPersonInput").value = s.name; 
                            document.getElementById("salesDropdown").classList.remove("show"); 
                        }; 
                        dropdown.appendChild(div); 
                    }
                }); 
            }, (error) => console.error("Staff load error:", error)); 
            window.loadStaffPool(); 
        };

        window.loadProjects = async () => { 
            const grid = document.getElementById('projectGrid'); 
            const closedList = document.getElementById('closedProjectList'); 
            if(!grid || !closedList) return; 
            
            onSnapshot(collection(db, "projects"), (snap) => { 
                grid.innerHTML = ""; closedList.innerHTML = ""; 
                snap.forEach(docSnap => { 
                    const d = docSnap.data(); 
                    const isClosed = d.status === 'closed'; 
                    const el = document.createElement('div'); 
                    if(!isClosed) { 
                        el.className = "bg-white p-6 rounded-2xl shadow-sm hover:shadow-xl cursor-pointer border border-blue-100 transition relative overflow-hidden group"; 
                        el.onclick = () => window.openProject(docSnap.id, d); 
                        el.innerHTML = `<div class="absolute top-0 left-0 w-2 h-full bg-slate-900 group-hover:bg-blue-600 transition"></div><h3 class="font-bold text-lg text-slate-900 pl-2 project-card-title">${d.name}</h3><p class="text-sm text-gray-500 pl-2"><i class="fas fa-map-marker-alt mr-1"></i> ${d.area}</p><span class="text-[10px] uppercase font-bold bg-blue-100 px-2 py-1 rounded absolute top-4 right-4 text-gray-500 tracking-wider">${d.status}</span>`; 
                        grid.appendChild(el); 
                    } else { 
                        el.className = "bg-gray-100 p-4 rounded-xl flex justify-between items-center cursor-pointer border border-gray-200 hover:bg-gray-200"; 
                        el.onclick = () => window.openProject(docSnap.id, d); 
                        el.innerHTML = `<div><h3 class="font-bold text-slate-700">${d.name}</h3><p class="text-xs text-gray-500">${d.area} (Closed)</p></div><i class="fas fa-chevron-right text-gray-400"></i>`; 
                        closedList.appendChild(el); 
                    } 
                }); 
            }, (error) => console.error("Projects load error:", error)); 
        };

        window.createProject = async () => { 
            const name = document.getElementById('newProjName').value; 
            const area = document.getElementById('newProjArea').value; 
            const linkedLandId = document.getElementById('landLinkSelect').value; 
            if(!name) return alert("Name required"); 
            try { 
                const pData = { name, area, status: 'development', createdAt: serverTimestamp() }; 
                if(linkedLandId) pData.linkedLandId = linkedLandId; 
                const ref = await addDoc(collection(db, "projects"), pData); 
                if(linkedLandId) { 
                    await updateDoc(doc(db, "company_lands", linkedLandId), { linkedProjectId: ref.id }); 
                } 
                document.getElementById('newProjectModal').classList.add('hidden'); 
                alert("Project Created"); 
            } catch(e) { console.error(e); alert("Error"); } 
        };

        window.loadLands = async () => { 
            onSnapshot(collection(db, "company_lands"), (snap) => { 
                const grid = document.getElementById('landsGrid'); 
                if(!grid) return; 
                grid.innerHTML = ""; 
                snap.forEach(d => { 
                    const l = d.data(); 
                    const paid = (l.advance || 0) + (l.partPayment || 0); 
                    const bal = (l.cost || 0) - paid; 
                    const isPaid = bal <= 0; 
                    grid.innerHTML += ` <div class="bg-white p-6 rounded-xl border border-blue-100 shadow-sm relative overflow-hidden"> <div class="absolute top-0 left-0 w-2 h-full ${isPaid ? 'bg-green-500' : 'bg-red-500'}"></div> <h3 class="font-bold text-lg ml-3">${l.name}</h3> <p class="text-sm text-gray-500 ml-3 mb-2">Seller: ${l.seller}</p> ${l.linkedProjectId ? '<span class="ml-3 bg-purple-100 text-purple-700 text-[10px] font-bold px-2 py-1 rounded">LINKED TO PROJECT</span>' : '<span class="ml-3 bg-green-100 text-green-700 text-[10px] font-bold px-2 py-1 rounded">AVAILABLE</span>'} <div class="ml-3 grid grid-cols-2 gap-4 text-sm mt-4"> <div><p class="text-xs text-gray-400 font-bold uppercase">Cost</p><p class="font-bold">Rs. ${l.cost.toLocaleString()}</p></div> <div><p class="text-xs text-gray-400 font-bold uppercase">Paid</p><p class="font-bold text-green-600">Rs. ${paid.toLocaleString()}</p></div> <div class="col-span-2 border-t pt-2 flex justify-between items-center"> <span class="text-xs font-bold ${isPaid?'text-green-500':'text-red-500'} uppercase">${isPaid?'Fully Paid':'Balance: Rs. '+bal.toLocaleString()}</span> ${!isPaid ? `<button onclick="openLandPaymentModal('${d.id}', '${l.name}', ${bal})" class="text-xs bg-blue-100 text-blue-700 px-3 py-1 rounded hover:bg-blue-200 font-bold border border-blue-200">Add Payment</button>` : ''} </div> </div> </div> `; 
                }); 
            }, (error) => console.error("Lands load error:", error)); 
        };

        window.saveLand = async () => { 
            const name = document.getElementById('landName').value; 
            const cost = parseFloat(document.getElementById('landCost').value) || 0; 
            const advance = parseFloat(document.getElementById('landAdvance').value) || 0; 
            const seller = document.getElementById('landSeller').value; 
            await addDoc(collection(db, "company_lands"), { name, cost, advance, seller, status: 'acquired', createdAt: serverTimestamp() }); 
            document.getElementById('newLandModal').classList.add('hidden'); 
            alert("Land Added"); 
        };

        window.calcLandAdvance = () => { 
            const cost = parseFloat(document.getElementById('landCost').value) || 0; 
            document.getElementById('landAdvance').value = cost * 0.10; 
        };
        
        window.openLandPaymentModal = (id, name, bal) => {
            selectedLandId = id;
            selectedLandBal = bal;
            if(document.getElementById('landPayInfo')) document.getElementById('landPayInfo').innerText = `${name} - Balance Due: Rs. ${bal.toLocaleString()}`;
            if(document.getElementById('landPaymentModal')) document.getElementById('landPaymentModal').classList.remove('hidden');
        };

        window.submitLandPayment = async () => {
             const amt = parseFloat(document.getElementById('landPayAmount').value);
             const date = document.getElementById('landPayDate').value;
             if(!amt || !date) return alert("Enter Amount and Date");
             const landRef = doc(db, "company_lands", selectedLandId);
             const landSnap = await getDoc(landRef);
             if(landSnap.exists()) {
                 const curPaid = landSnap.data().partPayment || 0;
                 await updateDoc(landRef, { partPayment: curPaid + amt });
             }
             await addDoc(collection(db, "transactions"), {
                 date: date, description: `Land Payment: ${document.getElementById('landPayInfo').innerText.split(' - ')[0]}`, amount: amt, type: 'Expense', category: 'Land Acquisition', timestamp: serverTimestamp()
             });
             document.getElementById('landPaymentModal').classList.add('hidden');
             alert("Land Payment Recorded Successfully!");
             document.getElementById('landPayAmount').value = "";
        };

        window.toggleProjectView = (type) => {
            const grid = document.getElementById('projectGrid');
            const list = document.getElementById('closedProjectList');
            const btnActive = document.getElementById('btn-view-active');
            const btnClosed = document.getElementById('btn-view-closed');
            if(type === 'active') {
                grid.style.display = 'grid'; list.style.display = 'none';
                btnActive.classList.add('bg-white', 'shadow', 'text-slate-800'); btnActive.classList.remove('text-gray-500');
                btnClosed.classList.remove('bg-white', 'shadow', 'text-slate-800'); btnClosed.classList.add('text-gray-500');
            } else {
                grid.style.display = 'none'; list.style.display = 'block';
                btnClosed.classList.add('bg-white', 'shadow', 'text-slate-800'); btnClosed.classList.remove('text-gray-500');
                btnActive.classList.remove('bg-white', 'shadow', 'text-slate-800'); btnActive.classList.add('text-gray-500');
            }
        };

        window.loadGlobalAttendance = async () => {
            const dateInput = document.getElementById('attendanceDateFilter');
            if (!dateInput.value) dateInput.valueAsDate = new Date();
            const dateVal = dateInput.value;
            const grid = document.getElementById('globalAttendanceGrid');
            if(!grid) return;
            grid.innerHTML = "<p class='text-gray-500 p-4 col-span-full font-medium animate-pulse'>Loading location and attendance data...</p>";
            
            try {
                const attQuery = query(collectionGroup(db, 'attendance'));
                const attSnap = await getDocs(attQuery);
                let records = [];
                attSnap.forEach(d => {
                    const data = d.data();
                    const staffId = d.ref.parent.parent.id;
                    records.push({ id: d.id, staffId, ...data });
                });

                const leaveQuery = query(collectionGroup(db, 'leaves'), where('status', '==', 'pending'));
                const leaveSnap = await getDocs(leaveQuery);
                let pendingLeaves = {};
                leaveSnap.forEach(d => {
                    const l = d.data();
                    const staffId = d.ref.parent.parent.id;
                    if(!pendingLeaves[staffId]) pendingLeaves[staffId] = [];
                    pendingLeaves[staffId].push({ id: d.id, ...l });
                });
                
                const filterDateStr = new Date(dateVal).toLocaleDateString('en-CA');
                const dailyAttendance = {};

                records.forEach(a => {
                    const dateObj = a.timestamp?.seconds ? new Date(a.timestamp.seconds * 1000) : new Date();
                    const recDateStr = dateObj.toLocaleDateString('en-CA');
                    if (recDateStr !== filterDateStr) return;

                    if (!dailyAttendance[a.staffId]) {
                        dailyAttendance[a.staffId] = {
                            staff: staffListCache.find(s => s.id === a.staffId) || { name: 'Unknown Staff', photo: '' },
                            logs: [],
                            leaves: []
                        };
                    }
                    dailyAttendance[a.staffId].logs.push(a);
                });

                Object.keys(pendingLeaves).forEach(sId => {
                    if (!dailyAttendance[sId]) {
                         dailyAttendance[sId] = {
                            staff: staffListCache.find(s => s.id === sId) || { name: 'Unknown Staff', photo: '' },
                            logs: [],
                            leaves: []
                        };
                    }
                    dailyAttendance[sId].leaves = pendingLeaves[sId];
                });

                let html = "";
                Object.values(dailyAttendance).forEach(item => {
                    const s = item.staff;
                    let inLog = item.logs.find(l => l.type === 'IN' || l.type === 'Late IN');
                    let inText = "IN";
                    let inColor = "text-green-600";
                    
                    if (inLog) {
                        const inTimeObj = new Date(inLog.timestamp.seconds * 1000);
                        if (inTimeObj.getHours() > 8 || (inTimeObj.getHours() === 8 && inTimeObj.getMinutes() > 30)) {
                            inText = "Late IN";
                            inColor = "text-red-600 font-bold";
                        }
                    }

                    let outLog = item.logs.find(l => l.type === 'OUT');
                    const shortLeaveLog = item.logs.find(l => l.type === 'Short Leave Approved');
                    let outTypeTag = "Clock Out";
                    
                    if (!outLog && shortLeaveLog) {
                        outLog = shortLeaveLog;
                        outTypeTag = "Short Leave (OUT)";
                    }

                    let inTime = inLog ? new Date(inLog.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    let outTime = outLog ? new Date(outLog.timestamp.seconds * 1000).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '--:--';
                    
                    let locHtml = "";
                    if(inLog && inLog.lat && inLog.lng) {
                        locHtml = `<a href="http://googleusercontent.com/maps.google.com/?q=${inLog.lat},${inLog.lng}" target="_blank" class="text-blue-600 underline text-xs">Map (IN)</a>`;
                    }
                    
                    let outLocHtml = "";
                    if(outLog && outLog.lat && outLog.lng) {
                         outLocHtml = `<div class="mt-1"><a href="http://googleusercontent.com/maps.google.com/?q=${outLog.lat},${outLog.lng}" target="_blank" class="text-red-600 underline text-xs">Map (OUT)</a></div>`;
                    }
                    
                    let leaveHtml = "";
                    const shortReqLog = item.logs.find(l => l.type.includes('Short Leave Request'));
                    if(shortReqLog) {
                         leaveHtml += `<div class="mt-2 bg-purple-50 p-2 rounded border border-purple-200 flex justify-between items-center"><span class="text-xs font-bold text-purple-700">Short Leave Req</span><button onclick="approveShortLeave('${item.staff.id}', '${shortReqLog.id}')" class="bg-purple-600 text-white px-2 py-1 rounded text-[10px] font-bold">Approve</button></div>`;
                    } 
                    if (shortLeaveLog) {
                        leaveHtml += `<div class="mt-2 text-xs font-bold text-green-600 bg-green-50 p-1 rounded text-center">Short Leave Approved (Auto OUT)</div>`;
                    }

                    if (item.leaves && item.leaves.length > 0) {
                        item.leaves.forEach(l => {
                            leaveHtml += `
                            <div class="mt-2 bg-yellow-50 p-2 rounded border border-yellow-200">
                                <p class="text-[10px] font-bold text-yellow-800 uppercase mb-1">Leave Request: ${l.date}</p>
                                <p class="text-[10px] text-gray-600 italic mb-1">${l.reason || 'No reason'}</p>
                                <div class="flex gap-2">
                                    <button onclick="approveLeave('${item.staff.id}', '${l.id}')" class="bg-green-500 text-white px-3 py-1 rounded text-[10px] font-bold flex-1">Approve</button>
                                    <button onclick="rejectLeave('${item.staff.id}', '${l.id}')" class="bg-red-500 text-white px-3 py-1 rounded text-[10px] font-bold flex-1">Reject</button>
                                </div>
                            </div>`;
                        });
                    }

                    html += `
                    <div class="bg-white p-5 rounded-2xl shadow-sm border border-blue-100 hover:shadow-md transition relative overflow-hidden flex flex-col justify-between">
                        <div class="flex items-center gap-4 mb-4">
                            <img src="${s.photo || `https://ui-avatars.com/api/?name=${s.name}&background=eff6ff&color=1e3a8a&rounded=true&bold=true`}" class="w-14 h-14 rounded-full object-cover border-2 border-gray-200 cursor-pointer shadow-sm" onclick="document.getElementById('imgModalSrc').src='${s.photo || `https://ui-avatars.com/api/?name=${s.name}&background=eff6ff&color=1e3a8a&rounded=true&bold=true`}';document.getElementById('imgModal').classList.remove('hidden')">
                            <div>
                                <h4 class="font-bold text-slate-800 text-lg">${s.name}</h4>
                                <p class="text-xs text-gray-500 font-medium">${s.position || 'Staff'}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-center text-sm mb-2">
                             <div class="bg-green-50 p-2 rounded border border-green-100">
                                <span class="block text-[10px] font-bold ${inColor} uppercase">${inText}</span>
                                <span class="font-bold text-slate-700">${inTime}</span>
                                <div class="mt-1">${locHtml}</div>
                             </div>
                             <div class="bg-red-50 p-2 rounded border border-red-100">
                                <span class="block text-[10px] font-bold text-red-500 uppercase">${outTypeTag}</span>
                                <span class="font-bold text-slate-700">${outTime}</span>
                                ${outLocHtml}
                             </div>
                        </div>
                        ${leaveHtml}
                    </div>`;
                });

                grid.innerHTML = html || `<div class="col-span-full text-center py-12"><i class="fas fa-calendar-times text-4xl text-gray-300 mb-3"></i><p class="text-gray-500 font-medium">No attendance records found for ${dateVal}.</p></div>`;
            } catch(e) {
                console.error(e);
                grid.innerHTML = "<p class='text-red-500 p-4 col-span-full'>Error loading attendance data. Make sure Firestore Indexes are built.</p>";
            }
        };

        window.renderNotifications = () => {
            const list = document.getElementById('notifList');
            const badge = document.getElementById('notifBadge');
            if(!list || !badge) return;
            
            list.innerHTML = "";
            let total = 0;
            
            notifState.overdue.forEach(b => {
                total++;
                list.innerHTML += `<div class="p-3 border-b bg-red-50 cursor-pointer hover:bg-red-100" onclick="navigateToBlock('${b.projectId}', '${b.id}'); toggleNotifPanel();"><p class="font-bold text-xs">${b.name}</p><p class="text-[10px] text-red-500">Overdue: ${new Date(b.nextDate).toLocaleDateString()}</p></div>`;
            });

            notifState.tasks.forEach(t => {
                total++;
                list.innerHTML += `<div class="p-3 border-b bg-blue-50 cursor-pointer hover:bg-blue-100" onclick="openApproveModal('${t.id}', 'task'); toggleNotifPanel();"><p class="font-bold text-xs text-blue-900">Task Review: ${t.title}</p><p class="text-[10px] text-blue-500">Click to Review Cost</p></div>`;
            });

            notifState.meter.forEach(m => {
                total++;
                 list.innerHTML += `<div class="p-3 border-b bg-green-50 cursor-pointer hover:bg-green-100" onclick="openApproveModal('${m.id}', 'meter'); toggleNotifPanel();"><p class="font-bold text-xs text-green-900">Meter Reading: ${m.vehicleNo}</p><p class="text-[10px] text-green-500">Review Cost: Rs. ${m.totalCost}</p></div>`;
            });

            notifState.leaves.forEach(l => {
                total++;
                list.innerHTML += `<div class="p-3 border-b bg-yellow-50 cursor-pointer hover:bg-yellow-100" onclick="openStaffDetail('${l.staffId}'); toggleNotifPanel();"><p class="font-bold text-xs text-yellow-900">Leave Request</p><p class="text-[10px] text-yellow-600">Date: ${l.date}</p></div>`;
            });

            if(total > 0) {
                badge.innerText = total;
                badge.classList.remove('hidden');
            } else {
                badge.classList.add('hidden');
                list.innerHTML = "<p class='text-center p-4 text-gray-400 text-xs'>No new notifications.</p>";
            }
        };

        window.initGlobalNotifications = () => {
            onSnapshot(query(collection(db, "meter_readings"), where("status", "!=", "approved")), (snap) => {
                notifState.meter = [];
                snap.forEach(d => notifState.meter.push({ id: d.id, ...d.data() }));
                renderNotifications();
            });

            try {
                onSnapshot(query(collectionGroup(db, 'tasks'), where('status', 'in', ['new', 'manager_approved'])), (snap) => {
                    notifState.tasks = [];
                    snap.forEach(d => {
                        const t = d.data();
                        const pathSegments = d.ref.path.split('/');
                        const pid = pathSegments[1];
                        notifState.tasks.push({ id: d.id, projectId: pid, ...t });
                    });
                    renderNotifications();
                });
            } catch(e) {}

             try {
                onSnapshot(query(collectionGroup(db, 'leaves'), where('status', '==', 'pending')), (snap) => {
                    notifState.leaves = [];
                    snap.forEach(d => {
                         const pathSegments = d.ref.path.split('/');
                         const staffId = pathSegments[1];
                         notifState.leaves.push({ id: d.id, staffId: staffId, ...d.data() });
                    });
                    renderNotifications();
                });
            } catch(e) {}
        };
        
        window.checkOverduePayments = async () => { 
            const blocksQ = query(collectionGroup(db, 'blocks'), where('status', '==', 'sold')); 
            const snap = await getDocs(blocksQ); 
            notifState.overdue = [];
            snap.forEach(d => { 
                const b = d.data(); 
                if(b.payment && b.payment.planType === 'EP' && b.payment.nextPaymentDate) { 
                    const nextD = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate); 
                    if(nextD < new Date()) { 
                        const pathSegments = d.ref.path.split('/');
                        const pid = pathSegments[1];
                        notifState.overdue.push({ id: d.id, projectId: pid, name: b.name, nextDate: nextD });
                    } 
                } 
            }); 
            renderNotifications();
        };

        window.updateNet = (i,e) => { 
            if(i!==null) cInc=i; 
            if(e!==null) cExp=e; 
            const net = cInc-cExp; 
            const el = document.getElementById('finProfit'); 
            if(el) { 
                el.innerText = "Rs. " + net.toLocaleString(); 
                el.className = `text-3xl font-bold relative z-10 ${net>=0?'text-slate-800':'text-red-600'}`; 
            } 
        };
        
        window.analyzeProjectWithAI = async () => {
            const modal = document.getElementById('aiAnalysisModal');
            const contentDiv = document.getElementById('aiContent');
            const loadingDiv = document.getElementById('aiLoading');
            
            modal.classList.remove('hidden');
            contentDiv.classList.add('hidden');
            loadingDiv.classList.remove('hidden');
            
            const income = document.getElementById('finIncome').innerText;
            const expense = document.getElementById('finExpense').innerText;
            const profit = document.getElementById('finProfit').innerText;
            const projName = document.getElementById('detailName').innerText;
            
            const prompt = `Act as a senior real estate financial analyst. Analyze the following project data for "Sithuliya Real Estate":
            Project: ${projName}, Total Revenue: ${income}, Total Expenses: ${expense}, Net Profit: ${profit}
            Please provide: 1. A brief financial health summary. 2. Three specific, actionable recommendations. 3. A risk assessment score (Low/Medium/High). Format the output in clean Markdown.`;

            try {
                const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
                });
                const data = await response.json();
                const resultText = data.candidates[0].content.parts[0].text;
                contentDiv.innerHTML = marked.parse(resultText);
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
            } catch (error) {
                loadingDiv.classList.add('hidden');
                contentDiv.classList.remove('hidden');
                contentDiv.innerHTML = `<p class="text-red-500">Analysis failed. Please try again.</p>`;
            }
        };

        window.attemptLogin = async () => { 
            const pwd = document.getElementById('loginPass').value; 
            let correct = "Sandeep@1116"; 
            try { 
                const settingsRef = doc(db, "settings", "config"); 
                const snap = await getDoc(settingsRef); 
                if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword; 
            } catch (e) {} 
            
            if(pwd === correct) { 
                document.getElementById('loginScreen').classList.add('hidden'); 
                document.getElementById('mainApp').classList.remove('hidden'); 
                window.loadProjects(); 
                window.checkOverduePayments(); 
                window.loadStaff(); 
                window.loadLands(); 
                window.loadMeterReadings(); 
                window.checkPayroll(); 
                window.initGlobalNotifications();
                window.loadGlobalAttendance(); 
            } else { 
                alert("Incorrect Password"); 
            } 
        };

        window.addCustomFieldUI = (section, label = "", value = "") => {
            const container = document.getElementById(`custom_${section}_container`);
            if(!container) return;
            const div = document.createElement('div');
            div.className = "dyn-row";
            div.innerHTML = `
                <input type="text" class="w-1/2 p-1 border rounded text-xs font-bold text-gray-500" placeholder="Title" value="${label}">
                <input type="text" class="w-1/2 p-1 border rounded text-xs font-bold text-slate-800 input-val" placeholder="Value" value="${value}" oninput="calcReportTotals()">
                <i class="fas fa-times dyn-del-btn" onclick="this.parentElement.remove(); calcReportTotals();"></i>
            `;
            container.appendChild(div);
        };

        window.addCustomField = (section) => addCustomFieldUI(section);

        window.openReportDataModal = async () => {
             if(!currentProjId) return;
            document.getElementById('newProjectReportDataModal').classList.remove('hidden');
            
            try {
                const confSnap = await getDoc(doc(db, "settings", "report_config"));
                if(confSnap.exists()) {
                    const data = confSnap.data();
                    if(data.customFields) globalReportConfig.customFields = data.customFields;
                    if(data.devCategories) globalReportConfig.devCategories = data.devCategories;
                }
            } catch(e) {}

            const snap = await getDoc(doc(db, "projects", currentProjId));
            const p = snap.data();
            const d = p.reportData || {};
            const s = (id, val) => { if(document.getElementById(id)) document.getElementById(id).value = val !== undefined ? val : ""; };
            s('rpt_name', p.name); s('rpt_location', p.area);
            s('rpt_owner', d.owner); s('rpt_introducer', d.introducer);
            s('rpt_acres', d.acres); s('rpt_roods', d.roods); s('rpt_perches', d.perches);
            calcReportTotals(); 
            s('rpt_road_pct', d.road_pct || 10); s('rpt_res_pct', d.res_pct || 10); s('rpt_period', d.period || 9);
            s('rpt_title_ins_pct', d.title_ins_pct || 0); s('rpt_stamp_pct', d.stamp_pct || 4); s('rpt_legal_pct', d.legal_pct || 0.5); s('rpt_val_pct', d.val_pct || 0); s('rpt_title_rep', d.title_rep || 25000); s('rpt_intro_comm', d.intro_comm || 0);
            if(p.linkedLandId) {
                const lSnap = await getDoc(doc(db, "company_lands", p.linkedLandId));
                if(lSnap.exists()) s('rpt_purchase_price', lSnap.data().cost);
            } else { s('rpt_purchase_price', d.purchase_price || 0); }
            
            ['basic', 'purchase', 'taxes', 'ads'].forEach(sec => {
                if(document.getElementById(`custom_${sec}_container`))
                    document.getElementById(`custom_${sec}_container`).innerHTML = "";
            });

            const populateCustom = (section) => {
                const local = d.customValues && d.customValues[section] ? d.customValues[section] : [];
                const globalLabels = globalReportConfig.customFields[section] || [];
                local.forEach(item => addCustomFieldUI(section, item.label, item.value));
                globalLabels.forEach(label => {
                    if(!local.some(l => l.label === label)) {
                        addCustomFieldUI(section, label, "");
                    }
                });
            };
            
            populateCustom('basic');
            populateCustom('purchase');
            populateCustom('taxes');
            populateCustom('ads');

            const surveyDiv = document.getElementById('surveyRows'); surveyDiv.innerHTML = "";
            let sData = d.surveyData || globalReportConfig.surveyRows;
            sData.forEach((row, i) => { 
                surveyDiv.innerHTML += `
                <div class="grid grid-cols-12 gap-2 items-center mb-2">
                    <div class="col-span-4"><input type="text" class="w-full p-1 border text-xs" value="${row.desc}" id="sur_d_${i}"></div>
                    <div class="col-span-2"><input type="number" class="w-full p-1 border text-xs text-right input-number-clear" value="${row.unit}" placeholder="Unit" id="sur_u_${i}" oninput="calcSurveyRow(${i})"></div>
                    <div class="col-span-3"><input type="number" class="w-full p-1 border text-xs text-right input-number-clear" value="${row.price}" placeholder="Price" id="sur_p_${i}" oninput="calcSurveyRow(${i})"></div>
                    <div class="col-span-3"><input type="number" class="w-full p-1 border bg-gray-100 text-xs text-right input-number-clear" value="${row.unit*row.price}" id="sur_c_${i}" readonly></div>
                </div>`; 
            }); 
            calcSurveyTotal();
            
            const devDiv = document.getElementById('devCostContainer'); devDiv.innerHTML = "";
            let devCats = d.devCategories || globalReportConfig.devCategories; 
            let devItems = d.devItems || {}; 
            
            devCats.forEach(cat => { renderDevCategory(cat, devItems[cat] || []); }); 
            calcDevTotal();
            
            s('rpt_tax_ps', d.tax_ps); s('rpt_tax_plan', d.tax_plan); s('rpt_ad_cost', d.ad_cost); 
            s('rpt_fin_cap', d.fin_cap || 200000); s('rpt_fin_vat', d.fin_vat || 0); 
            s('rpt_sig_mgr', d.sig_mgr); s('rpt_sig_dir', d.sig_dir); s('rpt_sig_chm', d.sig_chm);
            
            calcReportTotals();
        };

        window.renderDevCategory = (catName, items = []) => {
            const devDiv = document.getElementById('devCostContainer');
            const div = document.createElement('div');
            div.className = "border p-2 rounded mb-2 dev-category";
            div.dataset.cat = catName;
            
            let itemsHtml = "";
            items.forEach(item => {
                const qty = item.qty || 1;
                const rate = item.rate || item.price; 
                const tot = qty * rate;
                itemsHtml += `
                <div class="flex gap-2 mb-1 dev-item-row items-center">
                    <input type="text" class="flex-1 p-1 border text-xs w-full" placeholder="Desc" value="${item.desc}">
                    <input type="number" class="w-12 p-1 border text-xs text-center" placeholder="Qty" value="${qty}" oninput="calcDevRowTotal(this)">
                    <input type="number" class="w-20 p-1 border text-xs text-right" placeholder="Rate" value="${rate}" oninput="calcDevRowTotal(this)">
                    <input type="number" class="w-20 p-1 border text-xs text-right bg-gray-100 dev-item-price" value="${tot}" readonly>
                    <button onclick="this.parentElement.remove();calcDevTotal()" class="text-red-500 text-xs">x</button>
                </div>`;
            });

            div.innerHTML = `
                <div class="flex justify-between items-center font-bold text-xs bg-gray-100 p-1 mb-2">
                    <span contenteditable="true" class="cat-title outline-none border-b border-transparent hover:border-gray-400">${catName}</span>
                    <div class="flex gap-2">
                        <button onclick="addDevItem(this)" class="text-blue-600">+ Item</button>
                        <button onclick="this.closest('.dev-category').remove(); calcDevTotal();" class="text-red-600"><i class="fas fa-trash"></i></button>
                    </div>
                </div>
                <div class="dev-items-container">${itemsHtml}</div>
                <div class="text-right text-xs font-bold mt-1">Subtotal: <span class="cat-total">0</span></div>
            `;
            devDiv.appendChild(div);
        };

        window.calcReportTotals = () => { 
            const getV = (id) => parseFloat(document.getElementById(id).value) || 0; 
            const totPerches = (getV('rpt_acres') * 160) + (getV('rpt_roods') * 40) + getV('rpt_perches'); 
            document.getElementById('rpt_tot_perches').value = totPerches; 
            const purPrice = getV('rpt_purchase_price'); 
            document.getElementById('rpt_agreed_val').value = purPrice; 
            document.getElementById('rpt_agreed_pp').value = totPerches > 0 ? (purPrice / totPerches).toFixed(2) : 0; 
            document.getElementById('rpt_title_ins').value = purPrice * (getV('rpt_title_ins_pct') / 100); 
            document.getElementById('rpt_stamp').value = purPrice * (getV('rpt_stamp_pct') / 100); 
            document.getElementById('rpt_legal').value = purPrice * (getV('rpt_legal_pct') / 100); 
            document.getElementById('rpt_valuation').value = purPrice * (getV('rpt_val_pct') / 100); 
            const sellPct = 100 - (getV('rpt_road_pct') + getV('rpt_res_pct')); 
            document.getElementById('rpt_sell_pct').value = sellPct;
            
            const calcSection = (sec) => {
                let t = 0;
                if(document.getElementById(`custom_${sec}_container`)){
                    document.getElementById(`custom_${sec}_container`).querySelectorAll('.input-val').forEach(i => t += parseFloat(i.value) || 0);
                }
                return t;
            }
            const adTot = calcSection('ads');
            if(document.getElementById('rpt_ads_total_disp')) document.getElementById('rpt_ads_total_disp').innerText = adTot.toLocaleString();
            
            const taxTot = calcSection('taxes');
            if(document.getElementById('rpt_taxes_total_disp')) document.getElementById('rpt_taxes_total_disp').innerText = taxTot.toLocaleString();
        };
        
        window.calcSurveyRow = (i) => { const u = parseFloat(document.getElementById(`sur_u_${i}`).value) || 0; const p = parseFloat(document.getElementById(`sur_p_${i}`).value) || 0; document.getElementById(`sur_c_${i}`).value = u * p; calcSurveyTotal(); };
        window.calcSurveyTotal = () => { let tot = 0; const inputs = document.querySelectorAll('[id^="sur_c_"]'); inputs.forEach(inp => tot += parseFloat(inp.value) || 0); document.getElementById('rpt_survey_total_disp').innerText = tot.toLocaleString(); };
        
        window.addDevCategory = () => { 
            const name = prompt("Enter Category Name:"); 
            if(name) renderDevCategory(name);
        };
        
        window.addDevItem = (btn) => { 
            const container = btn.closest('.dev-category').querySelector('.dev-items-container'); 
            const div = document.createElement('div');
            div.className = "flex gap-2 mb-1 dev-item-row items-center";
            div.innerHTML = `<input type="text" class="flex-1 p-1 border text-xs w-full" placeholder="Desc"><input type="number" class="w-12 p-1 border text-xs text-center" placeholder="Qty" oninput="calcDevRowTotal(this)"><input type="number" class="w-20 p-1 border text-xs text-right" placeholder="Rate" oninput="calcDevRowTotal(this)"><input type="number" class="w-20 p-1 border text-xs text-right bg-gray-100 dev-item-price" readonly><button onclick="this.parentElement.remove();calcDevTotal()" class="text-red-500 text-xs">x</button>`; 
            container.appendChild(div);
        };
        
        window.calcDevRowTotal = (inp) => {
            const row = inp.parentElement;
            const q = parseFloat(row.querySelectorAll('input')[1].value) || 0;
            const r = parseFloat(row.querySelectorAll('input')[2].value) || 0;
            row.querySelectorAll('input')[3].value = q * r;
            calcDevTotal();
        };

        window.calcDevTotal = () => { 
            let grandTot = 0; 
            document.querySelectorAll('.dev-category').forEach(cat => { 
                let sub = 0; 
                cat.querySelectorAll('.dev-item-price').forEach(inp => sub += parseFloat(inp.value) || 0); 
                cat.querySelector('.cat-total').innerText = sub.toLocaleString(); 
                grandTot += sub; 
            }); 
            document.getElementById('rpt_dev_total_disp').innerText = grandTot.toLocaleString(); 
        };
        
        window.saveReportData = async () => { 
            const getV = (id) => document.getElementById(id).value; 
            let surveyData = []; 
            document.querySelectorAll('[id^="sur_d_"]').forEach((inp, i) => { surveyData.push({ desc: inp.value, unit: document.getElementById(`sur_u_${i}`).value, price: document.getElementById(`sur_p_${i}`).value }); }); 
            
            let devCats = []; 
            let devItems = {}; 
            document.querySelectorAll('.dev-category').forEach(cat => { 
                const name = cat.querySelector('.cat-title').innerText; 
                devCats.push(name); 
                devItems[name] = []; 
                cat.querySelectorAll('.dev-item-row').forEach(row => { 
                    const inputs = row.querySelectorAll('input'); 
                    devItems[name].push({ desc: inputs[0].value, qty: inputs[1].value, rate: inputs[2].value, price: inputs[3].value }); 
                }); 
            }); 
            
            let customValues = { basic: [], purchase: [], taxes: [], ads: [] };
            let globalUpdate = { customFields: { ...globalReportConfig.customFields } };
            let hasGlobalChanges = false;

            ['basic', 'purchase', 'taxes', 'ads'].forEach(sec => {
                const rows = document.getElementById(`custom_${sec}_container`).querySelectorAll('.dyn-row');
                let labels = [];
                rows.forEach(row => {
                    const label = row.querySelectorAll('input')[0].value;
                    const val = row.querySelectorAll('input')[1].value;
                    if(label) {
                        customValues[sec].push({ label: label, value: val });
                        labels.push(label);
                    }
                });
                labels.forEach(l => {
                    if(!globalUpdate.customFields[sec].includes(l)) {
                        globalUpdate.customFields[sec].push(l);
                        hasGlobalChanges = true;
                    }
                });
            });
            
            if(devCats.length > 0) {
                globalUpdate.devCategories = devCats;
                hasGlobalChanges = true;
            }

            const data = { 
                owner: getV('rpt_owner'), introducer: getV('rpt_introducer'), 
                acres: getV('rpt_acres'), roods: getV('rpt_roods'), perches: getV('rpt_perches'), 
                road_pct: getV('rpt_road_pct'), res_pct: getV('rpt_res_pct'), period: getV('rpt_period'), 
                purchase_price: getV('rpt_purchase_price'), 
                title_ins_pct: getV('rpt_title_ins_pct'), stamp_pct: getV('rpt_stamp_pct'), legal_pct: getV('rpt_legal_pct'), val_pct: getV('rpt_val_pct'), 
                title_rep: getV('rpt_title_rep'), intro_comm: getV('rpt_intro_comm'), 
                surveyData: surveyData, 
                devCategories: devCats, devItems: devItems, 
                customValues: customValues, 
                tax_ps: getV('rpt_tax_ps'), tax_plan: getV('rpt_tax_plan'), ad_cost: getV('rpt_ad_cost'), 
                fin_cap: getV('rpt_fin_cap'), fin_vat: getV('rpt_fin_vat'), 
                sig_mgr: getV('rpt_sig_mgr'), sig_dir: getV('rpt_sig_dir'), sig_chm: getV('rpt_sig_chm') 
            }; 
            
            await updateDoc(doc(db, "projects", currentProjId), { reportData: data }); 
            
            if(hasGlobalChanges) {
                await setDoc(doc(db, "settings", "report_config"), globalUpdate, { merge: true });
                globalReportConfig = globalUpdate; 
            }

            document.getElementById('newProjectReportDataModal').classList.add('hidden'); 
            alert("Full Report Data & Templates Saved!"); 
        };

        window.generateProjectMasterReport = async () => { 
            if(!currentProjId) return alert("Open a project first.");
            const snap = await getDoc(doc(db, "projects", currentProjId));
            const p = snap.data();
            const d = p.reportData;
            if(!d) return alert("Please fill Report Data first.");
            
            const f = (val) => parseFloat(val) || 0;
            const totPerches = (f(d.acres)*160) + (f(d.roods)*40) + f(d.perches);
            const roadArea = (totPerches * f(d.road_pct))/100;
            const resArea = (totPerches * f(d.res_pct))/100;
            const sellArea = totPerches - roadArea - resArea;
            const purPrice = f(d.purchase_price);
            
            let cusPurchase = 0;
            let cusPurchaseHtml = "";
            (d.customValues?.purchase || []).forEach(i => {
                const v = f(i.value);
                cusPurchase += v;
                cusPurchaseHtml += `<tr><td>${i.label}</td><td style="text-align:right">${v.toLocaleString()}</td></tr>`;
            });

            const titleIns = purPrice * (f(d.title_ins_pct)/100);
            const stamp = purPrice * (f(d.stamp_pct)/100);
            const legal = purPrice * (f(d.legal_pct)/100);
            const valRep = purPrice * (f(d.val_pct)/100);
            const totPurchase = purPrice + titleIns + stamp + legal + valRep + f(d.title_rep) + f(d.intro_comm) + cusPurchase;
            
            let surHtml = ""; let surTot = 0;
            d.surveyData.forEach(row => { const cost = f(row.unit) * f(row.price); surTot += cost; surHtml += `<tr><td>${row.desc}</td><td>${row.unit}</td><td style="text-align:right">${f(row.price).toLocaleString()}</td><td style="text-align:right">${cost.toLocaleString()}</td></tr>`; });
            
            let devHtml = ""; let devTot = 0;
            (d.devCategories || []).forEach(cat => { 
                const items = d.devItems[cat] || []; 
                let catSub = 0; 
                let itemsHtml = "";
                items.forEach(item => { 
                    const t = f(item.price);
                    catSub += t; 
                    itemsHtml += `<tr><td style="padding-left:20px;">${item.desc}</td><td>${item.qty}</td><td style="text-align:right">${f(item.rate).toLocaleString()}</td><td style="text-align:right">${t.toLocaleString()}</td></tr>`;
                }); 
                devTot += catSub; 
                devHtml += `<tr><td><strong>${cat}</strong></td><td colspan="2"></td><td style="text-align:right"><strong>${catSub.toLocaleString()}</strong></td></tr>${itemsHtml}`; 
            });
            
            let taxes = f(d.tax_ps) + f(d.tax_plan);
            let taxHtml = "";
            (d.customValues?.taxes || []).forEach(i => {
                const v = f(i.value); taxes += v;
                taxHtml += `<tr><td>${i.label}</td><td style="text-align:right">${v.toLocaleString()}</td></tr>`;
            });

            let ads = f(d.ad_cost);
            let adsHtml = "";
            (d.customValues?.ads || []).forEach(i => {
                const v = f(i.value); ads += v;
                adsHtml += `<tr><td>${i.label}</td><td style="text-align:right">${v.toLocaleString()}</td></tr>`;
            });

            let totalMiscExp = 0; 
            const expSnap = await getDocs(collection(db, `projects/${currentProjId}/expenses`)); 
            expSnap.forEach(doc => { 
                const e = doc.data(); 
                if(!e.description.toLowerCase().includes('commission') && !e.description.toLowerCase().includes('comm:')) {
                    totalMiscExp += e.amount; 
                }
            });
            
            const finance = f(d.fin_cap) + f(d.fin_vat);
            const grandTotal = totPurchase + surTot + devTot + taxes + ads + finance + totalMiscExp;
            let salesTotal = 0; const bSnap = await getDocs(collection(db, `projects/${currentProjId}/blocks`)); bSnap.forEach(b => salesTotal += (b.data().soldPrice || b.data().price));
            const netProfit = salesTotal - grandTotal; const netProfitPct = salesTotal > 0 ? (netProfit/salesTotal)*100 : 0; const roi = grandTotal > 0 ? (netProfit/grandTotal)*100 : 0; const annualizedRoi = (roi / f(d.period)) * 12;
            
            let customBasicHtml = "";
            (d.customValues?.basic || []).forEach(i => {
                customBasicHtml += `<tr><td>${i.label}</td><td>${i.value}</td></tr>`;
            });

            const html = `<div style="font-family: 'Times New Roman', serif; padding: 20px;">
            <div style="text-align:center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px;">
                <img src="ico.jpeg" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin: 0 auto 10px auto; display: block; border: 2px solid #1e3a8a;">
                <h1 style="font-size: 28px; font-weight: bold; margin: 0;">SITHULIYA REAL ESTATE</h1>
                <p style="font-size: 12px; margin: 5px 0;">Kurunegala, Sri Lanka</p>
                <h2 style="font-size: 20px; text-decoration: underline; margin-top: 15px;">PROJECT EVALUATION REPORT</h2>
            </div>
            <h3 style="text-align:center; margin-bottom:20px;">${p.name} - ${p.area}</h3>
            
            <div class="report-header-bg">1. PROJECT OVERVIEW</div>
            <table class="report-table">
                <tr><td>Owner: ${d.owner||'-'}</td><td>Introducer: ${d.introducer||'-'}</td></tr>
                <tr><td>Extent: ${d.acres||0}A ${d.roods||0}R ${d.perches||0}P (${totPerches} Perches)</td><td>Agreed Value: Rs. ${purPrice.toLocaleString()}</td></tr>
                ${customBasicHtml}
            </table>
            
            <div class="report-header-bg">2. LAND ALLOCATION</div>
            <table class="report-table"><tr><td>Roadways: ${d.road_pct}%</td><td>Reservations: ${d.res_pct}%</td><td>Sellable: ${sellArea.toFixed(2)} P (${(sellArea/totPerches*100).toFixed(1)}%)</td></tr></table>
            
            <div class="report-header-bg">3. COST OF PURCHASE</div>
            <table class="report-table">
                <tr><td>Purchase Price</td><td style="text-align:right">${purPrice.toLocaleString()}</td></tr>
                <tr><td>Stamp Duty (${d.stamp_pct}%)</td><td style="text-align:right">${stamp.toLocaleString()}</td></tr>
                <tr><td>Legal Fees (${d.legal_pct}%)</td><td style="text-align:right">${legal.toLocaleString()}</td></tr>
                <tr><td>Title Reports</td><td style="text-align:right">${f(d.title_rep).toLocaleString()}</td></tr>
                <tr><td>Introducer Comm.</td><td style="text-align:right">${f(d.intro_comm).toLocaleString()}</td></tr>
                ${cusPurchaseHtml}
                <tr style="font-weight:bold; background:#eee"><td>TOTAL PURCHASE COST</td><td style="text-align:right">${totPurchase.toLocaleString()}</td></tr>
            </table>
            
            <div class="report-header-bg">4. SURVEY CHARGES</div>
            <table class="report-table"><tr><th>Description</th><th>Units</th><th>Price</th><th>Cost</th></tr>${surHtml}<tr style="font-weight:bold; background:#eee"><td colspan="3">TOTAL SURVEY</td><td style="text-align:right">${surTot.toLocaleString()}</td></tr></table>
            
            <div class="report-header-bg">5. DEVELOPMENT COST</div>
            <table class="report-table"><tr><th>Description</th><th>Qty</th><th>Rate</th><th>Cost</th></tr>${devHtml}<tr style="font-weight:bold; background:#eee"><td colspan="3">TOTAL DEVELOPMENT</td><td style="text-align:right">${devTot.toLocaleString()}</td></tr></table>
            
            <div class="report-header-bg">6-8. OTHER COSTS</div>
            <table class="report-table">
                <tr><td colspan="2"><strong>Taxes & Approvals</strong></td></tr>
                <tr><td>PS Tax</td><td style="text-align:right">${f(d.tax_ps).toLocaleString()}</td></tr>
                <tr><td>Plan Tax</td><td style="text-align:right">${f(d.tax_plan).toLocaleString()}</td></tr>
                ${taxHtml}
                
                <tr><td colspan="2"><strong>Cost of Sales & Ads</strong></td></tr>
                <tr><td>Advertising</td><td style="text-align:right">${f(d.ad_cost).toLocaleString()}</td></tr>
                ${adsHtml}
                
                <tr><td colspan="2"><strong>Financial</strong></td></tr>
                <tr><td>Financial (Capital + VAT)</td><td style="text-align:right">${finance.toLocaleString()}</td></tr>
            </table>
            
            <div class="report-header-bg">9. SALES & PROFITABILITY</div>
            <table class="report-table">
                <tr><td>Total Sales Proceeds</td><td style="text-align:right; font-weight:bold">${salesTotal.toLocaleString()}</td></tr>
                <tr><td>Total Cost of Project (Inc Misc)</td><td style="text-align:right; color:red">(${grandTotal.toLocaleString()})</td></tr>
                <tr style="font-weight:bold; background:#ddd"><td>NET PROFIT</td><td style="text-align:right">${netProfit.toLocaleString()}</td></tr>
            </table>
            
            <div class="report-header-bg">10. PROFITABILITY RATIOS</div>
            <table class="report-table">
                <tr><td>Net Profit on Sales Proceeds</td><td style="text-align:right">${netProfitPct.toFixed(1)}%</td></tr>
                <tr><td>ROI (Project Period)</td><td style="text-align:right">${roi.toFixed(1)}%</td></tr>
                <tr><td>ROI (Per Annum)</td><td style="text-align:right">${annualizedRoi.toFixed(1)}%</td></tr>
            </table>
            
            <div style="margin-top:60px; display:flex; justify-content:space-between; text-align:center; font-size:12px;">
                <div style="border-top:1px dotted #000; width:30%; padding-top:5px;">${d.sig_mgr || 'Manager'}</div>
                <div style="border-top:1px dotted #000; width:30%; padding-top:5px;">${d.sig_dir || 'Director'}</div>
                <div style="border-top:1px dotted #000; width:30%; padding-top:5px;">${d.sig_chm || 'Chairman'}</div>
            </div>
            <div style="text-align:right; margin-top:20px; font-size:10px;">Date: ${new Date().toLocaleDateString()}</div>
            </div>`;
            
            document.getElementById('printContainer').innerHTML = html;
            document.getElementById('pdfPreviewOverlay').style.display = 'block';
        };

       window.downloadPDFActual = async () => {
             const element = document.getElementById('printContainer');
             if (!element.innerHTML.trim()) {
                 alert("No report content to download. Please generate a report first.");
                 return;
             }
             const opt = { 
                 margin: [5, 5, 5, 5],
                 filename: `Report_${currentProjName || 'Sithuliya'}.pdf`, 
                 image: { type: 'jpeg', quality: 0.98 }, 
                 html2canvas: { scale: 2, useCORS: true, logging: true, scrollY: 0 }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
             };
             
             setTimeout(async () => {
                 try {
                    await html2pdf().set(opt).from(element).save();
                    document.getElementById('pdfPreviewOverlay').style.display = 'none';
                 } catch (e) {
                     alert("Error downloading PDF. Please try again.");
                 }
             }, 500);
        };

       window.triggerPDFDownload = async () => {
             const element = document.getElementById('printContainer');
             if (!element.innerHTML.trim() || element.innerHTML.includes("Select date range")) {
                 alert("Please generate a report first.");
                 return;
             }
             const opt = { 
                 margin: [5, 5, 5, 5],
                 filename: `Financial_Report_${new Date().toLocaleDateString()}.pdf`, 
                 image: { type: 'jpeg', quality: 0.98 }, 
                 html2canvas: { scale: 2, useCORS: true, logging: true, scrollY: 0 }, 
                 jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } 
             };
             
             setTimeout(async () => {
                 try {
                    await html2pdf().set(opt).from(element).save();
                 } catch (e) {
                     alert("Error downloading PDF. Please try again.");
                 }
             }, 500);
        };
        
        window.downloadFinancialReport = async () => { 
            const el = document.getElementById('view-finance'); 
            const buttons = el.querySelectorAll('button'); 
            buttons.forEach(b => b.style.display = 'none'); 
            const opt = { 
                margin: 10, 
                filename: `Financial_Report_${currentProjName}.pdf`, 
                image: { type: 'jpeg', quality: 0.98 }, 
                html2canvas: { scale: 2, useCORS: true }, 
                jsPDF: { unit: 'mm', format: 'a4', orientation: 'landscape' } 
            }; 
            await html2pdf().set(opt).from(el).save(); 
            buttons.forEach(b => b.style.display = 'inline-block'); 
        };

        window.filterStaffGrid = () => { 
            const input = document.getElementById('staffSearchInput').value.toLowerCase(); 
            const grid = document.getElementById('staffGrid'); 
            const cards = grid.getElementsByTagName('div'); 
            for (let i = 0; i < cards.length; i++) { 
                const nameHeader = cards[i].querySelector('h4'); 
                if (nameHeader) { 
                    const txtValue = nameHeader.textContent || nameHeader.innerText; 
                    cards[i].style.display = txtValue.toLowerCase().indexOf(input) > -1 ? "" : "none"; 
                } 
            } 
        };

        window.filterSalesFunction = () => { 
            const input = document.getElementById("salesPersonInput"); 
            const filter = input.value.toUpperCase(); 
            const div = document.getElementById("salesDropdown"); 
            if(!div) return;
            const a = div.getElementsByTagName("div"); 
            for (let i = 0; i < a.length; i++) { 
                const txtValue = a[i].textContent || a[i].innerText; 
                a[i].style.display = txtValue.toUpperCase().indexOf(filter) > -1 ? "" : "none"; 
            } 
        };

        window.toggleSalesDropdown = () => document.getElementById("salesDropdown").classList.toggle("show");
        
        window.onclick = function(event) { 
            if (!event.target.matches('#salesPersonInput')) { 
                const dropdowns = document.getElementsByClassName("dropdown-content"); 
                for (let i = 0; i < dropdowns.length; i++) { 
                    if (dropdowns[i].classList.contains('show')) dropdowns[i].classList.remove('show'); 
                } 
            } 
        };

        window.loadStaffPool = async () => { 
            const q = query(collection(db, 'transactions'), where('category', '==', 'Staff Welfare')); 
            const snap = await getDocs(q); 
            let total = 0; 
            const list = document.getElementById('staffPoolList'); 
            if(!list) return; 
            list.innerHTML = ""; 
            snap.forEach(d => { 
                const t = d.data(); 
                total += t.amount; 
                list.innerHTML += `<div class="flex justify-between border-b border-gray-100 p-1"><span>${t.description.split(':')[1] || t.description}</span><span>${t.amount.toLocaleString()}</span></div>`; 
            }); 
            if(document.getElementById('staffPoolTotal')) { 
                document.getElementById('staffPoolTotal').innerText = "Rs. " + total.toLocaleString(); 
            } 
        };

        window.checkPayroll = async () => { 
            const today = new Date(); 
            const currentMonthKey = `${today.getFullYear()}_${today.getMonth() + 1}`; 
            const snapshot = await getDocs(collection(db, "staff")); 
            
            snapshot.forEach(async (docSnap) => { 
                const s = docSnap.data(); 
                let isUpdated = false;
                let updates = {};

                if (today.getDate() >= 10 && s.lastPaidAllowanceMonth !== currentMonthKey) { 
                    let totalAllowance = 0;

                    if(s.fuelAllowance > 0) {
                        await addDoc(collection(db, "transactions"), { 
                            date: today.toLocaleDateString('en-CA'), 
                            description: `Fuel Allowance: ${s.name}`, 
                            amount: s.fuelAllowance || 0, 
                            type: 'Expense', 
                            category: 'Staff Salary', 
                            timestamp: serverTimestamp() 
                        });
                        totalAllowance += (s.fuelAllowance || 0);
                    }

                    if(s.vehicleAllowance > 0) {
                         await addDoc(collection(db, "transactions"), { 
                            date: today.toLocaleDateString('en-CA'), 
                            description: `Vehicle Allowance: ${s.name}`, 
                            amount: s.vehicleAllowance || 0, 
                            type: 'Expense', 
                            category: 'Staff Salary', 
                            timestamp: serverTimestamp() 
                        });
                        totalAllowance += (s.vehicleAllowance || 0);
                    }

                    if (totalAllowance > 0) {
                        await addDoc(collection(db, `staff/${docSnap.id}/earnings`), { 
                            date: today, 
                            amount: totalAllowance, 
                            type: 'Allowance', 
                            description: `Allowances for ${new Date().toLocaleString('default', { month: 'long' })}` 
                        }); 
                    }

                    updates.lastPaidAllowanceMonth = currentMonthKey;
                    isUpdated = true;
                } 

                if (today.getDate() >= 25 && s.lastPaidSalaryMonth !== currentMonthKey) {
                    if (s.salary > 0) {
                        await addDoc(collection(db, "transactions"), { 
                            date: today.toLocaleDateString('en-CA'), 
                            description: `Monthly Salary: ${s.name}`, 
                            amount: s.salary || 0, 
                            type: 'Expense', 
                            category: 'Staff Salary', 
                            timestamp: serverTimestamp() 
                        }); 

                        await addDoc(collection(db, `staff/${docSnap.id}/earnings`), { 
                            date: today, 
                            amount: (s.salary || 0), 
                            type: 'Salary', 
                            description: `Basic Salary for ${new Date().toLocaleString('default', { month: 'long' })}` 
                        });
                    }

                    updates.lastPaidSalaryMonth = currentMonthKey;
                    updates.lastPaidMonth = currentMonthKey; 
                    isUpdated = true;
                }

                if (isUpdated) {
                    await updateDoc(doc(db, "staff", docSnap.id), updates); 
                }
            }); 
        };

        window.openStaffDetail = async (id) => { 
            currentStaffDetailId = id;
            const s = staffListCache.find(x => x.id === id); 
            if(!s) return; 
            
            document.getElementById('sdPhoto').src = s.photo || `https://ui-avatars.com/api/?name=${s.name}&background=eff6ff&color=1e3a8a&rounded=true&bold=true`;
            document.getElementById('sdName').innerText = s.name; 
            document.getElementById('sdPosition').innerText = s.position || 'Staff Member'; 
            document.getElementById('sdNIC').innerText = s.nic || '-'; 
            document.getElementById('sdPhone').innerText = s.phone || '-'; 
            document.getElementById('sdSalary').innerText = "Rs. " + (s.salary ? s.salary.toLocaleString() : '0'); 
            document.getElementById('sdFuel').innerText = "Rs. " + (s.fuelAllowance ? s.fuelAllowance.toLocaleString() : '0'); 
            document.getElementById('sdVehicle').innerText = "Rs. " + (s.vehicleAllowance ? s.vehicleAllowance.toLocaleString() : '0'); 
            document.getElementById('sdJoined').innerText = s.joinedDate ? new Date(s.joinedDate.seconds*1000).toLocaleDateString() : '-'; 
            
            const locSection = document.getElementById('sdLocationSection');
            if (s.pendingLocation) {
                locSection.classList.remove('hidden');
                locSection.style.display = "block";
                const link = `http://googleusercontent.com/maps.google.com/?q=${s.pendingLocation.lat},${s.pendingLocation.lng}`;
                document.getElementById('sdMapLink').href = link;
            } else {
                locSection.classList.add('hidden');
                locSection.style.display = "none";
            }

            const btnContainer = document.getElementById('sdActionBtns'); 
            btnContainer.innerHTML = ` <button onclick="editStaff('${id}')" class="w-full py-2 border border-gray-300 rounded-lg font-bold text-gray-600 hover:bg-gray-50 text-xs">Edit Details</button> <button onclick="deleteStaff('${id}')" class="w-full py-2 bg-red-600 text-white rounded-lg font-bold shadow hover:bg-red-700 text-xs">Remove Member</button> `; 
            
            const attList = document.getElementById('sdAttendanceList');
            attList.innerHTML = "Loading...";
            try {
                const attSnap = await getDocs(query(collection(db, `staff/${id}/attendance`), orderBy("timestamp", "desc")));
                let attHtml = "";
                attSnap.forEach(d => {
                    const a = d.data();
                    const date = a.timestamp.seconds ? new Date(a.timestamp.seconds * 1000) : new Date();
                    const photoHtml = a.photo ? `<img src="${a.photo}" class="w-8 h-8 rounded-full border border-gray-300 cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${a.photo}';document.getElementById('imgModal').classList.remove('hidden')">` : '-';
                    
                    let typeColor = 'text-gray-600';
                    let typeText = a.type;
                    let actionHtml = '';

                    if(a.type === 'IN') typeColor = 'text-green-600';
                    else if(a.type === 'Late IN') { typeColor = 'text-orange-600'; typeText = "Late IN"; }
                    else if(a.type === 'OUT') typeColor = 'text-red-600';
                    else if(a.type.includes('Short Leave Request')) {
                        typeColor = 'text-purple-600 font-bold';
                        typeText = "Short Leave Request";
                        actionHtml = `<button onclick="approveShortLeave('${id}', '${d.id}')" class="bg-blue-600 text-white px-2 py-1 rounded text-[10px] font-bold">APPROVE</button>`;
                    }
                    else if(a.type.includes('Short Leave Approved')) {
                         typeColor = 'text-green-600 font-bold';
                         typeText = "Short Leave (Approved)";
                    }

                    attHtml += `<tr class="border-b border-gray-100"><td class="p-1">${date.toLocaleString()}</td><td class="p-1 font-bold ${typeColor}">${typeText}</td><td class="p-1">${photoHtml}</td><td class="p-1">${actionHtml}</td></tr>`;
                });
                attList.innerHTML = attHtml || "<tr><td colspan='4' class='text-center text-gray-400 p-2'>No attendance records found.</td></tr>";
            } catch(e) { attList.innerHTML = "Error loading attendance."; }

            const leaveSection = document.getElementById('sdLeaveSection');
            const leaveList = document.getElementById('sdLeaveList');
            leaveList.innerHTML = "Loading...";
            try {
                const leaveSnap = await getDocs(query(collection(db, `staff/${id}/leaves`), where("status", "==", "pending")));
                if (!leaveSnap.empty) {
                    leaveSection.classList.remove('hidden');
                    leaveSection.style.display = "block"; 
                    let leaveHtml = "";
                    leaveSnap.forEach(d => {
                        const l = d.data();
                        leaveHtml += `
                        <div class="flex justify-between items-center bg-white p-2 rounded shadow-sm border border-yellow-100">
                            <span class="text-xs font-bold text-slate-700">Request for: ${l.date}</span>
                            <div class="flex gap-2">
                                <button onclick="approveLeave('${id}', '${d.id}')" class="bg-green-500 text-white px-2 py-1 rounded text-xs font-bold">Approve</button>
                                <button onclick="rejectLeave('${id}', '${d.id}')" class="bg-red-500 text-white px-2 py-1 rounded text-xs font-bold">Reject</button>
                            </div>
                        </div>`;
                    });
                    leaveList.innerHTML = leaveHtml;
                } else {
                    leaveSection.classList.add('hidden');
                    leaveSection.style.display = "none";
                }
            } catch(e) { leaveSection.classList.add('hidden'); }

            const earnList = document.getElementById('sdEarningsList'); 
            earnList.innerHTML = "Loading..."; 
            let totalEarn = 0; 
            try { 
                const earnSnap = await getDocs(collection(db, `staff/${id}/earnings`)); 
                let html = ""; 
                earnSnap.forEach(doc => { 
                    const e = doc.data(); 
                    const d = e.date.seconds ? new Date(e.date.seconds*1000) : new Date(e.date); 
                    totalEarn += (e.amount || 0); 
                    let color = e.type === 'Salary' ? 'text-blue-600' : 'text-purple-600'; 
                    let desc = e.description || ''; 
                    html += `<tr class="border-b border-gray-100"> <td class="p-1 text-gray-500"> ${d.toLocaleDateString()}<br> <span class="text-[9px] text-gray-400">${desc}</span> </td> <td class="p-1 font-bold ${color}">${e.type}</td> <td class="p-1 text-right font-bold">Rs. ${e.amount.toLocaleString()}</td> </tr>`; 
                }); 
                earnList.innerHTML = html || "<tr><td colspan='3' class='text-center p-2 text-gray-400'>No earnings history.</td></tr>"; 
                document.getElementById('sdTotalEarnings').innerText = "Rs. " + totalEarn.toLocaleString(); 
            } catch(e) { 
                earnList.innerHTML = "Error loading earnings."; 
            } 
            document.getElementById('staffDetailModal').classList.remove('hidden'); 
        };
        
        window.approveShortLeave = async (staffId, attId) => {
            if(confirm("Approve Short Leave Request? (This will mark as Clock OUT)")) {
                await updateDoc(doc(db, `staff/${staffId}/attendance/${attId}`), { type: 'Short Leave Approved' });
                alert("Short Leave Approved!");
                window.openStaffDetail(staffId);
                window.loadGlobalAttendance();
            }
        };

        window.approveLeave = async (staffId, leaveId) => {
            if(confirm("Approve Leave?")) {
                await updateDoc(doc(db, `staff/${staffId}/leaves/${leaveId}`), { status: 'approved' });
                alert("Leave Approved!");
                window.openStaffDetail(staffId); 
            }
        };

        window.rejectLeave = async (staffId, leaveId) => {
            if(confirm("Reject Leave?")) {
                await updateDoc(doc(db, `staff/${staffId}/leaves/${leaveId}`), { status: 'rejected' });
                alert("Leave Rejected!");
                window.openStaffDetail(staffId); 
            }
        };

        window.approveStaffLocation = async () => {
            if (!currentStaffDetailId) return alert("System Error: Staff ID missing.");
            
            const staffRef = doc(db, "staff", currentStaffDetailId);
            const staffSnap = await getDoc(staffRef);
            
            if (!staffSnap.exists()) return alert("Staff member not found.");
            const staff = staffSnap.data();

            if (!staff.pendingLocation) return alert("No pending location found to approve.");
            
            if (confirm("Confirm that this is the valid work location for " + staff.name + "?")) {
                await updateDoc(staffRef, {
                    workLocation: staff.pendingLocation,
                    pendingLocation: deleteField() 
                });
                alert("Location Approved! Staff can now mark attendance.");
                const sec = document.getElementById('sdLocationSection');
                if(sec) {
                    sec.classList.add('hidden');
                    sec.style.display = "none";
                }
                window.loadStaff();
                window.openStaffDetail(currentStaffDetailId);
            }
        };

        window.deleteStaff = async (id) => { 
            if(!confirm("Are you sure you want to remove this staff member? This cannot be undone.")) return; 
            await deleteDoc(doc(db, "staff", id)); 
            document.getElementById('staffDetailModal').classList.add('hidden'); 
            alert("Staff Member Removed."); 
        };

        window.editStaff = (id) => { 
            const s = staffListCache.find(x => x.id === id); 
            if(!s) return; 
            document.getElementById('staffDetailModal').classList.add('hidden'); 
            document.getElementById('newStaffModal').classList.remove('hidden'); 
            document.getElementById('staffMode').value = 'edit'; 
            document.getElementById('editStaffId').value = id; 
            document.getElementById('newStaffBtnText').innerText = 'Update Details'; 
            document.getElementById('staffName').value = s.name; 
            document.getElementById('staffNIC').value = s.nic; 
            document.getElementById('staffPhone').value = s.phone; 
            document.getElementById('staffPosition').value = s.position; 
            document.getElementById('staffSalary').value = s.salary; 
            document.getElementById('staffFuel').value = s.fuelAllowance || ""; 
            document.getElementById('staffVehicle').value = s.vehicleAllowance || ""; 
        };

        window.saveStaff = async () => { 
            const mode = document.getElementById('staffMode').value; 
            const name = document.getElementById('staffName').value; 
            const nic = document.getElementById('staffNIC').value; 
            const phone = document.getElementById('staffPhone').value; 
            const pos = document.getElementById('staffPosition').value; 
            const sal = parseFloat(document.getElementById('staffSalary').value); 
            const fuel = parseFloat(document.getElementById('staffFuel').value) || 0;
            const vehicle = parseFloat(document.getElementById('staffVehicle').value) || 0;
            const file = document.getElementById('staffPhoto').files[0]; 
            if(!name || !nic) return alert("Name and NIC required"); 
            let photoBase64 = null; 
            if(file) { 
                const reader = new FileReader(); 
                reader.readAsDataURL(file); 
                await new Promise(resolve => reader.onload = resolve); 
                photoBase64 = reader.result; 
            } 
            const data = { name, nic, phone, position: pos, salary: sal, fuelAllowance: fuel, vehicleAllowance: vehicle }; 
            if(photoBase64) data.photo = photoBase64; 
            if (mode === 'edit') { 
                const id = document.getElementById('editStaffId').value; 
                await updateDoc(doc(db, "staff", id), data); 
                alert("Staff Details Updated!"); 
            } else { 
                data.joinedDate = serverTimestamp(); 
                await addDoc(collection(db, "staff"), data); 
                alert("New Staff Member Added!"); 
            } 
            document.getElementById('newStaffModal').classList.add('hidden'); 
        };

        window.updateStaffAccessPass = async () => { 
            const adminPass = document.getElementById('adminAuthPass').value; 
            const newPin = document.getElementById('newStaffPin').value; 
            let correct = "Sandeep@1116"; 
            try { 
                const snap = await getDoc(doc(db, "settings", "config")); 
                if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword; 
            } catch(e) {} 
            if(adminPass !== correct) return alert("Admin Password Incorrect"); 
            await setDoc(doc(db, "settings", "staff_config"), { accessPassword: newPin }, { merge: true }); 
            document.getElementById('staffPassChangeModal').classList.add('hidden'); 
            alert("Staff PIN Updated!"); 
        };

        window.openProject = (id, data) => { 
            currentProjId = id; 
            currentProjName = data.name; 
            nav('detail'); 
            const isClosed = data.status === 'closed'; 
            document.getElementById('endDevBtn').style.display = (data.status === 'development') ? 'block' : 'none'; 
            document.getElementById('devPhaseUI').style.display = (data.status === 'development') ? 'grid' : 'none'; 
            if (data.status === 'active') { 
                document.getElementById('closeProjBtn').classList.remove('hidden'); 
            } else { 
                document.getElementById('closeProjBtn').classList.add('hidden'); 
            } 
            if(currentProjUnsub) currentProjUnsub(); 
            currentProjUnsub = onSnapshot(doc(db, "projects", id), async (docSnap) => { 
                if (docSnap.exists()) { 
                    const pData = docSnap.data(); 
                    document.getElementById('detailName').innerText = pData.name; 
                    document.getElementById('detailArea').innerText = pData.area || 'Unknown'; 
                    document.getElementById('detailStatus').innerText = pData.status || 'Active'; 
                    const vList = document.getElementById('vehicleList'); 
                    vList.innerHTML = ""; 
                    (pData.assignedVehicles || []).forEach(v => vList.innerHTML += `<span class="bg-blue-200 px-2 py-1 rounded text-xs font-bold mr-1">${v}</span>`); 
                    if(pData.linkedLandId) { 
                        const l = await getDoc(doc(db, "company_lands", pData.linkedLandId)); 
                        if(l.exists()) document.getElementById('detailLandName').innerText = l.data().name; 
                    } else { 
                        document.getElementById('detailLandName').innerText = ""; 
                    } 
                } 
            }); 
            loadBlocks(id, data.status === 'development'); 
            loadExpensesAndProfit(id); 
            loadProjectTasks(id); 
        };

        window.endDevelopmentPhase = async () => { 
            if(!confirm("End Development Phase?")) return; 
            await updateDoc(doc(db, "projects", currentProjId), { status: 'active' }); 
            alert("Development Phase Ended."); 
        };

        window.closeProject = async () => { 
            if(!confirm("Are you sure you want to CLOSE this project? This will remove the linked land from Assets.")) return; 
            const pSnap = await getDoc(doc(db, "projects", currentProjId)); 
            const pData = pSnap.data(); 
            await updateDoc(doc(db, "projects", currentProjId), { status: 'closed' }); 
            if(pData.linkedLandId) { 
                const lSnap = await getDoc(doc(db, "company_lands", pData.linkedLandId)); 
                if(lSnap.exists()) { 
                    const l = lSnap.data(); 
                    await addDoc(collection(db, "bs_items"), { 
                        date: new Date().toLocaleDateString('en-CA'), 
                        name: `Project Closed (Sold): ${l.name}`, 
                        type: "Current Asset", 
                        amount: -l.cost, 
                        timestamp: serverTimestamp() 
                    }); 
                } 
            } 
            alert("Project Closed Successfully."); 
            nav('projects'); 
        };

        window.deleteProject = async () => { 
            if(!confirm("DANGER: This will permanently delete the project and all its data. Continue?")) return; 
            const pwd = prompt("Enter Admin Password to Confirm Delete:"); 
            const settingsRef = doc(db, "settings", "config"); 
            const snap = await getDoc(settingsRef); 
            let correct = "Sandeep@1116"; 
            if(snap.exists() && snap.data().adminPassword) correct = snap.data().adminPassword; 
            if(pwd === correct) { 
                await deleteDoc(doc(db, "projects", currentProjId)); 
                alert("Project Deleted."); 
                nav('projects'); 
            } else { 
                alert("Incorrect Password."); 
            } 
        };

        window.assignVehicle = async () => { 
            const vNo = document.getElementById('regVehicleNo').value; 
            if(!vNo) return; 
            await updateDoc(doc(db, "projects", currentProjId), { assignedVehicles: arrayUnion(vNo) }); 
            document.getElementById('regVehicleNo').value = ""; 
        };
        
        const addBlockBtn = document.getElementById('addBlockBtn'); 
        if (addBlockBtn) { 
            addBlockBtn.addEventListener('click', async () => { 
                const name = document.getElementById('blockName').value; 
                const size = document.getElementById('blockSize').value; 
                const price = document.getElementById('blockPrice').value; 
                const pPrice = document.getElementById('blockPerchPrice').value; 
                if(!name) return; 
                await addDoc(collection(db, `projects/${currentProjId}/blocks`), { 
                    name, 
                    size, 
                    price: parseFloat(price), 
                    perchPrice: parseFloat(pPrice), 
                    status: "available" 
                }); 
                document.getElementById('blockName').value = ""; 
                document.getElementById('blockPrice').value = ""; 
            }); 
        }

        window.loadProjectTasks = (pid) => { 
            onSnapshot(collection(db, `projects/${pid}/tasks`), (snap) => { 
                const list = document.getElementById('adminTaskList'); 
                list.innerHTML = ""; 
                projectTasksData = {}; 
                snap.forEach(d => { 
                    const t = d.data(); 
                    projectTasksData[d.id] = { ...t, projectId: pid }; 
                    let statusBadge = ""; 
                    let actionBtn = ""; 
                    
                    if (t.status === 'completed' || t.status === 'approved') { 
                        statusBadge = '<span class="text-green-600 font-bold text-xs bg-green-100 px-2 rounded">Paid / Approved</span>'; 
                        actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-gray-200 text-gray-700 px-4 py-2 rounded text-xs font-bold hover:bg-gray-300">View</button>`; 
                    } else if (t.status === 'manager_approved') {
                        statusBadge = '<span class="text-blue-600 font-bold text-xs bg-blue-100 px-2 rounded">Manager Approved - Pending Admin</span>'; 
                        actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-blue-600 text-white px-4 py-2 rounded text-xs font-bold shadow hover:bg-blue-700">Admin Review</button>`; 
                    } else { 
                        statusBadge = '<span class="text-gray-400 text-xs bg-gray-100 px-2 rounded">Pending Manager</span>'; 
                        actionBtn = `<button onclick="openApproveModal('${d.id}', 'task')" class="bg-yellow-500 text-white px-4 py-2 rounded text-xs font-bold shadow hover:bg-yellow-600">Manager Review</button>`; 
                    } 
                    
                    let imgHtml = ""; 
                    if(t.photos && t.photos.length > 0) imgHtml = `<img src="${t.photos[0]}" class="w-16 h-16 rounded object-cover ml-4 border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${t.photos[0]}';document.getElementById('imgModal').classList.remove('hidden')">`; 
                    else if(t.photo) imgHtml = `<img src="${t.photo}" class="w-16 h-16 rounded object-cover ml-4 border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${t.photo}';document.getElementById('imgModal').classList.remove('hidden')">`; 
                    
                    const el = document.createElement('div'); 
                    el.className = "bg-white p-4 rounded-xl border border-blue-100 shadow-sm flex justify-between items-center"; 
                    el.innerHTML = `<div class="flex items-center"><div><h4 class="font-bold text-slate-800">${t.title}</h4><p class="text-xs text-gray-500">${t.description||'-'}</p><div class="mt-1">${statusBadge} ${t.submittedCost ? `<span class="ml-2 font-bold">Rs. ${t.submittedCost}</span>` : ''}</div></div>${imgHtml}</div>${actionBtn}`; 
                    list.appendChild(el); 
                }); 
            }); 
        };

        window.processImage = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = (e) => resolve(e.target.result);
                reader.onerror = reject;
                reader.readAsDataURL(file);
            });
        };

        const saveTaskBtn = document.getElementById('saveTaskBtn'); 
        if(saveTaskBtn) { 
            saveTaskBtn.addEventListener('click', async () => { 
                const title = document.getElementById('newTaskTitle').value; 
                const desc = document.getElementById('newTaskDesc').value; 
                const file = document.getElementById('taskPhoto').files[0]; 
                let photoBase64 = null; 
                if(file) photoBase64 = await window.processImage(file); 
                await addDoc(collection(db, `projects/${currentProjId}/tasks`), { 
                    title, 
                    description: desc, 
                    status: 'new', 
                    photo: photoBase64, 
                    createdAt: serverTimestamp() 
                }); 
                document.getElementById('newTaskModal').classList.add('hidden'); 
            }); 
        }

        window.loadMeterReadings = () => { 
            try { 
                const q = collection(db, "meter_readings"); 
                onSnapshot(q, (snap) => { 
                    const list = document.getElementById('readingsList'); 
                    list.innerHTML = ""; 
                    if(snap.empty) { 
                        list.innerHTML = "<p class='text-gray-500 p-4'>No readings found.</p>"; 
                        return; 
                    } 
                    let readings = []; 
                    snap.forEach(d => readings.push({id: d.id, ...d.data()})); 
                    
                    readings.sort((a,b) => new Date(b.date) - new Date(a.date));

                    readings.forEach(r => { 
                        const el = document.createElement('div'); 
                        el.className = "bg-white p-4 rounded-xl shadow-sm border border-blue-100 flex gap-4"; 
                        
                        let statusHtml = "";
                        if (r.status === 'approved') {
                            statusHtml = `<button onclick="openApproveModal('${r.id}', 'meter')" class="mt-2 bg-gray-200 text-gray-700 px-4 py-1 rounded shadow text-sm font-bold">View</button>`;
                        } else if (r.status === 'manager_approved') {
                            statusHtml = `<button onclick="openApproveModal('${r.id}', 'meter')" class="mt-2 bg-blue-600 text-white px-4 py-1 rounded shadow text-sm font-bold">Admin Review</button>`;
                        } else {
                            statusHtml = `<button onclick="openApproveModal('${r.id}', 'meter')" class="mt-2 bg-yellow-500 text-white px-4 py-1 rounded shadow text-sm font-bold">Manager Review</button>`;
                        }

                        el.innerHTML = `<div class="flex-1"><h4 class="font-bold text-lg text-slate-800">${r.vehicleNo}</h4><p class="text-lg text-blue-600 font-bold">Rs. ${r.totalCost.toLocaleString()}</p>${statusHtml}</div>`; 
                        list.appendChild(el); 
                    }); 
                }); 
            } catch(e) { } 
        };

        window.processSale = async (downloadPdf, btnElement) => { 
            let originalText = "";
            if (btnElement) {
                originalText = btnElement.innerHTML;
                btnElement.disabled = true;
                btnElement.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                btnElement.classList.add('opacity-50', 'cursor-not-allowed');
            }

            try { 
                if(!currentProjId || !selectedBlockId) { 
                    return alert("System Error: Project or Block context lost. Please refresh and try again."); 
                } 
                const nic = document.getElementById('cusNIC').value; 
                const name = document.getElementById('cusName').value; 
                const phone = document.getElementById('cusPhone').value; 
                const address = document.getElementById('cusAddress').value; 
                if(!nic || !name) return alert("Customer Name and NIC are required!"); 
                
                let customerId = ""; 
                const q = query(collection(db, "customers"), where("nic", "==", nic)); 
                const snap = await getDocs(q); 
                if(!snap.empty) { 
                    customerId = snap.docs[0].data().customerId; 
                } else { 
                    const nicPrefix = nic.substring(0, 5); 
                    const randomNum = Math.floor(Math.random() * 10); 
                    const randomChar = String.fromCharCode(65 + Math.floor(Math.random() * 26)); 
                    customerId = `${nicPrefix}${randomNum}${randomChar}`; 
                } 
                
                await addDoc(collection(db, "customers"), { 
                    customerId, name, nic, phone, address, joinedDate: new Date(), projectName: currentProjName, projectId: currentProjId, blockName: selectedBlockData.name, blockId: selectedBlockId 
                }); 
                
                const cus = { customerId, name, address, nic, phone }; 
                const price = parseFloat(document.getElementById('finalPrice').value); 
                const plan = document.getElementById('payPlanType').value; 
                const planFee = parseFloat(document.getElementById('planFee').value) || 0; 
                const deedFee = parseFloat(document.getElementById('deedFee').value) || 0; 
                const agreementFee = parseFloat(document.getElementById('agreementFee').value) || 0;
                const salespersonName = document.getElementById('salesPersonInput').value; 
                
                let ep = {}; 
                let nextD = null; 
                let status = 'sold'; 
                let paidNow = 0; 
                
                if(plan === 'EP') { 
                    const cycle = parseInt(document.getElementById('epCycle').value) || 30; 
                    const rate = parseFloat(document.getElementById('epRate').value); 
                    const months = parseFloat(document.getElementById('epMonths').value); 
                    const booking = parseFloat(document.getElementById('bookingFee').value) || 0; 
                    const dpPct = parseFloat(document.getElementById('downPayPct').value); 
                    const dpTotal = price * (dpPct / 100); 
                    const loanAmt = price - dpTotal; 
                    let totalPayable = 0; 
                    
                    if (rate === 0) { 
                        totalPayable = loanAmt; 
                    } else { 
                        const r = (rate / 100) / 12; 
                        const emi = (loanAmt * r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1); 
                        totalPayable = emi * months; 
                    } 
                    
                    const isDpComplete = booking >= (dpTotal - 100);
                    ep = { 
                        rate: rate, months: months, cycleDays: cycle, totalPayable: totalPayable, paidAmount: 0, downPayment: { required: dpTotal, paid: booking, isComplete: isDpComplete } 
                    }; 
                    const d = new Date(); d.setDate(d.getDate() + cycle); nextD = d; paidNow = booking; 

                    if(agreementFee > 0) {
                        await recordDailyTransaction(`Agreement Fee: ${selectedBlockData.name} (${cus.name})`, agreementFee, 'income', currentProjName);
                    }
                } else { 
                    paidNow = parseFloat(document.getElementById('cashAdvancePay').value) || 0; 
                    if(paidNow >= price) status = 'sold_finished'; 
                } 
                
                if(salespersonName) { 
                    const comm = price * 0.0075; 
                    await addDoc(collection(db, `projects/${currentProjId}/expenses`), { 
                        description: `Commission: ${salespersonName} (Block ${selectedBlockData.name})`, amount: comm, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() 
                    }); 
                    await recordDailyTransaction(`Commission: ${salespersonName}`, comm, 'expense', currentProjName); 
                    const s = staffListCache.find(x => x.name === salespersonName); 
                    if(s) { 
                        await addDoc(collection(db, `staff/${s.id}/earnings`), { 
                            date: new Date(), amount: comm, type: 'Commission', description: `Commission: ${selectedBlockData.name} (${currentProjName})` 
                        }); 
                    } 
                } 
                
                const poolComm = price * 0.0025; 
                await addDoc(collection(db, "transactions"), { 
                    date: new Date().toLocaleDateString('en-CA'), description: `Staff Pool: ${selectedBlockData.name} - ${currentProjName}`, amount: poolComm, type: 'Income', category: 'Staff Welfare', timestamp: serverTimestamp() 
                }); 
                
                const histEntry = {date: new Date(), amount: paidNow, type: plan === 'EP' ? 'Booking Fee' : 'Payment'}; 
                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { 
                    status: status, soldPrice: price, customer: cus, soldDate: new Date(), fees: { planFee, deedFee, agreementFee }, payment: { totalPrice: price, advancePaid: paidNow, planType: plan, epDetails: ep, nextPaymentDate: nextD, history: [histEntry] } 
                }); 
                
                await recordDailyTransaction(`Sale Payment: ${selectedBlockData.name} - ${cus.name}`, paidNow, 'income', currentProjName); 
                
                selectedBlockData.customer = cus; 
                selectedBlockData.projectName = currentProjName; 
                selectedBlockData.payment = { totalPrice: price, planType: plan }; 
                
                if(downloadPdf) { 
                    document.getElementById('newPayAmount').value = paidNow; 
                    document.getElementById('newPayDate').valueAsDate = new Date(); 
                    await downloadPaymentReceipt(); 
                    closeSellModal(); 
                } else { 
                    alert("Sale Complete!"); 
                    closeSellModal(); 
                } 
            } catch (error) { 
                console.error("Process Sale Error:", error); 
                alert("Error processing sale. Please check your connection and try again.\nError: " + error.message); 
            } finally {
                if (btnElement) {
                    btnElement.disabled = false;
                    btnElement.innerHTML = originalText;
                    btnElement.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            }
        };

        window.openPaymentModal = async (data) => {
            selectedBlockData = data; 
            if(document.getElementById('paymentModal')) document.getElementById('paymentModal').classList.remove('hidden');
            const isFin = data.status === 'sold_finished'; 
            const isEP = data.payment && data.payment.planType === 'EP';
            if(document.getElementById('addPaymentSection')) document.getElementById('addPaymentSection').style.display = isFin ? 'none' : 'block'; 
            if(document.getElementById('editPlanBtn')) document.getElementById('editPlanBtn').style.display = (isFin || !isEP) ? 'none' : 'block'; 
            if(document.getElementById('resellBtn')) document.getElementById('resellBtn').classList.toggle('hidden', isFin); 
            if(document.getElementById('paymentCompleteMsg')) document.getElementById('paymentCompleteMsg').classList.toggle('hidden', !isFin);
            if(document.getElementById('payBlockInfo')) document.getElementById('payBlockInfo').innerText = `${data.name} - ${data.customer.name}`; 
            if(document.getElementById('viewCusId')) document.getElementById('viewCusId').innerText = data.customer.customerId || "N/A"; 
            if(document.getElementById('viewCusNIC')) document.getElementById('viewCusNIC').innerText = data.customer.nic || "N/A"; 
            if(document.getElementById('viewCusPhone')) document.getElementById('viewCusPhone').innerText = data.customer.phone || "N/A"; 
            if(document.getElementById('viewCusAddr')) document.getElementById('viewCusAddr').innerText = data.customer.address || "N/A";
            
            let total = 0, paid = 0; 
            if(isEP) { 
                const loanPayable = data.payment.epDetails.totalPayable; 
                const dpReq = data.payment.epDetails.downPayment.required; 
                total = loanPayable + dpReq; 
                
                const epPaid = data.payment.epDetails.paidAmount || 0; 
                const dpPaid = data.payment.epDetails.downPayment.paid || 0; 
                paid = epPaid + dpPaid;
            } else if (data.payment) { 
                total = data.soldPrice; 
                paid = (data.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0); 
            }
            
            if(document.getElementById('pmTotal')) document.getElementById('pmTotal').innerText = total.toLocaleString(); 
            if(document.getElementById('pmPaid')) document.getElementById('pmPaid').innerText = paid.toLocaleString(); 
            if(document.getElementById('pmBalance')) document.getElementById('pmBalance').innerText = (total-paid).toLocaleString();
            
            const cycleSec = document.getElementById('epCycleSection'); 
            const preInfo = document.getElementById('epPreStageInfo'); 
            const instInfo = document.getElementById('epInstallmentInfo');
            
            if(isEP && cycleSec) {
                cycleSec.classList.remove('hidden');
                const dp = data.payment.epDetails.downPayment;
                const dpDone = dp.paid >= (dp.required - 100); 
                document.getElementById('epDpTarget').innerText = dp.required.toLocaleString(); 
                document.getElementById('epDpPaid').innerText = dp.paid.toLocaleString();
                if(!dpDone) {
                    preInfo.classList.remove('hidden'); instInfo.classList.add('hidden');
                    const bal = dp.required - dp.paid; 
                    document.getElementById('epDpDueMsg').innerText = `Finish Down Payment (Due: Rs. ${bal.toLocaleString()})`;
                } else {
                    preInfo.classList.add('hidden'); instInfo.classList.remove('hidden');
                    
                    const totalPaid = (data.payment.epDetails.paidAmount || 0) + (data.payment.epDetails.downPayment.paid || 0);
                    const outstandingPrincipal = Math.max(0, data.soldPrice - totalPaid);
                    
                    document.getElementById('epRealtimeFuture').innerText = "Rs. " + outstandingPrincipal.toLocaleString();
                    document.getElementById('epRealtimeFuture').dataset.val = outstandingPrincipal;

                    const totalLoan = data.soldPrice - data.payment.epDetails.downPayment.required;
                    const annualRate = data.payment.epDetails.rate || 0;
                    const months = data.payment.epDetails.months || 1;
                    const totalPayable = data.payment.epDetails.totalPayable || 0;
                    
                    const fixedEmi = totalPayable / months;
                    const loanPaid = data.payment.epDetails.paidAmount || 0;
                    const totalRemaining = Math.max(0, totalPayable - loanPaid);

                    const paidPct = loanPaid / totalPayable;
                    const currentOutstandingCapital = Math.max(0, totalLoan * (1 - paidPct));
                    
                    document.getElementById('epRealtimeFuture').innerText = "Rs. " + currentOutstandingCapital.toLocaleString(undefined, {maximumFractionDigits: 2});
                    document.getElementById('epRealtimeFuture').dataset.val = currentOutstandingCapital;

                    let thisMonthInterest = 0, thisMonthCapital = 0, thisMonthPayable = 0;

                    if (totalRemaining > 0) {
                        const monthlyRate = (annualRate / 12) / 100;
                        thisMonthInterest = currentOutstandingCapital * monthlyRate;
                        thisMonthCapital = fixedEmi - thisMonthInterest;
                        thisMonthPayable = Math.min(fixedEmi, totalRemaining);
                    }

                    document.getElementById('epNextDueAmt').innerHTML = `
                        <div class="flex justify-between text-[10px] text-slate-500 font-normal">
                            <span>Capital</span>
                            <span>${thisMonthCapital.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="flex justify-between text-[10px] text-slate-500 font-normal">
                            <span>Interest</span>
                            <span>${thisMonthInterest.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                        </div>
                        <div class="border-t border-indigo-200 mt-1 pt-1 text-lg">Rs. ${thisMonthPayable.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    `;
                    
                    let nextMonthPayable = totalRemaining > fixedEmi ? Math.min(fixedEmi, totalRemaining - fixedEmi) : 0;
                    document.getElementById('epFutureDueAmt').innerText = "Rs. " + nextMonthPayable.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});
                }
            } else if (cycleSec) { 
                cycleSec.classList.add('hidden'); 
                if(document.getElementById('epRealtimeFuture')) document.getElementById('epRealtimeFuture').innerText = "N/A"; 
            }
            
            const tbody = document.getElementById('paymentHistoryList'); 
            if(tbody) {
                tbody.innerHTML = ""; 
                (data.payment.history||[]).forEach(h => { 
                    const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); 
                    tbody.innerHTML += `<tr><td class="py-2">${d.toLocaleDateString()}</td><td class="font-bold">Rs.${(h.amount||0).toLocaleString()}</td><td class="text-gray-500">${h.type}</td></tr>`; 
                }); 
            }
            if(document.getElementById('newPayDate')) document.getElementById('newPayDate').valueAsDate = new Date(); 
            if(isEP) updateCycleUI(data); 
        };

        const submitPayBtn = document.getElementById('submitPayBtn');
        if(submitPayBtn) {
            submitPayBtn.addEventListener('click', async (e) => {
                const amt = parseFloat(document.getElementById('newPayAmount').value); 
                if(!amt) return;

                const btn = document.getElementById('submitPayBtn');
                const originalText = btn.innerHTML;
                btn.disabled = true;
                btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Processing...';
                btn.classList.add('opacity-50', 'cursor-not-allowed');

                try {
                    const b = selectedBlockData;
                    let updateData = { "payment.history": arrayUnion({date: new Date(), amount: amt, type: 'Payment'}) };
                    let closeAccount = false;

                    if (b.payment.planType === 'EP') {
                        const dp = b.payment.epDetails.downPayment;
                        if(dp.paid < (dp.required - 100)) {
                            const newDpPaid = dp.paid + amt;
                            updateData["payment.epDetails.downPayment.paid"] = newDpPaid;
                            updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Down Payment Part'});
                            if(newDpPaid >= (dp.required - 100)) {
                                updateData["payment.epDetails.downPayment.isComplete"] = true;
                                const nextD = new Date(); nextD.setDate(nextD.getDate() + 30); 
                                updateData["payment.nextPaymentDate"] = nextD;
                            }
                        } else {
                            const settlementVal = parseFloat(document.getElementById('epRealtimeFuture').dataset.val || 999999999);
                            const newEpPaid = (b.payment.epDetails.paidAmount || 0) + amt;
                            updateData["payment.epDetails.paidAmount"] = newEpPaid;
                            updateData["payment.history"] = arrayUnion({date: new Date(), amount: amt, type: 'Installment'});
                            
                            if(amt >= (settlementVal - 100)) {
                                closeAccount = true;
                                updateData["status"] = "sold_finished";
                                updateData["payment.epDetails.totalPayable"] = newEpPaid; 
                            } else if(newEpPaid >= (b.payment.epDetails.totalPayable - 100)) {
                                closeAccount = true;
                                updateData["status"] = "sold_finished";
                            } else {
                                const cycleDays = parseInt(b.payment.epDetails.cycleDays || 30);
                                const currentNext = b.payment.nextPaymentDate.seconds ? new Date(b.payment.nextPaymentDate.seconds*1000) : new Date(b.payment.nextPaymentDate);
                                const oneInst = b.payment.epDetails.totalPayable / b.payment.epDetails.months;
                                if(amt >= (oneInst/2)) { 
                                    currentNext.setDate(currentNext.getDate() + cycleDays); 
                                    updateData["payment.nextPaymentDate"] = currentNext; 
                                }
                            }
                        }
                    } else {
                        const prevPaid = (b.payment.history || []).reduce((sum, h) => sum + (h.amount || 0), 0);
                        const currentPaid = prevPaid + amt;
                        if (currentPaid >= b.soldPrice - 100) {
                            closeAccount = true;
                            updateData["status"] = "sold_finished";
                        }
                    }

                    await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), updateData);
                    await recordDailyTransaction(`Payment: ${b.name}`, amt, 'income', currentProjName);
                    document.getElementById('paymentModal').classList.add('hidden');
                    alert(closeAccount ? "Payment Added & Account Closed!" : "Payment Added!");

                } catch (error) {
                    console.error("Payment Error: ", error);
                    alert("Payment failed. Please try again.");
                } finally {
                    btn.disabled = false;
                    btn.innerHTML = originalText;
                    btn.classList.remove('opacity-50', 'cursor-not-allowed');
                }
            });
        }
window.downloadPaymentReceipt = async () => { 
            const amt = parseFloat(document.getElementById('newPayAmount').value || 0); 
            const date = document.getElementById('newPayDate').value; 
            const cus = selectedBlockData.customer || {name:'-', nic:'-'}; 
            const html = `<div class="receipt-box"><div class="receipt-header"><img src="ico.jpeg" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; margin: 0 auto 10px auto; display: block; border: 2px solid #1e3a8a;"><h2 class="receipt-title">OFFICIAL RECEIPT</h2><p>Sithuliya Real Estate</p><p style="font-size:12px;">Kurunegala, Sri Lanka</p></div><div style="margin-bottom:20px; font-size:14px;"><p><strong>Date:</strong> ${date}</p><p><strong>Receipt No:</strong> #${Math.floor(10000 + Math.random() * 90000)}</p></div><div style="border-top:2px solid #eee; border-bottom:2px solid #eee; padding:15px 0;"><div class="receipt-row"><span class="receipt-label">Customer Name</span><span class="receipt-value">${cus.name}</span></div><div class="receipt-row"><span class="receipt-label">Customer NIC</span><span class="receipt-value">${cus.nic}</span></div><div class="receipt-row"><span class="receipt-label">Project</span><span class="receipt-value">${selectedBlockData.projectName || currentProjName}</span></div><div class="receipt-row"><span class="receipt-label">Block Number</span><span class="receipt-value">${selectedBlockData.name}</span></div><div class="receipt-row"><span class="receipt-label">Payment Plan</span><span class="receipt-value">${selectedBlockData.payment.planType}</span></div></div><div style="margin-top:20px; background:#f9f9f9; padding:15px;"><div class="receipt-row" style="font-size:18px;"><span class="receipt-label">AMOUNT PAID</span><span class="receipt-value">Rs. ${amt.toLocaleString()}.00</span></div></div><div class="receipt-footer"><div><div class="sign-line">Cashier Signature</div></div><div><div class="sign-line">Customer Signature</div></div></div><p style="text-align:center; font-size:10px; margin-top:20px; color:#888;">Thank you for your business!</p></div>`; 
            document.getElementById('printContainer').innerHTML = html; 
            document.getElementById('pdfPreviewOverlay').style.display = 'block'; 
        };

        window.downloadPaymentHistory = async () => { 
            let rows = ""; 
            (selectedBlockData.payment.history || []).forEach(h => { 
                const d = h.date.seconds ? new Date(h.date.seconds*1000) : new Date(h.date); 
                rows += `<tr><td style="border-bottom:1px solid #ddd; padding:8px;">${d.toLocaleDateString()}</td><td style="border-bottom:1px solid #ddd; padding:8px;">${h.type}</td><td style="border-bottom:1px solid #ddd; padding:8px; text-align:right">Rs. ${h.amount.toLocaleString()}</td></tr>`; 
            }); 
            document.getElementById('printContainer').innerHTML = `<div style="text-align:center; margin-bottom:15px;"><img src="ico.jpeg" style="width: 70px; height: 70px; object-fit: cover; border-radius: 50%; border: 2px solid #1e3a8a;"></div><h2 class="text-center text-xl underline mb-4">PAYMENT HISTORY</h2><table style="width:100%; border-collapse:collapse; margin-top:20px;"><thead><tr style="background:#f2f2f2;"><th>Date</th><th>Type</th><th style="text-align:right">Amount</th></tr></thead><tbody>${rows}</tbody></table>`; 
            document.getElementById('pdfPreviewOverlay').style.display = 'block'; 
        };

        function updateCycleUI(data) { 
            const container = document.getElementById('epCycleSection'); 
            if (data.payment.planType !== 'EP') { if(container) container.classList.add('hidden'); return; } 
            const dp = data.payment.epDetails.downPayment; 
            if(dp.paid < (dp.required - 100)) return; 
            const fill = document.getElementById('cycleProgressBar'); 
            const label = document.getElementById('cycleStatusLabel'); 
            const daysLabel = document.getElementById('cycleDaysLeft'); 
            document.getElementById('dispRate').innerText = (data.payment.epDetails.rate || 0) + "%"; 
            document.getElementById('dispMonths').innerText = (data.payment.epDetails.months || 0) + " M"; 
            const nextD = data.payment.nextPaymentDate.seconds ? new Date(data.payment.nextPaymentDate.seconds*1000) : new Date(data.payment.nextPaymentDate); 
            const cycleDays = parseInt(data.payment.epDetails.cycleDays || 30); 
            const today = new Date(); 
            const startD = new Date(nextD); startD.setDate(startD.getDate() - cycleDays); 
            if (today <= nextD) { 
                const totalTime = nextD - startD, elapsed = today - startD; 
                const percent = Math.min(100, Math.max(0, (elapsed / totalTime) * 100)); 
                fill.style.width = percent + "%"; fill.className = "h-full progress-bar-fill bg-blue-500"; 
                label.innerText = "Cycle Progress"; label.className = "text-[10px] font-bold uppercase text-blue-600"; 
                daysLabel.innerText = Math.ceil((nextD - today)/(1000*60*60*24)) + " days left"; 
            } else { 
                const diffTime = today - nextD; 
                const diffDays = diffTime / (1000*60*60*24); 
                const gracePercent = Math.min(100, (diffDays / 5) * 100); 
                fill.style.width = gracePercent + "%"; fill.className = "h-full progress-bar-fill bg-red-600"; 
                label.innerText = "OVERDUE (Grace Period)"; label.className = "text-[10px] font-bold uppercase text-red-600 animate-pulse"; 
                daysLabel.innerText = "Penalty in " + Math.max(0, Math.ceil(5 - diffDays)) + " days"; 
                if (diffDays >= 5) applyLatePenalty(data); 
            } 
        }

        async function applyLatePenalty(data) { 
            const lastHist = data.payment.history[data.payment.history.length-1]; 
            if (lastHist && lastHist.type.includes('Penalty') && new Date(lastHist.date.seconds*1000).toDateString() === new Date().toDateString()) return; 
            const bal = data.payment.epDetails.totalPayable - data.payment.epDetails.paidAmount; 
            const penalty = bal * 0.04; 
            const newTotal = data.payment.epDetails.totalPayable + penalty; 
            const newNext = new Date(); newNext.setDate(newNext.getDate() + parseInt(data.payment.epDetails.cycleDays || 30)); 
            await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { 
                "payment.epDetails.totalPayable": newTotal, 
                "payment.nextPaymentDate": newNext, 
                "payment.history": arrayUnion({date: new Date(), amount: 0, type: 'Late Penalty (4%)', note: 'Added automatically'}) 
            }); 
            await addDoc(collection(db, "notifications"), { title: "Penalty Applied", message: `4% added to ${data.customer.name}`, timestamp: serverTimestamp() }); 
        }

        window.toggleEditPlan = () => document.getElementById('editPlanSection').classList.toggle('hidden');
        
        const savePlanBtn = document.getElementById('savePlanChangesBtn'); 
        if(savePlanBtn) { 
            savePlanBtn.addEventListener('click', async () => { 
                const rate = parseFloat(document.getElementById('editNewRate').value); 
                const months = parseFloat(document.getElementById('editNewMonths').value); 
                if(!rate || !months) return alert("Please enter valid Rate and Months"); 
                await updateDoc(doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`), { "payment.epDetails.rate": rate, "payment.epDetails.months": months }); 
                alert("Updated!"); 
                document.getElementById('paymentModal').classList.add('hidden'); 
            }); 
        }

        window.processResell = async () => { 
            if(!confirm("Cancel sale and make available again?")) return; 
            const b = selectedBlockData; 
            const paid = b.payment.epDetails ? b.payment.epDetails.paidAmount : b.soldPrice; 
            
            await addDoc(collection(db, `projects/${currentProjId}/expenses`), { 
                description: `REFUND: ${b.name}`, amount: paid, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() 
            }); 
            await recordDailyTransaction(`REFUND: ${b.name}`, paid, 'expense', currentProjName); 
            
            const blockRef = doc(db, `projects/${currentProjId}/blocks/${selectedBlockId}`);
            await updateDoc(blockRef, { 
                status: 'available', 
                customer: deleteField(), 
                payment: deleteField(), 
                soldPrice: deleteField(), 
                soldDate: deleteField(),
                fees: deleteField()
            }); 
            
            alert("Sale Cancelled & Block made Available!"); 
            document.getElementById('paymentModal').classList.add('hidden'); 
        };

        const saveExpBtn = document.getElementById('saveExpenseBtn'); 
        if(saveExpBtn) { 
            saveExpBtn.addEventListener('click', async () => { 
                const amt = parseFloat(document.getElementById('expAmount').value); 
                const desc = document.getElementById('expDesc').value; 
                await addDoc(collection(db, `projects/${currentProjId}/expenses`), { 
                    description: desc, amount: amt, date: new Date().toLocaleDateString('en-CA'), createdAt: serverTimestamp() 
                }); 
                await recordDailyTransaction(`Expense: ${desc}`, amt, 'expense', currentProjName); 
                document.getElementById('expenseModal').classList.add('hidden'); 
            }); 
        }

        window.calcBlockPrice = () => { 
            const size = parseFloat(document.getElementById('blockSize').value) || 0; 
            const pPrice = parseFloat(document.getElementById('blockPerchPrice').value) || 0; 
            const total = size * pPrice; 
            document.getElementById('blockPrice').value = total > 0 ? total : ''; 
        };

        window.toggleEPFields = () => { 
            const plan = document.getElementById('payPlanType').value; 
            const isEP = plan === 'EP'; 
            document.getElementById('epFields').classList.toggle('hidden', !isEP); 
            document.getElementById('cashFields').classList.toggle('hidden', isEP); 
            if(isEP) window.calculateEP(); 
        };

        window.calculateEP = () => { 
            const price = parseFloat(document.getElementById('finalPrice').value)||0; 
            const booking = parseFloat(document.getElementById('bookingFee').value)||0; 
            const pct = parseFloat(document.getElementById('downPayPct').value)||40; 
            const dpAmount = price * (pct / 100); 
            document.getElementById('downPayAmount').value = dpAmount; 
            const dpBal = dpAmount - booking; 
            document.getElementById('downPayBalanceDisp').innerText = dpBal.toLocaleString(); 
            const loanAmt = price - dpAmount; 
            document.getElementById('loanAmount').value = loanAmt.toLocaleString(); 
            const rate = parseFloat(document.getElementById('epRate').value)||15; 
            const months = parseFloat(document.getElementById('epMonths').value)||60; 
            let monthly = 0; 
            let totalPayable = 0; 
            if (rate === 0) { 
                monthly = loanAmt / months; 
                totalPayable = loanAmt; 
            } else { 
                const r = (rate / 100) / 12; 
                monthly = (loanAmt * r * Math.pow(1 + r, months)) / (Math.pow(1 + r, months) - 1); 
                totalPayable = monthly * months; 
            } 
            document.getElementById('epMonthlyInst').innerText = monthly.toLocaleString(undefined, {maximumFractionDigits: 2}); 
            document.getElementById('epTotalPayable').innerText = totalPayable.toLocaleString(undefined, {maximumFractionDigits: 2}); 
            const deedFee = (price * 0.05) - 1000; 
            document.getElementById('deedFee').value = deedFee > 0 ? deedFee : 0; 
        };

        function loadBlocks(pid, isDevMode) { 
            if(!pid) return; 
            const container = document.getElementById('blocksContainer'); 
            if(!container) return; 
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { 
                container.innerHTML = ""; 
                if(snap.empty) { 
                    container.innerHTML = "<div class='col-span-full text-center text-gray-400 py-10'>No blocks added yet.</div>"; 
                    return; 
                } 
                snap.forEach(d => { 
                    const b = d.data(); 
                    const isSold = b.status === 'sold'; 
                    const isFin = b.status === 'sold_finished'; 
                    let bgClass = 'bg-white border-blue-100 hover:border-blue-400'; 
                    let statusText = `Rs.${(b.price || 0).toLocaleString()}`; 
                    let statusColor = 'text-blue-600'; 
                    if (isFin) { 
                        bgClass = 'bg-slate-800 text-white'; 
                        statusText = 'CLOSED'; 
                        statusColor = 'text-green-400'; 
                    } else if (isSold) { 
                        bgClass = 'bg-red-50 border-red-200'; 
                        statusText = 'SOLD'; 
                        statusColor = 'text-red-600'; 
                    } 
                    const el = document.createElement('div'); 
                    el.className = `p-4 border-2 rounded-xl text-center cursor-pointer relative overflow-hidden transition transform hover:scale-105 ${bgClass}`; 
                    el.innerHTML = ` <h4 class="font-bold text-xl">${b.name}</h4> <p class="text-xs ${isFin?'text-gray-400':'text-gray-500'}">${b.size}P</p> <p class="font-bold mt-2 ${statusColor}">${statusText}</p> `; 
                    el.onclick = () => { 
                        selectedBlockId = d.id; 
                        selectedBlockData = b; 
                        if(isSold || isFin) { 
                            openPaymentModal(b); 
                        } else { 
                            openSellModal(); 
                        } 
                    }; 
                    container.appendChild(el); 
                }); 
            }); 
        }

        function openSellModal() { 
            document.getElementById('sellModal').classList.remove('hidden'); 
            document.getElementById('sellBlockName').innerText = selectedBlockData.name; 
            document.getElementById('finalPrice').value = selectedBlockData.price; 
            document.getElementById('payPlanType').value = "Cash"; 
            toggleEPFields(); 
        }

        function loadExpensesAndProfit(pid) { 
            if(!pid) return; 
            onSnapshot(collection(db, `projects/${pid}/expenses`), (snap) => { 
                const list = document.getElementById('expenseList'); 
                if(!list) return; 
                list.innerHTML = ""; 
                let totalExp = 0; 
                snap.forEach(d => { 
                    const e = d.data(); 
                    totalExp += e.amount; 
                    list.innerHTML += `<tr class="border-b hover:bg-gray-50"><td class="p-3">${e.date}</td><td class="p-3">${e.description}</td><td class="p-3 font-bold text-red-600">Rs. ${e.amount.toLocaleString()}</td></tr>`; 
                }); 
                if(document.getElementById('finExpense')) { 
                    document.getElementById('finExpense').innerText = "Rs. " + totalExp.toLocaleString(); 
                    updateNet(null, totalExp); 
                } 
            }); 
            onSnapshot(collection(db, `projects/${pid}/blocks`), (snap) => { 
                let inc = 0; 
                snap.forEach(b => { 
                    const bd = b.data(); 
                    if(bd.status.includes('sold')) inc += (bd.soldPrice || bd.price); 
                }); 
                if(document.getElementById('finIncome')) { 
                    document.getElementById('finIncome').innerText = "Rs. " + inc.toLocaleString(); 
                    updateNet(inc, null); 
                } 
            }); 
        }

        async function recordDailyTransaction(desc, amt, type, proj) { 
            await addDoc(collection(db, "transactions"), { 
                date: new Date().toLocaleDateString('en-CA'), 
                description: desc, 
                amount: amt, 
                type: type === 'income' ? 'Income' : 'Expense', 
                category: proj || 'General', 
                timestamp: serverTimestamp() 
            }); 
        }

        window.openStaffAccess = () => { 
            document.getElementById('staffAccessModal').classList.remove('hidden'); 
            document.getElementById('staffAccessInput').focus(); 
        };

        window.verifyStaffAccess = async () => { 
            const input = document.getElementById('staffAccessInput').value; 
            const btn = document.querySelector('#staffAccessModal button.bg-blue-600');
            const originalText = btn.innerText;
            
            btn.innerText = "Verifying...";
            btn.disabled = true;
            btn.classList.add('opacity-50', 'cursor-not-allowed');

            let pin = "1234"; 
            
            try { 
                const s = await getDoc(doc(db, "settings", "staff_config")); 
                if(s.exists() && s.data().accessPassword) {
                    pin = s.data().accessPassword; 
                }
            } catch(e) {
                console.error("Auth Check Failed:", e);
            } 
            
            btn.innerText = originalText;
            btn.disabled = false;
            
            if (input === pin) {
                document.getElementById('staffAccessModal').classList.add('hidden');
                document.getElementById('staffAccessInput').value = "";
                nav('staff');
            } else {
                alert("Invalid Access PIN");
            }
        };

        window.handleGlobalSearch = async () => {
            const input = document.getElementById('projSearch').value.toLowerCase();
            const resDiv = document.getElementById('searchResults');
            if (input.length < 2) { resDiv.classList.add('hidden'); return; }
            resDiv.innerHTML = "<div class='p-4 text-center text-gray-500'>Searching...</div>";
            resDiv.classList.remove('hidden');
            let resultsHtml = "";
            try {
                const cSnap = await getDocs(collection(db, "customers"));
                cSnap.forEach(d => {
                    const c = d.data();
                    if(c.name.toLowerCase().includes(input) || c.nic.toLowerCase().includes(input)) {
                        resultsHtml += `<div class="p-3 border-b hover:bg-blue-50 cursor-pointer" onclick="navigateToBlock('${c.projectId}', '${c.blockId}')"><p class="font-bold text-sm text-blue-900"><i class="fas fa-user mr-2 text-blue-400"></i>${c.name}</p><p class="text-xs text-gray-500">${c.nic} | ${c.projectName} - Block ${c.blockName}</p></div>`;
                    }
                });
                const pSnap = await getDocs(collection(db, "projects"));
                pSnap.forEach(d => {
                    const p = d.data();
                    if(p.name.toLowerCase().includes(input)) {
                        resultsHtml += `<div class="p-3 border-b hover:bg-green-50 cursor-pointer" onclick="window.openProject('${d.id}', {name: '${p.name}', status: '${p.status}', area: '${p.area}'}); document.getElementById('searchResults').classList.add('hidden');"><p class="font-bold text-sm text-green-900"><i class="fas fa-map-marked mr-2 text-green-400"></i>${p.name}</p><p class="text-xs text-gray-500">Project / Development</p></div>`;
                    }
                });
                resDiv.innerHTML = resultsHtml || "<div class='p-4 text-center text-gray-500'>No matches found.</div>";
            } catch(e) {
                console.log(e);
                resDiv.innerHTML = "<div class='p-4 text-center text-red-500'>Search error.</div>";
            }
        };

        window.navigateToBlock = async (pid, bid) => {
            document.getElementById('searchResults').classList.add('hidden');
            currentProjId = pid;
            const pSnap = await getDoc(doc(db, "projects", pid));
            if(!pSnap.exists()) return alert("Project deleted or missing.");
            currentProjName = pSnap.data().name;
            const bSnap = await getDoc(doc(db, `projects/${pid}/blocks/${bid}`));
            if(bSnap.exists()) {
                selectedBlockId = bid;
                selectedBlockData = bSnap.data();
                if(!selectedBlockData.projectName) selectedBlockData.projectName = pSnap.data().name;
                window.openPaymentModal(selectedBlockData);
            } else {
                alert("Block data not found!");
            }
        };

        window.openApproveModal = async (id, type) => {
            if(type === 'task') {
                let t = projectTasksData[id];
                if (!t) {
                     const notifTask = notifState.tasks.find(x => x.id === id);
                     if (notifTask) t = notifTask;
                }
                
                if(!t) {
                    try {
                        if(currentProjId) {
                            const snap = await getDoc(doc(db, `projects/${currentProjId}/tasks/${id}`));
                            if(snap.exists()) t = { ...snap.data(), projectId: currentProjId };
                        }
                    } catch(e) { console.error("Fetch task error", e); }
                }

                if(!t) return alert("Task details loading... Please try again or open Project first.");
                
                document.getElementById('taskApproveModal').classList.remove('hidden');
                document.getElementById('taskModalHeader').innerText = "Review Site Task";
                document.getElementById('approveTaskTitle').innerText = t.title;
                document.getElementById('approveTaskCost').innerText = t.submittedCost ? "Rs. " + t.submittedCost.toLocaleString() : "Not Submitted";
                document.getElementById('approveTaskTimeInfo').innerText = "Submitted by Site Manager";
                
                let imgHtml = "";
                if(t.photos) {
                    t.photos.forEach(p => {
                        imgHtml += `<img src="${p}" class="w-full h-48 object-cover rounded border cursor-pointer hover:opacity-80" onclick="document.getElementById('imgModalSrc').src='${p}';document.getElementById('imgModal').classList.remove('hidden')">`;
                    });
                } else if (t.photo) {
                    imgHtml = `<img src="${t.photo}" class="w-full h-48 object-cover rounded border cursor-pointer hover:opacity-80" onclick="document.getElementById('imgModalSrc').src='${t.photo}';document.getElementById('imgModal').classList.remove('hidden')">`;
                }
                document.getElementById('approveTaskPhotos').innerHTML = imgHtml;

                const manBtn = document.getElementById('managerApproveTaskBtn');
                const adminBtn = document.getElementById('confirmApproveTaskBtn');
                manBtn.classList.add('hidden');
                adminBtn.classList.add('hidden');
                
                const status = t.status || 'new';
                if (status === 'manager_approved') {
                    adminBtn.classList.remove('hidden');
                    adminBtn.onclick = () => window.adminApproveTask(id);
                } else if (status !== 'completed' && status !== 'approved') {
                    manBtn.classList.remove('hidden');
                    manBtn.onclick = () => window.managerApproveTask(id);
                }
            } else if (type === 'meter') {
                const docSnap = await getDoc(doc(db, "meter_readings", id));
                if(!docSnap.exists()) return;
                const r = docSnap.data();
                
                document.getElementById('taskApproveModal').classList.remove('hidden');
                document.getElementById('taskModalHeader').innerText = "Review Meter Reading";
                document.getElementById('approveTaskTitle').innerText = "Vehicle: " + r.vehicleNo;
                document.getElementById('approveTaskCost').innerText = "Rs. " + (r.totalCost || 0).toLocaleString();
                document.getElementById('approveTaskTimeInfo').innerText = `Date: ${r.date} | Distance: ${r.distance}km`;
                
                let imgHtml = "";
                if(r.startPhoto) imgHtml += `<div><p class="text-xs font-bold mb-1 text-gray-500">Start Meter</p><img src="${r.startPhoto}" class="w-full h-48 object-cover rounded border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${r.startPhoto}';document.getElementById('imgModal').classList.remove('hidden')"></div>`;
                if(r.endPhoto) imgHtml += `<div><p class="text-xs font-bold mb-1 text-gray-500">End Meter</p><img src="${r.endPhoto}" class="w-full h-48 object-cover rounded border cursor-pointer" onclick="document.getElementById('imgModalSrc').src='${r.endPhoto}';document.getElementById('imgModal').classList.remove('hidden')"></div>`;
                document.getElementById('approveTaskPhotos').innerHTML = imgHtml;

                const manBtn = document.getElementById('managerApproveTaskBtn');
                const adminBtn = document.getElementById('confirmApproveTaskBtn');
                manBtn.classList.add('hidden');
                adminBtn.classList.add('hidden');

                if (r.status === 'pending') {
                    manBtn.classList.remove('hidden');
                    manBtn.onclick = () => window.managerApproveMeter(id);
                } else if (r.status === 'manager_approved') {
                    adminBtn.classList.remove('hidden');
                    adminBtn.onclick = () => window.adminApproveMeter(id, r);
                }
            }
        };

        window.managerApproveTask = async (id) => {
            if(!confirm("Manager Approve this task?")) return;
            const t = notifState.tasks.find(x => x.id === id) || projectTasksData[id];
            const pid = t ? t.projectId : currentProjId;
            if(!pid) return alert("Project ID not found.");
            
            await updateDoc(doc(db, `projects/${pid}/tasks/${id}`), { status: 'manager_approved' });
            alert("Manager Approved!");
            document.getElementById('taskApproveModal').classList.add('hidden');
        };

        window.adminApproveTask = async (id) => {
            if(!confirm("Admin Final Approve and Add to Expenses?")) return;
            const t = notifState.tasks.find(x => x.id === id) || projectTasksData[id];
            const pid = t ? t.projectId : currentProjId;
            if(!pid) return alert("Project ID not found.");

            const cost = parseFloat(prompt("Confirm Final Cost to add to expenses:", t.submittedCost || 0));
            if(isNaN(cost)) return;

            await updateDoc(doc(db, `projects/${pid}/tasks/${id}`), { status: 'approved', finalCost: cost });
            await addDoc(collection(db, `projects/${pid}/expenses`), {
                description: `Task: ${t.title}`,
                amount: cost,
                date: new Date().toLocaleDateString('en-CA'),
                createdAt: serverTimestamp()
            });
            await recordDailyTransaction(`Task Expense: ${t.title}`, cost, 'expense', currentProjName);
            
            alert("Admin Approved and Expense added!");
            document.getElementById('taskApproveModal').classList.add('hidden');
        };

        window.managerApproveMeter = async (id) => {
            if(!confirm("Manager Approve this meter reading?")) return;
            await updateDoc(doc(db, "meter_readings", id), { status: 'manager_approved' });
            alert("Manager Approved!");
            document.getElementById('taskApproveModal').classList.add('hidden');
        };

        window.adminApproveMeter = async (id, rData) => {
            if(!confirm("Admin Final Approve and add to transactions?")) return;
            await updateDoc(doc(db, "meter_readings", id), { status: 'approved' });
            await recordDailyTransaction(`Meter Reading: ${rData.vehicleNo}`, rData.totalCost || 0, 'expense', 'General');
            alert("Admin Approved and Transaction added!");
            document.getElementById('taskApproveModal').classList.add('hidden');
        };

        window.openEditBlockModal = () => {
             document.getElementById('editBlockId').value = selectedBlockId;
             document.getElementById('editBName').value = selectedBlockData.name;
             document.getElementById('editBSize').value = selectedBlockData.size;
             document.getElementById('editBPrice').value = selectedBlockData.price; 
             document.getElementById('editBlockModal').classList.remove('hidden');
        };

        window.saveBlockChanges = async () => {
             const id = document.getElementById('editBlockId').value;
             const name = document.getElementById('editBName').value;
             const size = document.getElementById('editBSize').value;
             const price = parseFloat(document.getElementById('editBPrice').value);

             await updateDoc(doc(db, `projects/${currentProjId}/blocks/${id}`), {
                 name, size, price
             });
             
             selectedBlockData.name = name;
             selectedBlockData.size = size;
             selectedBlockData.price = price;
             
             if(document.getElementById('sellBlockName')) document.getElementById('sellBlockName').innerText = name;
             if(document.getElementById('payBlockInfo')) document.getElementById('payBlockInfo').innerText = `${name} - ${selectedBlockData.customer?.name || ''}`;
             if(document.getElementById('finalPrice')) document.getElementById('finalPrice').value = price;

             document.getElementById('editBlockModal').classList.add('hidden');
             alert("Block Details Updated");
        };

        window.genReport = async (type) => { 
            const start = document.getElementById('repFrom').value; 
            const end = document.getElementById('repTo').value; 
            const container = document.getElementById('reportContent'); 
            if(!start || !end) return alert("Select Date Range first!"); 
            
            container.innerHTML = "<p class='text-center p-4'>Generating Report...</p>"; 
            let html = `<div style="text-align:center; margin-bottom:15px;"><img src="ico.jpeg" style="width: 80px; height: 80px; object-fit: cover; border-radius: 50%; display:inline-block; border: 2px solid #1e3a8a;"></div><h2 class="text-xl font-bold text-center mb-4 uppercase">${type.replace('_', ' ')} Report</h2> <p class="text-center text-xs mb-4 text-gray-500">From ${start} To ${end}</p>`; 
            
            try {
                if (type === 'daybook' || type === 'petty') { 
                    const snap = await getDocs(collection(db, "transactions")); 
                    let txs = [];
                    snap.forEach(d => {
                        const t = d.data();
                        if (t.date >= start && t.date <= end) {
                            if (type === 'petty' && t.category !== 'Petty Cash') return;
                            txs.push(t);
                        }
                    });
                    
                    txs.sort((a,b) => new Date(a.date) - new Date(b.date));
                    
                    let rows = "";
                    let bal = 0;
                    txs.forEach(t => {
                        if (t.type === 'Income') bal += t.amount; else bal -= t.amount;
                        rows += `<tr class="border-b hover:bg-gray-50">
                            <td class="p-2">${t.date}</td>
                            <td class="p-2">${t.description}</td>
                            <td class="p-2 text-right font-bold text-green-600">${t.type === 'Income' ? t.amount.toLocaleString() : '-'}</td>
                            <td class="p-2 text-right font-bold text-red-600">${t.type === 'Expense' ? t.amount.toLocaleString() : '-'}</td>
                            <td class="p-2 text-right font-bold bg-gray-50">${bal.toLocaleString()}</td>
                        </tr>`;
                    });
                    
                    html += `<table class="w-full text-xs text-left border rounded">
                        <thead class="bg-gray-100 font-bold uppercase"><tr><th class="p-2">Date</th><th class="p-2">Description</th><th class="p-2 text-right">Income</th><th class="p-2 text-right">Expense</th><th class="p-2 text-right">Balance</th></tr></thead>
                        <tbody>${rows}</tbody>
                    </table>`;
                    
                } else if (type === 'pnl') {
                    const snap = await getDocs(collection(db, "transactions"));
                    let inc = {}, exp = {};
                    let totInc = 0, totExp = 0;
                    
                    snap.forEach(d => {
                        const t = d.data();
                        if (t.date >= start && t.date <= end) {
                            if (t.type === 'Income') {
                                inc[t.category] = (inc[t.category] || 0) + t.amount;
                                totInc += t.amount;
                            } else {
                                exp[t.category] = (exp[t.category] || 0) + t.amount;
                                totExp += t.amount;
                            }
                        }
                    });
                    
                    let incRows = Object.keys(inc).map(k => `<tr><td class="p-2">${k}</td><td class="p-2 text-right">${inc[k].toLocaleString()}</td></tr>`).join('');
                    let expRows = Object.keys(exp).map(k => `<tr><td class="p-2">${k}</td><td class="p-2 text-right">${exp[k].toLocaleString()}</td></tr>`).join('');
                    
                    html += `<div class="grid grid-cols-2 gap-4 text-xs">
                        <div class="border rounded p-2">
                            <h3 class="font-bold bg-green-100 p-1 mb-2 text-green-800">INCOME</h3>
                            <table class="w-full">${incRows}</table>
                            <div class="border-t mt-2 pt-1 font-bold text-right text-lg text-green-700">Total: ${totInc.toLocaleString()}</div>
                        </div>
                        <div class="border rounded p-2">
                            <h3 class="font-bold bg-red-100 p-1 mb-2 text-red-800">EXPENSES</h3>
                            <table class="w-full">${expRows}</table>
                            <div class="border-t mt-2 pt-1 font-bold text-right text-lg text-red-700">Total: ${totExp.toLocaleString()}</div>
                        </div>
                    </div>
                    <div class="mt-4 text-center font-bold text-2xl border p-4 rounded bg-slate-50">
                        NET PROFIT: <span class="${(totInc-totExp)>=0 ? 'text-green-600' : 'text-red-600'}">Rs. ${(totInc-totExp).toLocaleString()}</span>
                    </div>`;
                    
                } else if (type === 'bs') {
                    const snap = await getDocs(collection(db, "bs_items"));
                    let assets = {fixed: [], current: []};
                    let equity = [];
                    let liabilities = [];
                    
                    snap.forEach(d => {
                        const i = d.data();
                        if (i.date <= end) { 
                            if (i.type === 'Non-Current Asset') assets.fixed.push(i);
                            else if (i.type === 'Current Asset') assets.current.push(i);
                            else if (i.type === 'Equity') equity.push(i);
                            else if (i.type === 'Current Liability') liabilities.push(i);
                        }
                    });
                    
                    const genSec = (items) => {
                        let tot = 0; 
                        let r = items.map(x => { tot+=x.amount; return `<tr><td>${x.name}</td><td class="text-right">${x.amount.toLocaleString()}</td></tr>`; }).join('');
                        return {html: r, total: tot};
                    };
                    
                    const fA = genSec(assets.fixed);
                    const cA = genSec(assets.current);
                    const eq = genSec(equity);
                    const li = genSec(liabilities);
                    
                    const txSnap = await getDocs(collection(db, "transactions"));
                    let cashBal = 0;
                    txSnap.forEach(d => {
                        const t = d.data();
                        if (t.date <= end) {
                            if (t.type === 'Income') cashBal += t.amount; else cashBal -= t.amount;
                        }
                    });
                    
                    cA.html += `<tr class="font-bold text-blue-600"><td>Cash / Bank Balance</td><td class="text-right">${cashBal.toLocaleString()}</td></tr>`;
                    cA.total += cashBal;
                    
                    const totAssets = fA.total + cA.total;
                    const totEqLiab = eq.total + li.total;
                    
                    html += `<div class="grid grid-cols-2 gap-6 text-xs">
                        <div>
                            <h3 class="font-bold text-lg border-b mb-2">ASSETS</h3>
                            <h4 class="font-bold text-gray-500 mt-2">Non-Current Assets</h4>
                            <table class="w-full mb-2">${fA.html}</table>
                            <h4 class="font-bold text-gray-500 mt-2">Current Assets</h4>
                            <table class="w-full mb-2">${cA.html}</table>
                            <div class="border-t-2 border-black mt-2 pt-1 font-bold text-right text-lg">Total Assets: ${totAssets.toLocaleString()}</div>
                        </div>
                        <div>
                            <h3 class="font-bold text-lg border-b mb-2">EQUITY & LIABILITIES</h3>
                            <h4 class="font-bold text-gray-500 mt-2">Equity</h4>
                            <table class="w-full mb-2">${eq.html}</table>
                            <h4 class="font-bold text-gray-500 mt-2">Current Liabilities</h4>
                            <table class="w-full mb-2">${li.html}</table>
                            <div class="border-t-2 border-black mt-2 pt-1 font-bold text-right text-lg">Total Equity & Liab: ${totEqLiab.toLocaleString()}</div>
                        </div>
                    </div>`;
                }
                
                container.innerHTML = html;
                document.getElementById('printContainer').innerHTML = `<div style="padding:20px; font-family:sans-serif;">${html}</div>`;
            } catch(e) {
                console.error(e);
                container.innerHTML = "<p class='text-center p-4 text-red-500'>Error loading report data. Check console for details.</p>";
            }
        };

        window.saveTransaction = async () => {
            const date = document.getElementById('txDate').value;
            const desc = document.getElementById('txDesc').value;
            const vno = document.getElementById('txVno').value;
            const type = document.getElementById('txType').value;
            const amount = parseFloat(document.getElementById('txAmount').value);
            const cat = document.getElementById('txCategory').value;
            const isPetty = document.getElementById('txIsPetty').checked;
            
            if (!date || !amount || !desc) return alert("Please fill all fields");
            
            try {
                await addDoc(collection(db, "transactions"), {
                    date,
                    description: vno ? `${desc} (V:${vno})` : desc,
                    amount,
                    type,
                    category: isPetty ? "Petty Cash" : cat,
                    timestamp: serverTimestamp()
                });
                alert("Transaction Saved!");
                document.getElementById('txAmount').value = "";
                document.getElementById('txDesc').value = "";
                document.getElementById('txVno').value = "";
            } catch (e) {
                console.error(e);
                alert("Error saving transaction");
            }
        };

        window.saveBSItem = async () => {
            const date = document.getElementById('bsDate').value;
            const name = document.getElementById('bsName').value;
            const type = document.getElementById('bsType').value;
            const amount = parseFloat(document.getElementById('bsAmount').value);
            
            if (!date || !amount || !name) return alert("Please fill all fields");
            
            try {
                await addDoc(collection(db, "bs_items"), {
                    date, name, type, amount, timestamp: serverTimestamp()
                });
                alert("Balance Sheet Item Saved!");
                document.getElementById('bsAmount').value = "";
                document.getElementById('bsName').value = "";
            } catch (e) {
                console.error(e);
                alert("Error saving item");
            }
        };

        async function initApp() { 
            console.log("App Initializing...");
            try {
                await signInAnonymously(auth);
                console.log("Authenticated anonymously");
                
                window.loadProjects(); 
                window.checkOverduePayments(); 
                window.loadStaff(); 
                window.loadLands(); 
                window.loadMeterReadings(); 
                window.initGlobalNotifications(); 
            } catch (error) {
                console.error("Initialization Failed:", error);
            }
        }
        window.initApp = initApp;

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initApp);
        } else {
            initApp();
        }

    </script>
</body>
</html>
