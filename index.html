<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mysterium Ultimate Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Cinzel:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #d4af37; --bg: #0b0c10; --text: #eaeaea; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; height: 100vh; display: flex; flex-direction: column; overflow: hidden; transition: background 0.5s ease; }
        
        /* THEMES */
        body.bg-midnight { background: linear-gradient(to bottom, #0f2027, #203a43, #2c5364); }
        body.bg-rain { background: radial-gradient(circle, #1a1c29 0%, #000000 100%); }
        body.bg-fire { background: linear-gradient(to bottom, #2c1e12, #1a0f00); }
        body.bg-zen { background: linear-gradient(to top, #134e5e, #71b280); }

        /* UI Utilities */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .glass-nav { background: rgba(10, 10, 10, 0.85); backdrop-filter: blur(16px); border-top: 1px solid rgba(255,255,255,0.08); }
        .glass-card { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }
        
        /* 3D Book & Reader */
        .book-3d { perspective: 1000px; transition: transform 0.2s; }
        .book-3d:active { transform: scale(0.95); }
        .book-scene { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; perspective: 1500px; overflow: hidden; }
        .book { transform-style: preserve-3d; position: relative; width: min(85vw, 45vh); height: min(120vw, 65vh); transition: transform 0.5s; }
        .page { position: absolute; inset:0; transform-origin: left; transition: transform 0.6s cubic-bezier(0.645, 0.045, 0.355, 1); transform-style: preserve-3d; background: white; border-radius: 2px 5px 5px 2px; backface-visibility: hidden; }
        .front, .back { position: absolute; inset:0; backface-visibility: hidden; background: white; overflow: hidden; }
        .back { transform: rotateY(180deg); background: #eee; }
        .flipped { transform: rotateY(-180deg); }
        
        /* Toast */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: #222; color: white; padding: 10px 20px; border-radius: 50px; opacity: 0; transition: 0.3s; pointer-events: none; z-index: 9999; display: flex; gap: 10px; border: 1px solid #333; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .nav-item.active { color: var(--primary); }
    </style>
</head>
<body class="bg-midnight">

    <div id="loading-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
        <i class="fas fa-dragon text-[#d4af37] text-4xl animate-pulse mb-4"></i>
        <p class="text-[#d4af37] text-xs font-mono tracking-widest">LOADING ARCHIVE...</p>
    </div>

    <div id="auth-section" class="hidden fixed inset-0 z-[900] bg-black/95 flex flex-col items-center justify-center p-6 bg-[url('https://images.unsplash.com/photo-1519681393784-d120267933ba')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/80"></div>
        <div class="relative z-10 w-full max-w-sm text-center">
            <h1 class="text-5xl font-[Cinzel] text-[#d4af37] mb-2 tracking-widest">MYSTERIUM</h1>
            <p class="text-gray-400 mb-8 text-sm">The Ultimate Digital Library</p>
            <button id="google-login" class="w-full bg-white text-black py-4 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition shadow-xl">
                <i class="fab fa-google text-red-600"></i> Enter Archive
            </button>
        </div>
    </div>

    <header id="main-header" class="hidden px-5 py-4 flex justify-between items-center bg-black/20 sticky top-0 z-40 backdrop-blur-md">
        <div class="flex items-center gap-2">
            <i class="fas fa-dragon text-[#d4af37] text-xl"></i>
            <span class="font-[Cinzel] font-bold text-lg text-white">MYSTERIUM</span>
        </div>
        <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-gray-600 cursor-pointer" onclick="handleLogout()">
    </header>

    <main id="app-container" class="hidden flex-grow overflow-y-auto pb-24 relative">
        
        <div id="view-home" class="p-4 space-y-6 fade-in">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                <input type="text" id="search-input" placeholder="Search ancient texts..." class="w-full bg-[#1a1a1a] rounded-xl py-3 pl-12 pr-4 text-sm text-white focus:border-[#d4af37] outline-none border border-gray-800 transition">
            </div>

            <div id="trending-section" class="hidden">
                <h2 class="text-sm font-bold mb-3 text-[#d4af37] uppercase tracking-wider">Trending Now</h2>
                <div id="trending-grid" class="flex gap-4 overflow-x-auto hide-scroll pb-2"></div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-3">
                    <h2 class="text-sm font-bold text-white uppercase tracking-wider">All Books</h2>
                    <button onclick="loadWall()" class="text-xs text-[#d4af37]"><i class="fas fa-sync-alt"></i></button>
                </div>
                <div id="books-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
                <div id="empty-state" class="hidden py-10 text-center text-gray-500">No books found.</div>
            </div>
        </div>

        <div id="view-library" class="hidden p-4 min-h-full">
            <h2 class="text-2xl font-[Cinzel] font-bold mb-6 text-white">My Collection</h2>
            <div id="library-grid" class="grid grid-cols-2 md:grid-cols-3 gap-4"></div>
        </div>

        <div id="view-studio" class="hidden p-4">
            <h2 class="text-2xl font-[Cinzel] font-bold mb-4 text-[#d4af37]">Creator Studio</h2>
            <div class="space-y-4 max-w-md mx-auto">
                <div class="glass-card p-4 rounded-xl">
                    <input id="new-book-title" type="text" placeholder="Book Title" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-sm text-white mb-3 outline-none focus:border-[#d4af37]">
                    <div class="flex gap-3">
                        <input id="new-book-price" type="number" placeholder="Price (LKR)" class="w-1/2 bg-black border border-gray-700 rounded-lg p-3 text-sm text-white outline-none focus:border-[#d4af37]">
                        <div class="w-1/2 flex items-center text-xs text-gray-500">0 = Free Book</div>
                    </div>
                </div>

                <div class="glass-card p-4 rounded-xl text-center">
                    <label class="block w-full py-6 border-2 border-dashed border-gray-700 rounded-lg cursor-pointer hover:border-[#d4af37] hover:bg-[#d4af37]/5 transition">
                        <i class="fas fa-file-pdf text-2xl text-gray-400 mb-2"></i>
                        <div class="text-xs text-gray-300">Tap to Upload PDF</div>
                        <input type="file" id="pdf-upload" class="hidden" accept="application/pdf" onchange="handlePdfUpload(this)">
                    </label>
                    <div id="pdf-status" class="text-xs text-[#d4af37] mt-2 hidden">Processing...</div>
                </div>

                <div class="glass-card p-4 rounded-xl">
                    <input id="bank-acc" type="text" placeholder="Your Bank Account No" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-sm text-white mb-2">
                    <input id="bank-holder" type="hidden" value="Author"><input id="bank-name" type="hidden" value="Bank"><input id="bank-branch" type="hidden" value="Branch">
                </div>

                <button onclick="openPublishModal()" class="w-full py-4 bg-gradient-to-r from-[#d4af37] to-[#b08d30] text-black font-bold rounded-xl shadow-lg active:scale-95 transition">
                    PUBLISH
                </button>
                
                <div class="mt-6 border-t border-gray-800 pt-4">
                     <h3 class="text-xs text-gray-500 uppercase mb-2">Manage Books</h3>
                     <div id="my-books-list" class="space-y-2"></div>
                </div>
            </div>
        </div>
    </main>

    <nav id="bottom-nav" class="hidden fixed bottom-0 w-full glass-nav z-50 pb-safe">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="showView('home')" class="nav-item active flex flex-col items-center gap-1 p-2 text-gray-500 transition"><i class="fas fa-compass text-xl"></i><span class="text-[10px]">Explore</span></button>
            <button onclick="showView('library')" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-500 transition"><i class="fas fa-book-open text-xl"></i><span class="text-[10px]">Library</span></button>
            <button onclick="createNewBook()" class="bg-[#d4af37] text-black w-12 h-12 rounded-full -mt-6 shadow-[0_0_15px_rgba(212,175,55,0.4)] flex items-center justify-center active:scale-90 transition"><i class="fas fa-feather-alt text-xl"></i></button>
            <button onclick="handleLogout()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-500 transition"><i class="fas fa-user text-xl"></i><span class="text-[10px]">Profile</span></button>
        </div>
    </nav>

    <div id="view-reader" class="hidden fixed inset-0 z-[1000] bg-black/95 flex flex-col">
        <div id="audio-overlay" class="absolute inset-0 z-[1100] bg-black/80 flex items-center justify-center backdrop-blur-sm">
            <button onclick="startImmersiveExperience()" class="bg-[#d4af37] text-black px-8 py-4 rounded-full font-bold animate-bounce">
                <i class="fas fa-play mr-2"></i> ENTER WORLD
            </button>
        </div>

        <div id="reader-top" class="absolute top-0 w-full p-4 flex justify-between items-center z-50">
            <button onclick="closeReader()" class="bg-black/40 backdrop-blur px-3 py-1 rounded-full text-[#d4af37] text-xs font-bold border border-white/10"><i class="fas fa-chevron-left mr-1"></i> BACK</button>
            <div class="flex gap-2">
                <button onclick="openReviewModal()" class="w-8 h-8 rounded-full bg-black/40 text-[#d4af37] border border-white/10 flex items-center justify-center"><i class="fas fa-star text-xs"></i></button>
                <button onclick="toggleMute()" id="mute-btn" class="w-8 h-8 rounded-full bg-black/40 text-white border border-white/10 flex items-center justify-center"><i class="fas fa-volume-up text-xs"></i></button>
                <button onclick="toggleBgMenu()" class="w-8 h-8 rounded-full bg-black/40 text-white border border-white/10 flex items-center justify-center animate-pulse"><i class="fas fa-swatchbook text-xs"></i></button>
            </div>
            <div id="bg-menu" class="hidden absolute top-14 right-4 bg-black/90 p-2 rounded border border-gray-700 grid grid-cols-2 gap-2">
                <button onclick="setTheme('midnight')" class="w-8 h-8 bg-[#2c5364] rounded"></button>
                <button onclick="setTheme('rain')" class="w-8 h-8 bg-[#1a1c29] rounded border border-blue-500"></button>
                <button onclick="setTheme('fire')" class="w-8 h-8 bg-[#2c1e12] rounded border border-orange-500"></button>
                <button onclick="setTheme('zen')" class="w-8 h-8 bg-[#71b280] rounded"></button>
            </div>
        </div>

        <div class="book-scene cursor-grab active:cursor-grabbing flex-grow" onclick="toggleControls()">
             <div id="panzoom-container">
                <div id="the-book" class="book"><div id="pages-wrapper"></div></div>
            </div>
        </div>

        <div id="reader-controls" class="absolute bottom-0 w-full p-6 bg-gradient-to-t from-black via-black/90 to-transparent z-50 transition-transform duration-300">
            <div class="flex items-center gap-3 text-[#d4af37] mb-2">
                <span class="text-xs font-bold">Pg</span>
                <input type="range" id="page-slider" min="1" max="100" value="1" class="flex-grow accent-[#d4af37] h-1 bg-gray-700 rounded-lg" onchange="jumpToPage(this.value)">
                <span id="slider-val" class="text-xs font-bold w-6 text-center">1</span>
            </div>
            <div class="flex justify-between">
                <button onclick="prevPage()" class="text-gray-400 p-2 text-xs">PREV</button>
                <button onclick="nextPage()" class="text-gray-400 p-2 text-xs">NEXT</button>
            </div>
        </div>
    </div>

    <div id="pay-modal" class="hidden fixed inset-0 z-[2000] bg-black/90 flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-[#151515] w-full md:max-w-sm rounded-t-2xl md:rounded-2xl p-6 border-t md:border border-[#d4af37] shadow-2xl">
            <div class="text-center mb-6">
                <i class="fas fa-lock text-3xl text-[#d4af37] mb-2"></i>
                <h3 class="text-xl font-[Cinzel] text-white" id="pay-title">UNLOCK BOOK</h3>
                <p class="text-[#d4af37] text-2xl font-bold mt-2" id="pay-price-display">Rs. 0</p>
            </div>
            <div class="bg-gray-900 p-4 rounded-xl mb-4 text-xs space-y-2 border border-gray-800">
                <div class="flex justify-between text-gray-400"><span>Bank:</span> <span id="pay-bank" class="text-white"></span></div>
                <div class="flex justify-between text-gray-400"><span>Acc:</span> <span id="pay-acc" class="text-[#d4af37] font-mono font-bold"></span></div>
            </div>
            <label class="block w-full bg-gray-800 py-3 rounded-lg text-xs text-center text-gray-300 mb-4 cursor-pointer border border-dashed border-gray-600">
                <i class="fas fa-camera mr-2"></i> Upload Receipt
                <input type="file" id="pay-receipt" class="hidden" accept="image/*" onchange="showToast('Receipt Selected!', 'success')">
            </label>
            <button id="pay-btn" class="w-full bg-[#d4af37] text-black font-bold py-3 rounded-xl mb-3">SUBMIT</button>
            <button onclick="document.getElementById('pay-modal').classList.add('hidden')" class="w-full text-xs text-gray-500">Cancel</button>
        </div>
    </div>

    <div id="review-modal" class="hidden fixed inset-0 z-[2000] bg-black/90 flex items-center justify-center p-4">
        <div class="w-full max-w-sm glass-card rounded-2xl p-6 text-center bg-[#111]">
            <h3 class="text-white font-[Cinzel] mb-4">RATE BOOK</h3>
            <div class="flex justify-center gap-3 mb-4">
                <i onclick="setRating(1)" class="fas fa-dragon text-2xl cursor-pointer text-gray-700 hover:text-[#d4af37]" id="star-1"></i>
                <i onclick="setRating(2)" class="fas fa-dragon text-2xl cursor-pointer text-gray-700 hover:text-[#d4af37]" id="star-2"></i>
                <i onclick="setRating(3)" class="fas fa-dragon text-2xl cursor-pointer text-gray-700 hover:text-[#d4af37]" id="star-3"></i>
                <i onclick="setRating(4)" class="fas fa-dragon text-2xl cursor-pointer text-gray-700 hover:text-[#d4af37]" id="star-4"></i>
                <i onclick="setRating(5)" class="fas fa-dragon text-2xl cursor-pointer text-gray-700 hover:text-[#d4af37]" id="star-5"></i>
            </div>
            <textarea id="review-text" class="w-full bg-black/50 border border-gray-700 rounded p-2 text-xs text-white mb-4" rows="3" placeholder="Write review..."></textarea>
            <button onclick="submitReview()" class="w-full bg-white text-black font-bold py-2 rounded-lg">POST</button>
            <button onclick="document.getElementById('review-modal').classList.add('hidden')" class="mt-4 text-xs text-gray-500">Close</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, limit, startAfter, addDoc, writeBatch, deleteDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyByyYMFzn1nHOuzxEsX44sQrIIT5AdB3Pc", authDomain: "book-8cd24.firebaseapp.com", projectId: "book-8cd24", storageBucket: "book-8cd24.firebasestorage.app", messagingSenderId: "747560284834", appId: "1:747560284834:web:30f6080e8d4fbf9025ddfb" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let currentUser = null;
        let libraryBooks = [];
        let myBookIds = [];
        let activeBookId = null;
        let studioPages = [], currentStudioPageIndex = 0, studioBookId = null;
        let panzoomInstance = null;
        let lastLoadedPageDoc = null;
        let isFetchingPages = false;
        let currentRating = 0;
        let pendingAction = null;

        // Audio System
        const audioState = { muted: false, currentAmbience: null, flip: new Audio('https://www.soundjay.com/books/sounds/book-page-turn-01.mp3'), initialized: false };
        const themes = {
            'midnight': { class: 'bg-midnight', sound: 'https://cdn.pixabay.com/download/audio/2022/07/04/audio_341e33d014.mp3' },
            'rain': { class: 'bg-rain', sound: 'https://cdn.pixabay.com/download/audio/2021/08/09/audio_05d15c8983.mp3' },
            'fire': { class: 'bg-fire', sound: 'https://cdn.pixabay.com/download/audio/2021/09/06/audio_04e7602e1c.mp3' },
            'zen': { class: 'bg-zen', sound: 'https://cdn.pixabay.com/download/audio/2022/02/16/audio_51474a58b2.mp3' }
        };
        let currentTheme = 'midnight';

        window.startImmersiveExperience = () => { document.getElementById('audio-overlay').classList.add('hidden'); audioState.initialized = true; playAmbience(themes[currentTheme].sound); };
        window.toggleMute = () => {
            audioState.muted = !audioState.muted;
            const btn = document.getElementById('mute-btn');
            if(audioState.muted) { if(audioState.currentAmbience) audioState.currentAmbience.pause(); btn.innerHTML = '<i class="fas fa-volume-mute text-red-500 text-xs"></i>'; } 
            else { if(audioState.initialized) playAmbience(themes[currentTheme].sound); btn.innerHTML = '<i class="fas fa-volume-up text-xs"></i>'; }
        };
        function playAmbience(url) {
            if(audioState.muted) return;
            if(audioState.currentAmbience) audioState.currentAmbience.pause();
            audioState.currentAmbience = new Audio(url); audioState.currentAmbience.loop = true; audioState.currentAmbience.volume = 0.5;
            audioState.currentAmbience.play().catch(e=>{});
        }
        window.setTheme = (themeName) => { document.body.className = `${themes[themeName].class}`; currentTheme = themeName; if(audioState.initialized) playAmbience(themes[themeName].sound); document.getElementById('bg-menu').classList.add('hidden'); };

        // Auth
        onAuthStateChanged(auth, async u => {
            if(u) {
                currentUser = u;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('user-avatar').src = u.photoURL;
                await loadWall();
                showView('home');
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
            }
        });
        document.getElementById('google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.handleLogout = () => { if(confirm("Disconnect?")) signOut(auth).then(()=>location.reload()); };

        // Navigation
        window.showView = (id) => {
            ['home','library','studio','reader'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            if(id === 'reader') {
                document.getElementById('main-header').classList.add('hidden'); document.getElementById('bottom-nav').classList.add('hidden');
                document.getElementById('view-reader').classList.remove('hidden'); document.getElementById('view-reader').style.display = 'flex';
                document.getElementById('audio-overlay').classList.remove('hidden');
                const el = document.getElementById('panzoom-container'); if(panzoomInstance) panzoomInstance.destroy(); panzoomInstance = Panzoom(el, { maxScale: 4, minScale: 0.8 }); el.parentElement.addEventListener('wheel', panzoomInstance.zoomWithWheel);
            } else {
                if(audioState.currentAmbience) audioState.currentAmbience.pause();
                document.getElementById('main-header').classList.remove('hidden'); document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById(`view-${id}`).classList.remove('hidden');
                if(id === 'library') renderLibrary();
                if(id === 'studio') loadMyBooks();
            }
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`button[onclick="showView('${id}')"]`);
            if(activeBtn) activeBtn.classList.add('active');
        };

        // Data Loading
        async function loadWall() {
            document.getElementById('loading-screen').classList.remove('opacity-0', 'pointer-events-none');
            const q = query(collection(db, "books"), where("status", "==", "approved"));
            const snap = await getDocs(q);
            libraryBooks = [];
            snap.forEach(d => libraryBooks.push({id:d.id, ...d.data()}));
            libraryBooks.sort((a,b) => new Date(b.timestamp) - new Date(a.timestamp));
            
            if(currentUser) {
                const pSnap = await getDocs(collection(db, "users", currentUser.uid, "purchases"));
                myBookIds = pSnap.docs.map(d => d.data().bookId);
            }
            renderHome();
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        }

        function renderHome() {
            const grid = document.getElementById('books-grid');
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = libraryBooks.filter(b => b.title.toLowerCase().includes(term));
            
            grid.innerHTML = '';
            if(!filtered.length) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            filtered.forEach(b => {
                const isOwned = myBookIds.includes(b.id) || b.author === currentUser.uid;
                const isFree = !b.price || parseFloat(b.price) === 0;
                let badge = isOwned ? '<span class="bg-white text-black px-2 py-0.5 rounded text-[9px] font-bold"><i class="fas fa-check"></i> READ</span>' : (isFree ? '<span class="bg-green-500 text-black px-2 py-0.5 rounded text-[9px] font-bold">FREE</span>' : `<span class="bg-black/60 backdrop-blur text-[#d4af37] px-2 py-0.5 rounded text-[9px] border border-[#d4af37] font-bold">Rs.${b.price}</span>`);

                grid.innerHTML += `
                <div onclick="checkAndOpenBook('${b.id}')" class="book-3d relative aspect-[2/3] rounded-lg overflow-hidden shadow-lg border border-gray-800 cursor-pointer">
                    <img src="${b.coverUrl}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-90"></div>
                    <div class="absolute top-2 right-2">${badge}</div>
                    <div class="absolute bottom-3 left-3 right-3">
                        <h3 class="text-white font-bold text-xs truncate">${b.title}</h3>
                        <p class="text-[9px] text-gray-400"><i class="fas fa-eye"></i> ${b.clicks||0}</p>
                    </div>
                </div>`;
            });

            // Trending
            const trending = libraryBooks.filter(b => b.clicks > 0).sort((a,b)=>b.clicks-a.clicks).slice(0,5);
            const tGrid = document.getElementById('trending-grid'); tGrid.innerHTML = '';
            if(trending.length) {
                document.getElementById('trending-section').classList.remove('hidden');
                trending.forEach((b, i) => {
                    tGrid.innerHTML += `<div onclick="checkAndOpenBook('${b.id}')" class="min-w-[120px] relative aspect-[2/3] rounded-lg overflow-hidden border border-[#d4af37]/30 cursor-pointer"><div class="absolute top-0 left-0 bg-red-600 text-white text-[8px] font-bold px-1.5 py-0.5 z-10">#${i+1}</div><img src="${b.coverUrl}" class="w-full h-full object-cover"><div class="absolute bottom-0 w-full bg-black/60 text-white text-[9px] p-1 truncate">${b.title}</div></div>`;
                });
            }
        }
        document.getElementById('search-input').addEventListener('input', renderHome);

        function renderLibrary() {
            const grid = document.getElementById('library-grid'); grid.innerHTML = '';
            const myBooks = libraryBooks.filter(b => myBookIds.includes(b.id) || b.author === currentUser.uid);
            myBooks.forEach(b => {
                grid.innerHTML += `<div onclick="checkAndOpenBook('${b.id}')" class="relative aspect-[2/3] rounded-lg overflow-hidden cursor-pointer border border-gray-800"><img src="${b.coverUrl}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition"><div class="absolute inset-0 flex items-center justify-center"><i class="fas fa-book-reader text-3xl text-white drop-shadow-lg"></i></div></div>`;
            });
        }

        // Logic
        window.checkAndOpenBook = async (bookId) => {
            showToast("Verifying Access...", "info");
            try {
                await updateDoc(doc(db, "books", bookId), { clicks: increment(1) });
                const bSnap = await getDoc(doc(db, "books", bookId));
                if(!bSnap.exists()) return;
                const b = bSnap.data();
                
                const isAuthor = b.author === currentUser.uid;
                const pRef = doc(db, "users", currentUser.uid, "purchases", bookId);
                const pSnap = await getDoc(pRef);
                const isPurchased = pSnap.exists();
                const isFree = parseFloat(b.price) === 0;

                if(isFree && !isPurchased) {
                    await setDoc(pRef, { unlockedAt: new Date().toISOString(), bookId: bookId });
                    await updateDoc(doc(db, "books", bookId), { buyers: increment(1) });
                    myBookIds.push(bookId);
                }

                if (isAuthor || isPurchased || isFree) {
                    let savedPage = 1; if(isPurchased && pSnap.data().lastReadPage) savedPage = pSnap.data().lastReadPage;
                    await openReader(bookId, savedPage);
                } else {
                    openPayModal(bookId, b, 'buy_book');
                }
            } catch(e) { console.log(e); }
        };

        // Payment
        function openPayModal(id, data, type) {
            pendingAction = { id, data, type };
            document.getElementById('pay-title').innerText = type==='publish_fee' ? 'PUBLISH FEE' : (type==='replace'?'REPLACE CONTENT':'UNLOCK BOOK');
            let price = type==='publish_fee' ? 500 : (type==='replace'?0:data.price);
            document.getElementById('pay-price-display').innerText = `Rs. ${price}`;
            
            if(type === 'publish_fee') {
                document.getElementById('pay-bank').innerText = 'Commercial Bank';
                document.getElementById('pay-acc').innerText = '8025211913 (Kurunegala)';
            } else {
                document.getElementById('pay-bank').innerText = data.bankName || 'Unknown';
                document.getElementById('pay-acc').innerText = data.bankAcc || 'Contact Admin';
            }
            if(type==='replace') { document.getElementById('pay-receipt').classList.add('hidden'); document.getElementById('pay-btn').innerText = "UPDATE CONTENT"; }
            else { document.getElementById('pay-receipt').classList.remove('hidden'); document.getElementById('pay-btn').innerText = "SUBMIT"; }
            document.getElementById('pay-modal').classList.remove('hidden');
        }

        const compressImage = (file) => { return new Promise((resolve) => { const reader = new FileReader(); reader.readAsDataURL(file); reader.onload = (e) => { const img = new Image(); img.src = e.target.result; img.onload = () => { const c = document.createElement('canvas'); const s = 800 / img.width; c.width = 800; c.height = img.height * s; c.getContext('2d').drawImage(img, 0, 0, c.width, c.height); resolve(c.toDataURL('image/jpeg', 0.5)); }; }; }); };

        document.getElementById('pay-btn').onclick = async () => {
            const btn = document.getElementById('pay-btn'); btn.innerText = "Processing...";
            try {
                if(pendingAction.type === 'replace') {
                    const batch = writeBatch(db); const oldPages = await getDocs(collection(db, "books", pendingAction.id, "pages")); oldPages.forEach(doc => batch.delete(doc.ref));
                    studioPages.forEach(p => batch.set(doc(db,"books",pendingAction.id,"pages","p"+p.pageNumber), p));
                    batch.update(doc(db, "books", pendingAction.id), { title: document.getElementById('new-book-title').value, coverUrl: studioPages[0].imageUrl });
                    await batch.commit(); showToast("Content Replaced!", "success"); location.reload();
                } else {
                    const f = document.getElementById('pay-receipt').files[0]; if(!f) throw new Error("Receipt required"); const img = await compressImage(f);
                    const reqData = { type: pendingAction.type, email: currentUser.email, userId: currentUser.uid, receiptImage: img, status: "pending", timestamp: new Date().toISOString() };
                    
                    if(pendingAction.type === 'buy_book') {
                        reqData.bookId = pendingAction.id; reqData.amount = pendingAction.data.price; reqData.bookTitle = pendingAction.data.title; 
                        await addDoc(collection(db, "requests"), reqData); showToast("Receipt Sent!", "success");
                    } else if(pendingAction.type === 'publish_fee') {
                         const bookData = pendingAction.data;
                         await setDoc(doc(db, "books", pendingAction.id), { ...bookData, status: "pending_payment", coverUrl: studioPages[0].imageUrl, timestamp: new Date().toISOString(), author: currentUser.uid, buyers: 0, avgRating: 0, ratingCount: 0, clicks: 0 });
                         const batch = writeBatch(db); studioPages.forEach(p => batch.set(doc(db,"books",pendingAction.id,"pages","p"+p.pageNumber), p)); await batch.commit();
                         reqData.bookId = pendingAction.id; reqData.bookTitle = bookData.title; await addDoc(collection(db, "requests"), reqData); showToast("Book Submitted!", "success"); location.reload();
                    }
                }
                document.getElementById('pay-modal').classList.add('hidden');
            } catch(e) { showToast(e.message, "error"); }
            btn.innerText = "SUBMIT";
        };

        // Reader Engine
        async function openReader(bookId, startPage) {
            activeBookId = bookId; showView('reader');
            document.getElementById('pages-wrapper').innerHTML = '';
            document.getElementById('page-slider').value = startPage;
            document.getElementById('slider-val').innerText = startPage;
            await loadPageBatch(startPage, 5);
        }

        async function loadPageBatch(startNum, loadLimit) {
            const q = query(collection(db, "books", activeBookId, "pages"), where("pageNumber", ">=", parseInt(startNum)), orderBy("pageNumber"), limit(loadLimit));
            const snap = await getDocs(q);
            if(!snap.empty) { lastLoadedPageDoc = snap.docs[snap.docs.length-1]; renderBatch(snap.docs.map(d=>d.data())); }
        }

        function renderBatch(pages) {
            const wrap = document.getElementById('pages-wrapper');
            pages.forEach(p => {
                if(document.querySelector(`.page[data-pn="${p.pageNumber}"]`)) return;
                const el = document.createElement('div'); const z = 1000 - p.pageNumber; 
                el.className = `page shadow-2xl`; el.style.zIndex = z; el.dataset.pn = p.pageNumber;
                el.innerHTML = `<div class="front"><img src="${p.imageUrl}" style="width:100%; height:100%;"></div><div class="back"></div>`;
                el.onclick = (e) => {
                    e.stopPropagation();
                    if(el.classList.contains('flipped')) { if(!audioState.muted) audioState.flip.play(); el.classList.remove('flipped'); setTimeout(() => el.style.zIndex = z, 500); } 
                    else { if(!audioState.muted) audioState.flip.play(); el.classList.add('flipped'); setTimeout(() => el.style.zIndex = p.pageNumber, 600); loadMorePages(); }
                    const pageNum = parseInt(el.dataset.pn) + (el.classList.contains('flipped') ? 1 : 0);
                    saveProgress(pageNum); document.getElementById('page-slider').value = pageNum;
                };
                wrap.appendChild(el);
            });
        }
        async function loadMorePages() {
            if(isFetchingPages || !activeBookId || !lastLoadedPageDoc) return; isFetchingPages = true;
            const q = query(collection(db, "books", activeBookId, "pages"), orderBy("pageNumber"), startAfter(lastLoadedPageDoc), limit(1));
            const snap = await getDocs(q);
            if(!snap.empty) { lastLoadedPageDoc = snap.docs[snap.docs.length-1]; renderBatch(snap.docs.map(d=>d.data())); } isFetchingPages = false;
        }
        async function saveProgress(pageNum) { if(activeBookId && currentUser) try { await setDoc(doc(db, "users", currentUser.uid, "purchases", activeBookId), { lastReadPage: pageNum }, { merge: true }); } catch(e) {} }
        window.closeReader = () => { activeBookId = null; document.getElementById('pages-wrapper').innerHTML = ''; showView('home'); };
        window.toggleReaderDarkMode = () => document.getElementById('view-reader').classList.toggle('invert');
        window.toggleBgMenu = () => document.getElementById('bg-menu').classList.toggle('hidden');
        window.jumpToPage = async (val) => { document.getElementById('pages-wrapper').innerHTML = ''; document.getElementById('slider-val').innerText = val; await loadPageBatch(val, 5); };
        window.toggleControls = () => document.getElementById('reader-controls').classList.toggle('translate-y-full');

        // Studio
        window.createNewBook = () => { studioBookId = 'book_'+Date.now(); studioPages = []; showView('studio'); };
        window.handlePdfUpload = async (inp) => {
            const f = inp.files[0]; if(!f) return; document.getElementById('pdf-status').classList.remove('hidden');
            const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise; studioPages = [];
            for(let i=1; i<=pdf.numPages; i++){
                const p = await pdf.getPage(i); const vp = p.getViewport({scale:1.5}); const c = document.createElement('canvas'); c.width=vp.width; c.height=vp.height;
                await p.render({canvasContext:c.getContext('2d'), viewport:vp}).promise; studioPages.push({pageNumber:i, imageUrl:c.toDataURL('image/jpeg',0.8)});
            }
            document.getElementById('pdf-status').innerText = `Ready: ${studioPages.length} Pages`; showToast("PDF Ready!", "success");
        };
        window.openPublishModal = () => {
            const title = document.getElementById('new-book-title').value; const price = document.getElementById('new-book-price').value;
            if(!title || !studioPages.length) return showToast("Title & PDF required", "error");
            const bookData = { title, price, bankHolder: document.getElementById('bank-holder').value, bankName: document.getElementById('bank-name').value, bankAcc: document.getElementById('bank-acc').value, bankBranch: document.getElementById('bank-branch').value };
            openPayModal(studioBookId, bookData, 'publish_fee');
        };
        async function loadMyBooks() {
            const list = document.getElementById('my-books-list'); list.innerHTML = 'Loading...';
            const q = query(collection(db, "books"), where("author", "==", currentUser.uid)); const snap = await getDocs(q); list.innerHTML = '';
            snap.forEach(d => {
                const b = d.data(); const div = document.createElement('div');
                div.className = "bg-white/5 p-2 rounded flex justify-between items-center text-xs";
                div.innerHTML = `<span class="truncate w-32 text-gray-300">${b.title}</span> <button class="text-red-500 font-bold" onclick="handleDelete('${d.id}', '${b.title}', '${b.price}')">DEL</button>`;
                list.appendChild(div);
            });
        }
        window.handleDelete = async (id, title, price) => {
             const q = query(collection(db, "requests"), where("bookId", "==", id), where("type", "==", "buy_book"), where("status", "==", "approved")); const buyersSnap = await getDocs(q);
             if(!buyersSnap.empty) {
                 if(confirm("Paid readers exist! Replace content instead?")) {
                     studioBookId = id; document.getElementById('new-book-title').value = title; document.getElementById('new-book-price').value = price;
                     openPayModal(id, {title, price}, 'replace');
                 }
             } else { if(confirm("Delete permanently?")) { await deleteDoc(doc(db, "books", id)); loadMyBooks(); showToast("Deleted", "info"); } }
        };

        // Reviews
        window.openReviewModal = () => { document.getElementById('review-modal').classList.remove('hidden'); currentRating = 0; updateStars(); };
        window.setRating = (n) => { currentRating = n; updateStars(); };
        function updateStars() { for(let i=1; i<=5; i++) { const el = document.getElementById(`star-${i}`); el.style.color = i<=currentRating ? '#d4af37' : '#444'; } }
        window.submitReview = async () => {
             if(currentRating===0) return showToast("Rate First!", "error");
             try {
                await addDoc(collection(db, "books", activeBookId, "reviews"), { userId: currentUser.uid, rating: currentRating, text: document.getElementById('review-text').value, timestamp: new Date().toISOString() });
                await updateDoc(doc(db, "books", activeBookId), { avgRating: increment(0), ratingCount: increment(1) }); // Simplistic update
                showToast("Review Posted!", "success"); document.getElementById('review-modal').classList.add('hidden');
             } catch(e) { showToast("Error", "error"); }
        };

        // Toast Helper
        window.showToast = (msg, type) => {
            const t = document.createElement('div'); t.className = 'toast show';
            t.innerHTML = `<i class="fas fa-${type==='success'?'check':'info'}-circle text-${type==='success'?'green':'blue'}-400"></i> ${msg}`;
            document.body.appendChild(t); setTimeout(()=>t.remove(), 3000);
        };
    </script>
</body>
</html>
