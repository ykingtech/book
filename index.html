<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Mysterium App</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://unpkg.com/@panzoom/panzoom@4.5.1/dist/panzoom.min.js"></script>
    <script>pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';</script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    
    <style>
        :root { --primary: #FFD700; --bg: #0a0a0a; --surface: #1a1a1a; --text: #eaeaea; }
        body { background-color: var(--bg); color: var(--text); font-family: 'Outfit', sans-serif; -webkit-tap-highlight-color: transparent; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* Modern Scrollbar */
        .hide-scroll::-webkit-scrollbar { display: none; }
        .hide-scroll { -ms-overflow-style: none; scrollbar-width: none; }

        /* Glassmorphism */
        .glass { background: rgba(20, 20, 20, 0.85); backdrop-filter: blur(16px); -webkit-backdrop-filter: blur(16px); border-top: 1px solid rgba(255,255,255,0.08); }
        .card-glass { background: rgba(255,255,255,0.03); border: 1px solid rgba(255,255,255,0.05); backdrop-filter: blur(10px); }

        /* Toast Notification */
        .toast { position: fixed; bottom: 80px; left: 50%; transform: translateX(-50%) translateY(20px); background: #333; color: white; padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); opacity: 0; pointer-events: none; transition: all 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55); z-index: 10000; font-size: 14px; display: flex; items-center; gap: 10px; border: 1px solid #444; width: max-content; max-width: 90%; }
        .toast.show { opacity: 1; transform: translateX(-50%) translateY(0); }
        .toast.success i { color: #4ade80; } .toast.error i { color: #f87171; }

        /* Book 3D */
        .book-3d { transition: transform 0.3s; perspective: 1000px; }
        .book-3d:active { transform: scale(0.95); }
        
        /* Reader Flip */
        .book-scene { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; perspective: 1500px; overflow: hidden; }
        .book { transform-style: preserve-3d; position: relative; width: min(85vw, 45vh); height: min(120vw, 65vh); transition: transform 0.5s; }
        .page { position: absolute; inset:0; transform-origin: left; transition: transform 0.6s ease; transform-style: preserve-3d; background: white; border-radius: 2px 5px 5px 2px; }
        .front, .back { position: absolute; inset:0; backface-visibility: hidden; background: #fff; }
        .back { transform: rotateY(180deg); background: #eee; }
        .flipped { transform: rotateY(-180deg); }

        /* Animations */
        @keyframes float { 0% { transform: translateY(0px); } 50% { transform: translateY(-10px); } 100% { transform: translateY(0px); } }
        .animate-float { animation: float 4s ease-in-out infinite; }
        .nav-item.active { color: var(--primary); }
        .nav-item.active i { transform: scale(1.2); }
    </style>
</head>
<body>

    <div id="loading-screen" class="fixed inset-0 z-[9999] bg-black flex flex-col items-center justify-center transition-opacity duration-500">
        <div class="w-20 h-20 border-4 border-gray-800 border-t-yellow-500 rounded-full animate-spin mb-4"></div>
        <p class="text-yellow-500 text-sm font-bold tracking-widest animate-pulse">LOADING ARCHIVE</p>
    </div>

    <div id="auth-section" class="hidden fixed inset-0 z-[900] bg-black flex flex-col items-center justify-center p-6 bg-[url('https://images.unsplash.com/photo-1519681393784-d120267933ba')] bg-cover bg-center">
        <div class="absolute inset-0 bg-black/80"></div>
        <div class="relative z-10 w-full max-w-sm text-center">
            <h1 class="text-5xl font-['Playfair_Display'] text-yellow-500 mb-2">Mysterium</h1>
            <p class="text-gray-400 mb-10 text-sm">Your Digital Library Universe</p>
            <button id="google-login" class="w-full bg-white text-black py-4 rounded-xl font-bold flex items-center justify-center gap-3 active:scale-95 transition shadow-xl">
                <i class="fab fa-google text-red-500 text-lg"></i> Continue with Google
            </button>
        </div>
    </div>

    <header id="main-header" class="hidden px-4 py-3 flex justify-between items-center bg-[#0a0a0a] sticky top-0 z-40 border-b border-gray-800">
        <div class="flex items-center gap-2">
            <i class="fas fa-dragon text-yellow-500 text-2xl"></i>
            <span class="font-bold text-lg tracking-wide">Mysterium</span>
        </div>
        <div class="flex items-center gap-3">
            <div id="streak-badge" class="hidden text-xs font-bold text-yellow-500 bg-yellow-500/10 px-3 py-1 rounded-full border border-yellow-500/20">ðŸ”¥ 0</div>
            <img id="user-avatar" src="" class="w-8 h-8 rounded-full border border-gray-700 object-cover" onclick="handleLogout()">
        </div>
    </header>

    <main id="app-container" class="hidden flex-grow overflow-y-auto pb-24 relative">
        
        <div id="view-home" class="p-4 space-y-6 fade-in">
            <div class="relative">
                <i class="fas fa-search absolute left-4 top-3.5 text-gray-500"></i>
                <input type="text" id="search-input" placeholder="Search books, authors..." class="w-full bg-[#1a1a1a] rounded-xl py-3 pl-12 pr-4 text-sm text-white focus:ring-1 focus:ring-yellow-500 outline-none border border-gray-800 placeholder-gray-600 transition">
            </div>

            <div id="trending-section" class="hidden">
                <h2 class="text-lg font-bold mb-3 flex items-center gap-2 text-white">Trending Now <i class="fas fa-fire text-orange-500 text-xs"></i></h2>
                <div id="trending-list" class="flex gap-4 overflow-x-auto hide-scroll pb-2">
                    </div>
            </div>

            <div>
                <div class="flex justify-between items-end mb-3">
                    <h2 class="text-lg font-bold text-white">Discover</h2>
                    <button onclick="loadWall()" class="text-xs text-yellow-500"><i class="fas fa-sync-alt"></i> Refresh</button>
                </div>
                <div id="books-grid" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    </div>
                <div id="empty-state" class="hidden py-10 text-center text-gray-500">
                    <i class="fas fa-book-open text-3xl mb-2 opacity-30"></i>
                    <p class="text-sm">No books found.</p>
                </div>
            </div>
        </div>

        <div id="view-library" class="hidden p-4 min-h-full">
            <h2 class="text-2xl font-bold mb-6 text-white font-['Playfair_Display']">My Library</h2>
            <div id="library-grid" class="grid grid-cols-2 md:grid-cols-4 gap-4"></div>
            <div id="library-empty" class="hidden flex flex-col items-center justify-center h-64 text-gray-500">
                <i class="fas fa-layer-group text-4xl mb-3 opacity-30"></i>
                <p>You haven't unlocked any books yet.</p>
            </div>
        </div>

        <div id="view-studio" class="hidden p-4">
            <h2 class="text-2xl font-bold mb-4 text-yellow-500 font-['Playfair_Display']">Creator Studio</h2>
            
            <div class="space-y-4 max-w-md mx-auto">
                <div class="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800">
                    <label class="text-xs text-gray-400 uppercase font-bold block mb-2">1. Book Details</label>
                    <input id="new-book-title" type="text" placeholder="Enter Book Title" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-sm text-white mb-3 focus:border-yellow-500 outline-none">
                    <div class="flex gap-3">
                        <input id="new-book-price" type="number" placeholder="Price (LKR)" class="w-1/2 bg-black border border-gray-700 rounded-lg p-3 text-sm text-white focus:border-yellow-500 outline-none">
                        <div class="w-1/2 flex items-center text-xs text-gray-500">Leave 0 for Free</div>
                    </div>
                </div>

                <div class="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800">
                    <label class="text-xs text-gray-400 uppercase font-bold block mb-2">2. Content Source</label>
                    <div class="grid grid-cols-2 gap-3 mb-3">
                        <button onclick="setStudioMode('pdf')" id="btn-mode-pdf" class="py-2 rounded-lg text-sm font-bold bg-yellow-500 text-black">PDF Upload</button>
                        <button onclick="setStudioMode('text')" id="btn-mode-text" class="py-2 rounded-lg text-sm font-bold bg-gray-800 text-gray-400">Write Text</button>
                    </div>

                    <div id="studio-pdf-area">
                        <label class="block w-full py-8 border-2 border-dashed border-gray-700 rounded-lg text-center cursor-pointer hover:border-yellow-500 hover:bg-yellow-500/5 transition">
                            <i class="fas fa-file-pdf text-2xl text-gray-400 mb-2"></i>
                            <div class="text-xs text-gray-300">Tap to Select PDF</div>
                            <input type="file" id="pdf-upload" class="hidden" accept="application/pdf" onchange="handlePdfUpload(this)">
                        </label>
                        <div id="pdf-status" class="text-xs text-yellow-500 mt-2 text-center hidden">Processing...</div>
                    </div>

                    <div id="studio-text-area" class="hidden space-y-3">
                        <input type="file" id="cover-upload" class="text-xs text-gray-500" accept="image/*" onchange="handleCoverUpload(this)">
                        <textarea id="story-text" class="w-full h-32 bg-black border border-gray-700 rounded-lg p-3 text-xs text-white" placeholder="Once upon a time..."></textarea>
                        <button onclick="generatePagesFromText()" class="w-full py-2 bg-blue-900/30 text-blue-400 rounded-lg text-xs font-bold">Generate Pages</button>
                    </div>
                </div>

                <div class="bg-[#1a1a1a] p-4 rounded-xl border border-gray-800">
                    <label class="text-xs text-gray-400 uppercase font-bold block mb-2">3. Bank Info (For Earnings)</label>
                    <input id="bank-acc" type="text" placeholder="Account Number" class="w-full bg-black border border-gray-700 rounded-lg p-3 text-sm text-white mb-2">
                    <input id="bank-holder" type="hidden" value="User">
                    <input id="bank-name" type="hidden" value="Bank">
                    <input id="bank-branch" type="hidden" value="Branch">
                </div>

                <button onclick="openPublishModal()" class="w-full py-4 bg-gradient-to-r from-yellow-500 to-amber-600 text-black font-bold rounded-xl shadow-lg active:scale-95 transition">
                    PUBLISH BOOK
                </button>
            </div>
        </div>

    </main>

    <nav id="bottom-nav" class="hidden fixed bottom-0 w-full glass z-50 pb-safe">
        <div class="flex justify-around items-center h-16 px-2">
            <button onclick="showView('home')" class="nav-item active flex flex-col items-center gap-1 p-2 text-gray-500 transition duration-300">
                <i class="fas fa-home text-xl"></i>
                <span class="text-[10px] font-bold">Home</span>
            </button>
            <button onclick="showView('library')" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-500 transition duration-300">
                <i class="fas fa-book text-xl"></i>
                <span class="text-[10px] font-bold">Library</span>
            </button>
            <button onclick="createNewBook()" class="bg-yellow-500 text-black w-12 h-12 rounded-full -mt-6 shadow-[0_0_15px_rgba(255,215,0,0.5)] flex items-center justify-center active:scale-90 transition">
                <i class="fas fa-plus text-xl"></i>
            </button>
            <button onclick="alert('Search is at the top of Home!')" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-500 transition duration-300">
                <i class="fas fa-trophy text-xl"></i>
                <span class="text-[10px] font-bold">Top</span>
            </button>
             <button onclick="handleLogout()" class="nav-item flex flex-col items-center gap-1 p-2 text-gray-500 transition duration-300">
                <i class="fas fa-user text-xl"></i>
                <span class="text-[10px] font-bold">Profile</span>
            </button>
        </div>
    </nav>

    <div id="view-reader" class="hidden fixed inset-0 z-[1000] bg-black flex flex-col">
        <div class="flex justify-between items-center p-4 bg-black/80 backdrop-blur z-20">
            <button onclick="closeReader()" class="text-white bg-white/10 px-4 py-2 rounded-full text-xs font-bold"><i class="fas fa-chevron-down mr-2"></i>Close</button>
            <div class="text-xs font-mono text-gray-400">Page <span id="page-num-display" class="text-white font-bold">1</span></div>
            <button onclick="toggleMute()" id="mute-btn" class="text-white w-8 h-8 rounded-full bg-white/10 flex items-center justify-center"><i class="fas fa-volume-up"></i></button>
        </div>

        <div class="flex-grow book-scene overflow-hidden cursor-pointer" onclick="toggleControls()">
             <div id="panzoom-container">
                <div id="the-book" class="book">
                    <div id="pages-wrapper"></div>
                </div>
            </div>
        </div>

        <div id="reader-controls" class="p-6 bg-gradient-to-t from-black via-black/90 to-transparent z-20 transition-transform duration-300">
            <input type="range" id="page-slider" min="1" max="100" value="1" class="w-full accent-yellow-500 h-1 bg-gray-700 rounded-lg mb-4" onchange="jumpToPage(this.value)">
            <div class="flex justify-between items-center px-4">
                <button onclick="prevPage()" class="text-gray-400 hover:text-white p-2"><i class="fas fa-backward"></i> Prev</button>
                <div class="text-[10px] text-gray-500 uppercase tracking-widest">Tap sides to flip</div>
                <button onclick="nextPage()" class="text-gray-400 hover:text-white p-2">Next <i class="fas fa-forward"></i></button>
            </div>
        </div>
    </div>

    <div id="pay-modal" class="hidden fixed inset-0 z-[2000] bg-black/90 flex items-end md:items-center justify-center p-0 md:p-4">
        <div class="bg-[#151515] w-full md:max-w-sm rounded-t-2xl md:rounded-2xl p-6 border-t md:border border-gray-800 shadow-2xl animate-float-up">
            <div class="w-12 h-1 bg-gray-700 rounded-full mx-auto mb-6 md:hidden"></div>
            
            <div class="text-center mb-6">
                <i class="fas fa-lock text-3xl text-yellow-500 mb-2"></i>
                <h3 class="text-xl font-bold text-white">Unlock Book</h3>
                <p class="text-gray-400 text-xs">Lifetime access to this content</p>
            </div>

            <div class="flex justify-between items-center bg-gray-900 p-4 rounded-xl mb-4 border border-gray-800">
                <span class="text-gray-400 text-sm">Price</span>
                <span id="pay-price-display" class="text-xl font-bold text-white">Rs. 500</span>
            </div>

            <div class="text-xs text-gray-500 mb-2 uppercase font-bold">Payment Method</div>
            <div class="bg-gray-900 p-3 rounded-lg text-xs text-gray-300 mb-4 border border-gray-800">
                <div>Bank Transfer</div>
                <div class="font-mono text-yellow-500 mt-1 select-all" id="pay-acc-display">0000 0000 0000</div>
            </div>

            <label class="block w-full bg-gray-800 hover:bg-gray-700 text-center py-3 rounded-lg text-xs text-gray-300 mb-4 cursor-pointer transition border border-dashed border-gray-600">
                <i class="fas fa-camera mr-2"></i> Upload Receipt
                <input type="file" id="pay-receipt" class="hidden" accept="image/*" onchange="showToast('Receipt Selected!', 'success')">
            </label>

            <button id="pay-btn" class="w-full bg-yellow-500 text-black font-bold py-4 rounded-xl mb-3">CONFIRM PAYMENT</button>
            <button onclick="document.getElementById('pay-modal').classList.add('hidden')" class="w-full text-xs text-gray-500 py-2">Cancel</button>
        </div>
    </div>

    <div id="toast-container"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-app.js";
        import { getAuth, signInWithPopup, GoogleAuthProvider, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, collection, getDocs, query, where, orderBy, limit, startAfter, addDoc, updateDoc, increment } from "https://www.gstatic.com/firebasejs/12.7.0/firebase-firestore.js";

        const firebaseConfig = { apiKey: "AIzaSyByyYMFzn1nHOuzxEsX44sQrIIT5AdB3Pc", authDomain: "book-8cd24.firebaseapp.com", projectId: "book-8cd24", storageBucket: "book-8cd24.firebasestorage.app", messagingSenderId: "747560284834", appId: "1:747560284834:web:30f6080e8d4fbf9025ddfb" };
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // State
        let currentUser = null;
        let libraryBooks = [];
        let myBookIds = [];
        let activeBookId = null;
        let studioPages = [];
        let studioMode = 'pdf';
        
        // Audio
        const sounds = { flip: new Audio('https://www.soundjay.com/books/sounds/book-page-turn-01.mp3') };
        let isMuted = false;

        // Init
        onAuthStateChanged(auth, async u => {
            if(u) {
                currentUser = u;
                document.getElementById('auth-section').classList.add('hidden');
                document.getElementById('main-header').classList.remove('hidden');
                document.getElementById('app-container').classList.remove('hidden');
                document.getElementById('bottom-nav').classList.remove('hidden');
                document.getElementById('user-avatar').src = u.photoURL;
                
                checkStreak(u.uid);
                await loadData();
            } else {
                document.getElementById('auth-section').classList.remove('hidden');
                document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
            }
        });

        document.getElementById('google-login').onclick = () => signInWithPopup(auth, new GoogleAuthProvider());
        window.handleLogout = () => { if(confirm('Log out?')) signOut(auth).then(()=>location.reload()); };

        // Helper: Toast
        window.showToast = (msg, type='neutral') => {
            const t = document.createElement('div');
            t.className = `toast ${type}`;
            t.innerHTML = `<i class="fas fa-${type==='success'?'check-circle':(type==='error'?'exclamation-circle':'info-circle')}"></i> <span>${msg}</span>`;
            document.body.appendChild(t);
            setTimeout(()=>t.classList.add('show'), 10);
            setTimeout(()=>{ t.classList.remove('show'); setTimeout(()=>t.remove(), 300); }, 3000);
        };

        // Navigation
        window.showView = (id) => {
            ['home','library','studio'].forEach(v => document.getElementById(`view-${v}`).classList.add('hidden'));
            document.getElementById(`view-${id}`).classList.remove('hidden');
            // Update nav active state
            document.querySelectorAll('.nav-item').forEach(b => b.classList.remove('active'));
            const activeBtn = document.querySelector(`button[onclick="showView('${id}')"]`);
            if(activeBtn) activeBtn.classList.add('active');
            if(id === 'library') renderLibrary();
        };

        async function checkStreak(uid) {
            const ref = doc(db, "users", uid);
            const snap = await getDoc(ref);
            const today = new Date().toDateString();
            let streak = 1;
            
            if(snap.exists()) {
                const d = snap.data();
                if(d.lastLoginStr === today) streak = d.streak;
                else {
                    const yesterday = new Date(); yesterday.setDate(yesterday.getDate()-1);
                    if(d.lastLoginStr === yesterday.toDateString()) streak = (d.streak || 0) + 1;
                }
            }
            await setDoc(ref, { lastLoginStr: today, streak }, { merge: true });
            const badge = document.getElementById('streak-badge');
            badge.innerText = `ðŸ”¥ ${streak}`;
            badge.classList.remove('hidden');
        }

        async function loadData() {
            document.getElementById('loading-screen').classList.remove('opacity-0', 'pointer-events-none');
            const q = query(collection(db, "books"), where("status", "==", "approved"));
            const snap = await getDocs(q);
            libraryBooks = [];
            snap.forEach(d => libraryBooks.push({id:d.id, ...d.data()}));
            
            // Get My Purchases
            const pSnap = await getDocs(collection(db, "users", currentUser.uid, "purchases"));
            myBookIds = pSnap.docs.map(d => d.data().bookId);

            renderHome();
            document.getElementById('loading-screen').classList.add('opacity-0', 'pointer-events-none');
        }

        function renderHome() {
            const grid = document.getElementById('books-grid');
            const term = document.getElementById('search-input').value.toLowerCase();
            const filtered = libraryBooks.filter(b => b.title.toLowerCase().includes(term));
            
            grid.innerHTML = '';
            if(!filtered.length) document.getElementById('empty-state').classList.remove('hidden');
            else document.getElementById('empty-state').classList.add('hidden');

            filtered.forEach(b => {
                const isOwned = myBookIds.includes(b.id) || b.author === currentUser.uid;
                const isFree = !b.price || parseFloat(b.price) === 0;
                
                // Smart Button Logic
                let actionBtn = `<div class="absolute bottom-2 right-2 bg-black/80 backdrop-blur text-yellow-500 text-[10px] font-bold px-3 py-1.5 rounded-full border border-yellow-500/30">Rs. ${b.price}</div>`;
                if(isFree) actionBtn = `<div class="absolute bottom-2 right-2 bg-green-500 text-black text-[10px] font-bold px-3 py-1.5 rounded-full">FREE</div>`;
                if(isOwned) actionBtn = `<button class="absolute bottom-2 right-2 bg-white text-black text-[10px] font-bold px-4 py-1.5 rounded-full shadow-lg hover:bg-gray-200 transition">READ</button>`;

                grid.innerHTML += `
                <div onclick="handleBookClick('${b.id}')" class="relative aspect-[2/3] rounded-xl overflow-hidden shadow-lg border border-gray-800 group cursor-pointer book-3d">
                    <img src="${b.coverUrl}" class="w-full h-full object-cover">
                    <div class="absolute inset-0 bg-gradient-to-t from-black via-transparent to-transparent opacity-80"></div>
                    <div class="absolute bottom-10 left-3 right-3">
                        <h3 class="text-white font-bold text-sm truncate shadow-black drop-shadow-md">${b.title}</h3>
                        <p class="text-[10px] text-gray-400"><i class="fas fa-eye"></i> ${b.clicks||0}</p>
                    </div>
                    ${actionBtn}
                </div>`;
            });

            // Trending
            const trending = libraryBooks.filter(b => b.clicks > 0).sort((a,b)=>b.clicks-a.clicks).slice(0,5);
            if(trending.length) {
                document.getElementById('trending-section').classList.remove('hidden');
                const tList = document.getElementById('trending-list'); tList.innerHTML = '';
                trending.forEach(b => {
                    tList.innerHTML += `<div onclick="handleBookClick('${b.id}')" class="min-w-[120px] h-[180px] rounded-lg overflow-hidden relative cursor-pointer border border-gray-700"><img src="${b.coverUrl}" class="w-full h-full object-cover"><div class="absolute bottom-0 w-full bg-black/60 text-white text-[10px] p-1 text-center truncate">${b.title}</div></div>`;
                });
            }
        }
        document.getElementById('search-input').addEventListener('input', renderHome);

        function renderLibrary() {
            const grid = document.getElementById('library-grid');
            grid.innerHTML = '';
            const myBooks = libraryBooks.filter(b => myBookIds.includes(b.id) || b.author === currentUser.uid);
            
            if(!myBooks.length) document.getElementById('library-empty').classList.remove('hidden');
            else {
                document.getElementById('library-empty').classList.add('hidden');
                myBooks.forEach(b => {
                    grid.innerHTML += `
                    <div onclick="handleBookClick('${b.id}')" class="relative aspect-[2/3] rounded-xl overflow-hidden shadow-lg border border-gray-800 cursor-pointer">
                        <img src="${b.coverUrl}" class="w-full h-full object-cover opacity-80 hover:opacity-100 transition">
                         <div class="absolute inset-0 flex items-center justify-center">
                            <i class="fas fa-play-circle text-4xl text-white/50 hover:text-white transition drop-shadow-lg"></i>
                        </div>
                        <div class="absolute bottom-0 w-full bg-black/80 text-white text-xs p-2 text-center truncate">${b.title}</div>
                    </div>`;
                });
            }
        }

        // Logic
        window.handleBookClick = async (id) => {
            const b = libraryBooks.find(x => x.id === id);
            const isOwned = myBookIds.includes(id) || b.author === currentUser.uid;
            const isFree = !b.price || parseFloat(b.price) === 0;

            // Increment View
            updateDoc(doc(db, "books", id), { clicks: increment(1) });

            if(isOwned) {
                openReader(id);
            } else if(isFree) {
                showToast("Adding Free Book...", "success");
                await setDoc(doc(db, "users", currentUser.uid, "purchases", id), { unlockedAt: new Date().toISOString(), bookId: id });
                myBookIds.push(id);
                openReader(id);
            } else {
                openPayment(id, b);
            }
        };

        // Payment
        let pendingPay = null;
        function openPayment(id, book) {
            pendingPay = { id, price: book.price, title: book.title };
            document.getElementById('pay-price-display').innerText = `Rs. ${book.price}`;
            document.getElementById('pay-acc-display').innerText = book.bankAcc || 'Contact Admin';
            document.getElementById('pay-modal').classList.remove('hidden');
        }

        document.getElementById('pay-btn').onclick = async () => {
            const btn = document.getElementById('pay-btn'); btn.innerText = "Processing...";
            try {
                const file = document.getElementById('pay-receipt').files[0];
                if(!file) throw new Error("Please upload receipt");
                
                // Compress & Upload logic sim (Data URL)
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async (e) => {
                    const img = e.target.result;
                    await addDoc(collection(db, "requests"), {
                        type: 'buy_book', userId: currentUser.uid, email: currentUser.email,
                        bookId: pendingPay.id, amount: pendingPay.price, bookTitle: pendingPay.title,
                        receiptImage: img, status: 'pending', timestamp: new Date().toISOString()
                    });
                    showToast("Receipt Sent! Wait for approval.", "success");
                    document.getElementById('pay-modal').classList.add('hidden');
                    btn.innerText = "CONFIRM PAYMENT";
                };
            } catch(e) { showToast(e.message, "error"); btn.innerText = "CONFIRM PAYMENT"; }
        };

        // Reader
        let currentPage = 1;
        async function openReader(id) {
            activeBookId = id;
            document.getElementById('view-reader').classList.remove('hidden');
            document.getElementById('pages-wrapper').innerHTML = '<div class="text-white text-center mt-20">Loading Pages...</div>';
            
            // Panzoom
            const el = document.getElementById('panzoom-container');
            Panzoom(el, { maxScale: 4, minScale: 0.8, contain: 'outside' });

            // Load Pages
            const q = query(collection(db, "books", id, "pages"), orderBy("pageNumber"));
            const snap = await getDocs(q);
            const pages = snap.docs.map(d => d.data());
            
            const wrap = document.getElementById('pages-wrapper');
            wrap.innerHTML = '';
            pages.forEach(p => {
                const div = document.createElement('div');
                div.className = `page z-[${1000-p.pageNumber}]`;
                div.style.zIndex = 1000 - p.pageNumber;
                div.innerHTML = `<div class="front"><img src="${p.imageUrl}" class="w-full h-full object-fill"></div><div class="back"></div>`;
                div.onclick = () => flipPage(div, p.pageNumber);
                wrap.appendChild(div);
            });
            document.getElementById('page-slider').max = pages.length;
        }

        function flipPage(el, num) {
            if(!isMuted) sounds.flip.play();
            if(el.classList.contains('flipped')) {
                el.classList.remove('flipped');
                setTimeout(()=> el.style.zIndex = 1000 - num, 300);
                currentPage = num;
            } else {
                el.classList.add('flipped');
                setTimeout(()=> el.style.zIndex = num, 300);
                currentPage = num + 1;
            }
            document.getElementById('page-num-display').innerText = currentPage;
            document.getElementById('page-slider').value = currentPage;
        }

        window.closeReader = () => { document.getElementById('view-reader').classList.add('hidden'); activeBookId=null; };
        window.toggleMute = () => { isMuted = !isMuted; document.getElementById('mute-btn').innerHTML = isMuted ? '<i class="fas fa-volume-mute"></i>' : '<i class="fas fa-volume-up"></i>'; };
        window.jumpToPage = (n) => { /* Simple slider logic to flip pages automatically would go here */ };
        window.toggleControls = () => document.getElementById('reader-controls').classList.toggle('translate-y-full');

        // Studio Logic (Simplified)
        window.createNewBook = () => showView('studio');
        window.setStudioMode = (m) => {
            studioMode = m;
            document.getElementById('studio-pdf-area').classList.toggle('hidden', m !== 'pdf');
            document.getElementById('studio-text-area').classList.toggle('hidden', m !== 'text');
            // Update button styles
            document.getElementById('btn-mode-pdf').className = m==='pdf' ? 'py-2 rounded-lg text-sm font-bold bg-yellow-500 text-black' : 'py-2 rounded-lg text-sm font-bold bg-gray-800 text-gray-400';
            document.getElementById('btn-mode-text').className = m==='text' ? 'py-2 rounded-lg text-sm font-bold bg-yellow-500 text-black' : 'py-2 rounded-lg text-sm font-bold bg-gray-800 text-gray-400';
        };

        window.handlePdfUpload = async (inp) => {
            const f = inp.files[0]; if(!f) return;
            document.getElementById('pdf-status').classList.remove('hidden');
            try {
                const pdf = await pdfjsLib.getDocument(await f.arrayBuffer()).promise;
                studioPages = [];
                for(let i=1; i<=pdf.numPages; i++) {
                    const p = await pdf.getPage(i); const vp = p.getViewport({scale:1.5});
                    const c = document.createElement('canvas'); c.width=vp.width; c.height=vp.height;
                    await p.render({canvasContext:c.getContext('2d'), viewport:vp}).promise;
                    studioPages.push({pageNumber:i, imageUrl:c.toDataURL('image/jpeg',0.7)});
                }
                document.getElementById('pdf-status').innerText = `Ready! ${studioPages.length} Pages`;
                showToast("PDF Processed!", "success");
            } catch(e) { showToast("PDF Error", "error"); }
        };

        window.openPublishModal = () => {
            const title = document.getElementById('new-book-title').value;
            const price = document.getElementById('new-book-price').value || "0";
            if(!title || !studioPages.length) return showToast("Title & Content missing", "error");
            
            // Auto Publish (In real app, trigger payment logic)
            openPayment('new_'+Date.now(), { price, title, bankAcc: document.getElementById('bank-acc').value });
            // Here we hack the payment modal to act as "Submit for Review"
            document.getElementById('pay-btn').onclick = async () => {
                const bookId = 'book_'+Date.now();
                await setDoc(doc(db, "books", bookId), {
                    title, price, status: 'pending_payment', author: currentUser.uid, 
                    coverUrl: studioPages[0].imageUrl, timestamp: new Date().toISOString(), clicks:0
                });
                const batch = createBatch(db); // Pseudo code, need writeBatch import
                // Upload pages...
                showToast("Submitted for Approval!", "success");
                location.reload();
            };
        };
    </script>
</body>
</html>
